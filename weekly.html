<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æ¥­ç¸¾è¨ˆç®—ç³»çµ± (å¸³è™Ÿæ¨™æº–åŒ–ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f6; margin: 0; padding: 20px; }
        h1, h2, h3 { color: #333; text-align: center; }
        
        /* --- ç‰ˆé¢é…ç½® --- */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto 20px auto;
        }
        .mode-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .mode-local { background-color: #e2e3e5; color: #383d41; }
        .mode-cloud { background-color: #d4edda; color: #155724; }

        .settings-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        .settings-btn:hover { transform: rotate(45deg); transition: 0.3s; }

        /* --- è¼¸å…¥å€å¡Š --- */
        .input-section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto 30px auto; position: relative; }
        .status-indicator { position: absolute; top: 20px; right: 20px; font-size: 12px; color: #28a745; display: none; }
        textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; line-height: 1.5; font-family: inherit; }
        input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        
        /* --- æŒ‰éˆ• --- */
        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s; color: white;}
        .btn-calc { background-color: #007bff; flex: 2; }
        .btn-calc:hover { background-color: #0056b3; }
        .btn-clear { background-color: #dc3545; flex: 1; }
        .btn-clear:hover { background-color: #a71d2a; }
        .btn-action { background-color: #17a2b8; }
        .btn-ai { background-color: #f39c12; }
        .btn-save { background-color: #28a745; width: 100%; margin-top: 10px; }
        .btn-copy-bill {
            background-color: #6610f2;
            width: 100%;
            margin-top: 10px;
            font-size: 14px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-copy-bill:hover { background-color: #520dc2; }

        /* --- AI èˆ‡ æ—¥æœŸ --- */
        .ocr-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; display: flex; flex-direction: column; gap: 10px; }
        .date-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        #analysisDate { padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 150px; }
        #analysisStatus { margin-top: 5px; font-size: 0.9em; color: #333; min-height: 1.2em; }

        /* --- å ±è¡¨èˆ‡å¸³æˆ¶åˆ—è¡¨ --- */
        .report-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .person-card { background: white; border: 1px solid #ddd; width: 350px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .card-header { background-color: #ffcc00; padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; text-align: center; font-size: 18px; }
        .card-body { padding: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .col-day { background-color: #fff8e1; width: 40px; font-weight: bold; }
        .col-data { background-color: #f8f8ff; text-align: left; padding-left: 15px; }
        .col-subtotal { background-color: #f0f0ff; width: 50px; }
        .total-cell { background-color: #c0392b; color: white; font-weight: bold; text-align: center; font-size: 18px; }
        
        .summary-section { max-width: 300px; margin: 40px auto; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .summary-table th { background-color: #fff8e1; }
        .summary-table td { background-color: #f5f5f5; }
        .summary-total-row td { background-color: #e0e0e0; font-weight: bold; color: #c0392b; }

        /* --- å¸³æˆ¶æ¸…å–®æ¨£å¼ --- */
        .account-reference-container { display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; gap: 20px; }
        .bank-category { padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .bank-category h3 { color: #17a2b8; border-bottom: 2px solid #17a2b8; padding-bottom: 5px; margin-top: 0; text-align: left; }
        .account-table th { background-color: #e0f7fa; font-weight: bold; }

        /* --- è¨­å®šè¦–çª— (Modal) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .hint { font-size: 0.85em; color: #666; margin-top: 3px; }

        /* --- è¡çªè§£æ±ºè¦–çª— --- */
        .conflict-item { border: 1px solid #ffc107; background: #fff3cd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .conflict-options { display: flex; gap: 5px; margin-top: 5px; }
        .conflict-options button { padding: 5px 10px; font-size: 14px; flex: 1; }

        /* --- Toast é€šçŸ¥ --- */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="header-bar">
        <span id="systemModeBadge" class="mode-badge mode-local">ğŸ“¡ å–®æ©Ÿæ¨¡å¼ (è³‡æ–™å­˜åœ¨æœ¬åœ°)</span>
        <button class="settings-btn" id="openSettingsBtn" title="ç³»çµ±è¨­å®š">âš™ï¸</button>
    </div>

    <h1>ğŸ“Š æ¥­ç¸¾è¨ˆç®—ç³»çµ± (å¸³è™Ÿæ¨™æº–åŒ–ç‰ˆ)</h1>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
            <p>è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„é‡‘é‘°ä»¥å•Ÿç”¨é›²ç«¯åŠŸèƒ½ã€‚è‹¥ç•™ç©ºï¼Œç³»çµ±å°‡ä»¥ã€Œå–®æ©Ÿæ¨¡å¼ã€é‹ä½œã€‚</p>
            
            <div class="form-group">
                <label>Gemini API Key (ç”¨æ–¼åœ–ç‰‡è­˜åˆ¥)</label>
                <input type="password" id="cfgApiKey" placeholder="è²¼ä¸Šæ‚¨çš„ API Key">
                <div class="hint">ç”³è«‹ç¶²å€: https://aistudio.google.com/</div>
            </div>

            <div class="form-group">
                <label>Firebase Config (ç”¨æ–¼é›²ç«¯åŒæ­¥)</label>
                <textarea id="cfgFirebase" rows="6" placeholder='{"apiKey": "...", "authDomain": "...", ...}'></textarea>
                <div class="hint">è«‹ç›´æ¥è²¼ä¸Š Firebase Console æä¾›çš„å®Œæ•´ JSON Config</div>
            </div>

            <button class="btn-save" id="saveSettingsBtn">ğŸ’¾ å„²å­˜ä¸¦é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

    <div id="conflictModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #d39e00;">âš ï¸ ç™¼ç¾å¸³æˆ¶åç¨±é‡è¤‡</h2>
            <p>ç³»çµ±æª¢æ¸¬åˆ°ä»¥ä¸‹åç¨±æœ‰é‡è¤‡è³‡æ–™ï¼Œè«‹é¸æ“‡æ‚¨è¦ä¿ç•™çš„è³‡æ–™ï¼š</p>
            <div id="conflictList"></div>
            <button class="btn-clear" onclick="document.getElementById('conflictModal').style.display='none'" style="margin-top:20px; background:#6c757d;">å–æ¶ˆæ›´æ–°</button>
        </div>
    </div>

    <div class="input-section">
        <span id="saveStatus" class="status-indicator">âœ… å·²å„²å­˜</span>
        <h3>ğŸ“ æ¥­ç¸¾è³‡æ–™è²¼ä¸Šå€</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">
            æ ¼å¼ç¯„ä¾‹ï¼š11/17 å§šè²´13 èŠ±ç”°6 å† å¸Œ5
        </p>
        <textarea id="inputData" rows="6" style="height: 120px;"></textarea>
        
        <div class="btn-group">
            <button class="btn-calc" id="calculateButton">ğŸ”„ é‡æ–°è¨ˆç®—å ±è¡¨</button>
            <button class="btn-clear" id="clearButton">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™</button>
        </div>
        
        <div class="ocr-section">
            <h4>ğŸ“· æˆªåœ–åˆ†æèˆ‡è¼¸å…¥ (AI è¼”åŠ©)</h4>
            <div class="date-input-group">
                <label for="analysisDate">è«‹å¡«å…¥æ—¥æœŸ (M/D):</label>
                <input type="text" id="analysisDate" placeholder="ä¾‹å¦‚: 11/24">
            </div>
            <input type="file" id="imageUpload" accept="image/*">
            <div class="ocr-button-group">
                <button class="btn-ai" id="analyzeButton" style="width: 100%; padding: 10px; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ¤– åˆ†ææˆªåœ–ä¸¦åŒ¯å…¥</button>
            </div>
            <div id="analysisStatus"></div>
        </div>
    </div>

    <div class="input-section" style="border-top: 5px solid #6610f2;">
        <h3>âš™ï¸ å°å¸³å–®å…§å®¹è¨­å®š</h3>
        <div class="form-group">
            <label>å°å¸³å–®æ—¥æœŸå€é–“ (å°‡é¡¯ç¤ºåœ¨å°å¸³å–®æ¨™é¡Œ)ï¼š</label>
            <input type="text" id="billDateRangeInput" placeholder="ä¾‹å¦‚: 11/24 - 11/24">
        </div>
        <div class="form-group">
            <label>è­¦èªèˆ‡æ³¨æ„äº‹é … (å¯è‡ªç”±ç·¨è¼¯)ï¼š</label>
            <textarea id="billWarningTemplate" rows="8">ğŸš¨ è«‹å‹™å¿…æ ¸å°ä»¥ä¸‹é‡è¦è³‡è¨Š

* ç¸½é‡‘é¡ï¼š è«‹æ ¸å¯¦æœ€ä¸Šæ–¹æ‚¨åå­—å¾Œé¢çš„ç¸½é‡‘é¡ã€‚
* é è¨ˆå…¥æ¬¾ï¼š é è¨ˆæ–¼ï¼ˆé€±ä¸€ï¼‰**å­˜å…¥ï¼Œå±†æ™‚å°‡ä¸€ä½µé™„ä¸Šæ°´å–®ï¼ˆå°ç™½ï¼‰ã€‚
* å¸³è™Ÿè®Šæ›´é€šçŸ¥ï¼š å¦‚æœ‰ä»»ä½•å¸³è™Ÿéœ€æ›´æ”¹ï¼Œè«‹å‹™å¿…åœ¨ä»Šæ—¥ä¸­åˆå‰å‘ŠçŸ¥ã€‚
* é¢¨éšªè²æ˜ï¼š åŒ¯éŒ¯ä¸è£œï¼Œè«‹ä»”ç´°ç¢ºèªã€‚</textarea>
        </div>
        <button class="btn-action" id="saveBillConfigBtn" style="width: 100%;">ğŸ’¾ æš«å­˜è¨­å®š (é‡æ–°æ•´ç†å¾Œç”Ÿæ•ˆ)</button>
    </div>

    <h2 id="reportTitle" style="display:none;">å€‹äººé€±å ±è¡¨ (å«å°å¸³å–®)</h2>
    <div id="individualReports" class="report-container"></div>

    <h2 id="summaryTitle" style="display:none;">æ¯æ—¥åˆè¨ˆç¸½è¡¨</h2>
    <div id="summarySection" class="summary-section" style="display:none;">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>æ˜ŸæœŸ</th>
                    <th>åˆè¨ˆ</th>
                </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
        </table>
    </div>

    <div class="input-section" style="margin-top: 40px;">
        <span id="accountStatus" class="status-indicator" style="right: 20px; color: #17a2b8;">âœ… å¸³æˆ¶æ¸…å–®å·²æ›´æ–°</span>
        <h3>ğŸ¦ éŠ€è¡Œå¸³æˆ¶æ¸…å–®ç®¡ç†</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">
            æ›´æ–°æ™‚ç³»çµ±æœƒè‡ªå‹•å°‡å¸³è™Ÿæ¨™æº–åŒ–ç‚º XXXX-XXXX-XXXX æ ¼å¼ã€‚
            <br><b>Tips:</b> å¯ç›´æ¥è²¼ä¸Š `åç¨± éŠ€è¡Œ 123456789012` æˆ– `åç¨± éŠ€è¡Œ 123 456 789`ã€‚
        </p>
        <textarea id="accountInputData" rows="6" placeholder="è²¼ä¸Šæ‚¨çš„å¸³æˆ¶æ¸…å–®æ–‡å­—..."></textarea>
        <div class="btn-group">
            <button class="btn-action" id="uploadAccountListButton">â¬†ï¸ æ›´æ–°èˆ‡æ•´ç†å¸³æˆ¶æ¸…å–®</button>
            <button class="btn-clear" id="clearAccountListButton">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>
    
    <h2 id="referenceTitle" style="display:none;">éŠ€è¡Œå¸³æˆ¶åƒè€ƒæ¸…å–®</h2>
    <div id="accountReferenceList" class="account-reference-container"></div>

    <div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <script type="module">
        // [FIX] ä½¿ç”¨ç©©å®šçš„ Firebase ç‰ˆæœ¬
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let db = null;
        let auth = null;
        let isCloudMode = false;
        let geminiApiKey = '';
        
        // [FIX] é è¨­ Firebase è¨­å®š (ç›´æ¥æ•´åˆæä¾›çš„ Config)
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDsUsWuynci0DP71veuu19Ht8bJmhHSkHs",
            authDomain: "worktools-f53e5.firebaseapp.com",
            databaseURL: "https://worktools-f53e5-default-rtdb.firebaseio.com",
            projectId: "worktools-f53e5",
            storageBucket: "worktools-f53e5.firebasestorage.app",
            messagingSenderId: "950551082090",
            appId: "1:950551082090:web:3c2c4962b5ffa044aec613",
            measurementId: "G-EKPY3SC0BR"
        };
        
        // å¸¸æ•¸è¨­å®š
        const STORAGE_KEY_SETTINGS = 'weekly_app_settings';
        const STORAGE_KEY_LOCAL_DATA = 'weekly_local_sales_data';
        const STORAGE_KEY_LOCAL_ACC = 'weekly_local_account_data';
        const STORAGE_KEY_BILL_CONFIG = 'weekly_bill_config';
        
        const DAY_MAP = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 0: 'æ—¥' };
        const DAY_ORDER = [1, 2, 3, 4, 5, 6, 0];
        
        const COLLECTION_NAME = 'salesData';
        const DATA_DOC_ID = 'weeklyInput'; 
        const ACCOUNT_COLLECTION_NAME = 'accountData';
        const ACCOUNT_DOC_ID = 'accountList';
        const DEFAULT_APP_ID = 'universal-app'; 

        const BANK_KEYWORDS = {
            "åœ‹æ³°": "ğŸ¦ åœ‹æ³°ä¸–è¯éŠ€è¡Œ (Cathay United Bank)",
            "ä¸–è¯": "ğŸ¦ åœ‹æ³°ä¸–è¯éŠ€è¡Œ (Cathay United Bank)",
            "å°æ–°": "ğŸ’³ å°æ–°éŠ€è¡Œ (Taishin Bank)",
            "ä¸­åœ‹ä¿¡è¨—": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ (CTBC Bank)",
            "ä¸­ä¿¡": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ (CTBC Bank)",
            "ç‰å±±": "â›°ï¸ ç‰å±±éŠ€è¡Œ (E.SUN Bank)",
            "å¯Œé‚¦": "ğŸ’³ å°åŒ—å¯Œé‚¦éŠ€è¡Œ (Taipei Fubon Bank)",
            "æ°¸è±": "ğŸ›ï¸ å…¶ä»–éŠ€è¡Œ",
            "å…ƒå¤§": "ğŸ›ï¸ å…¶ä»–éŠ€è¡Œ"
        };
        const DEFAULT_BANK_CATEGORY = "ğŸ›ï¸ å…¶ä»–éŠ€è¡Œ";

        // --- DOM å…ƒç´  ---
        const $inputData = document.getElementById('inputData');
        const $accountInputData = document.getElementById('accountInputData');
        const $modeBadge = document.getElementById('systemModeBadge');
        const $toast = document.getElementById("toast");
        
        const $billDateRangeInput = document.getElementById('billDateRangeInput');
        const $billWarningTemplate = document.getElementById('billWarningTemplate');
        
        const $conflictModal = document.getElementById('conflictModal');
        const $conflictList = document.getElementById('conflictList');

        // --- 1. ç³»çµ±åˆå§‹åŒ–é‚è¼¯ ---
        function loadSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS) || '{}');
        }

        async function initSystem() {
            const settings = loadSettings();
            geminiApiKey = settings.apiKey || '';

            const billConfig = JSON.parse(localStorage.getItem(STORAGE_KEY_BILL_CONFIG) || '{}');
            if (billConfig.dateRange) $billDateRangeInput.value = billConfig.dateRange;
            if (billConfig.warning) $billWarningTemplate.value = billConfig.warning;

            // [FIX] å„ªå…ˆä½¿ç”¨è¨­å®šä¸­çš„ Configï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­çš„ Config
            let configToUse = null;
            if (settings.firebaseConfig) {
                try {
                    configToUse = JSON.parse(settings.firebaseConfig);
                } catch(e) { console.error("è¨­å®šæª” JSON è§£æéŒ¯èª¤", e); }
            } else {
                configToUse = DEFAULT_FIREBASE_CONFIG;
            }

            if (configToUse) {
                try {
                    // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œé¿å…é‡è¤‡åˆå§‹åŒ–
                    const app = initializeApp(configToUse);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    await signInAnonymously(auth);
                    isCloudMode = true;
                    updateModeUI(true);
                    listenCloudSales();
                    listenCloudAccounts();
                    return;
                } catch (e) {
                    console.error("é›²ç«¯åˆå§‹åŒ–å¤±æ•—ï¼Œåˆ‡æ›å›å–®æ©Ÿæ¨¡å¼:", e);
                    // åªæœ‰åœ¨çœŸçš„é€£ç·šå¤±æ•—æ™‚æ‰å½ˆå‡ºè­¦å‘Š
                    if(e.code !== 'app/duplicate-app') {
                        alert("Firebase é€£ç·šå¤±æ•—ï¼Œå·²åˆ‡æ›å›å–®æ©Ÿæ¨¡å¼ã€‚");
                    }
                }
            }

            isCloudMode = false;
            updateModeUI(false);
            loadLocalData();
        }

        function updateModeUI(isCloud) {
            if (isCloud) {
                $modeBadge.textContent = "â˜ï¸ é›²ç«¯åŒæ­¥æ¨¡å¼ (å·²é€£ç·š)";
                $modeBadge.className = "mode-badge mode-cloud";
            } else {
                $modeBadge.textContent = "ğŸ’» å–®æ©Ÿæ¨¡å¼ (è³‡æ–™å­˜æ–¼ç€è¦½å™¨)";
                $modeBadge.className = "mode-badge mode-local";
            }
        }

        // --- 2. è³‡æ–™å­˜å–é‚è¼¯ ---

        async function saveSalesData(text) {
            if (isCloudMode && db) {
                try {
                    const docRef = doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/${COLLECTION_NAME}/${DATA_DOC_ID}`);
                    await setDoc(docRef, { dataString: text, timestamp: Date.now() });
                    showStatus('saveStatus');
                } catch(e) { console.error(e); }
            } else {
                localStorage.setItem(STORAGE_KEY_LOCAL_DATA, text);
                showStatus('saveStatus');
            }
        }

        // [FIX] æ–°å¢ saveAccountData å‡½å¼ï¼Œç”¨æ–¼è™•ç†æ¸…ç©ºæˆ–ç´”æ–‡å­—å„²å­˜
        async function saveAccountData(text) {
            // å¦‚æœå‚³å…¥ç©ºå­—ä¸²ï¼Œä»£è¡¨æ¸…ç©ºï¼Œæˆ‘å€‘å‚³å…¥ç©ºç‰©ä»¶çµ¦ commitAccountData
            if (!text) {
                await commitAccountData({}, '');
            } else {
                // å¦‚æœæ˜¯æ‰‹å‹•ä¿®æ”¹æ–‡å­—ä½†æœªæŒ‰ã€Œæ•´ç†ã€ï¼Œæš«æ™‚åªå­˜æ–‡å­— (é€™è£¡é¸æ“‡ç›´æ¥ç•¶ä½œæ›´æ–°è§¸ç™¼)
                $accountInputData.value = text;
                const emptyStruct = {};
                await commitAccountData(emptyStruct, text);
            }
        }

        async function commitAccountData(structured, rawText) {
            // å¦‚æœ rawText æœªæä¾›ï¼Œå‰‡æ ¹æ“š structured ç”¢ç”Ÿ
            const formattedText = rawText !== undefined ? rawText : generateFormattedText(structured);
            $accountInputData.value = formattedText; 
            
            if (isCloudMode && db) {
                try {
                    const docRef = doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/${ACCOUNT_COLLECTION_NAME}/${ACCOUNT_DOC_ID}`);
                    await setDoc(docRef, { accounts: structured, rawText: formattedText, timestamp: Date.now() });
                    showStatus('accountStatus');
                } catch(e) { console.error(e); }
            } else {
                localStorage.setItem(STORAGE_KEY_LOCAL_ACC, JSON.stringify({ accounts: structured, rawText: formattedText }));
                showStatus('accountStatus');
                renderAccountList(structured);
            }
            $conflictModal.style.display = 'none'; 
        }
        
        function saveBillConfig() {
            const config = {
                dateRange: $billDateRangeInput.value,
                warning: $billWarningTemplate.value
            };
            localStorage.setItem(STORAGE_KEY_BILL_CONFIG, JSON.stringify(config));
            generateReport(); 
            alert("å°å¸³å–®è¨­å®šå·²æ›´æ–°ï¼");
        }

        function loadLocalData() {
            const sales = localStorage.getItem(STORAGE_KEY_LOCAL_DATA);
            if (sales) {
                $inputData.value = sales;
                generateReport();
            }
            const accData = JSON.parse(localStorage.getItem(STORAGE_KEY_LOCAL_ACC) || '{}');
            if (accData.rawText) $accountInputData.value = accData.rawText;
            if (accData.accounts) renderAccountList(accData.accounts);
        }

        function listenCloudSales() {
            const docRef = doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/${COLLECTION_NAME}/${DATA_DOC_ID}`);
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const val = snap.data().dataString || '';
                    if ($inputData.value !== val) {
                        $inputData.value = val;
                        generateReport();
                    }
                }
            });
        }
        function listenCloudAccounts() {
            const docRef = doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/${ACCOUNT_COLLECTION_NAME}/${ACCOUNT_DOC_ID}`);
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if ($accountInputData.value !== data.rawText) $accountInputData.value = data.rawText || '';
                    renderAccountList(data.accounts);
                }
            });
        }

        // --- 3. æ™ºæ…§å¸³æˆ¶æ•´ç†é‚è¼¯ ---

        function handleAccountUpdate() {
            const rawText = $accountInputData.value;
            const rawList = parseAccountListToFlat(rawText);
            const duplicates = findDuplicates(rawList);
            
            if (duplicates.length > 0) {
                showConflictModal(duplicates, rawList);
            } else {
                const structured = reorganizeAccounts(rawList);
                commitAccountData(structured); // ä¸éœ€è¦å‚³ rawTextï¼Œæœƒè‡ªå‹•ç”Ÿæˆ
            }
        }

        function parseAccountListToFlat(text) {
            const lines = text.split('\n');
            const flatList = [];
            
            const ignoreKeywords = ["ç¸½é‡‘é¡", "é è¨ˆå…¥æ¬¾", "å¸³è™Ÿè®Šæ›´é€šçŸ¥", "é¢¨éšªè²æ˜", "æ¯é€±å°å¸³å–®"];
            const ignoreStarters = ["*", "ğŸš¨", "ğŸ’°", "âš ï¸", "#"];

            lines.forEach(line => {
                const trim = line.trim();
                if (!trim) return;
                
                if (ignoreKeywords.some(kw => trim.includes(kw))) return;
                if (ignoreStarters.some(st => trim.startsWith(st))) return;
                if (trim.match(/^[ğŸ‡¨ğŸ‡¹ğŸ’°ğŸ¦â›°ï¸ğŸ’³]\s*(.+)/)) return;
                if (trim.includes('åç¨±') && trim.includes('éŠ€è¡Œå¸³è™Ÿ')) return;

                const parts = trim.split(/\s+|\t/).filter(p => p.length > 0);
                
                if (parts.length >= 2) {
                    const name = parts[0];
                    let accountParts = [];
                    let remainingParts = parts.slice(1);
                    
                    let i = remainingParts.length - 1;
                    while (i >= 0) {
                        const part = remainingParts[i];
                        if (/^[\d-]+$/.test(part)) {
                            accountParts.unshift(part); 
                            remainingParts.pop(); 
                        } else {
                            break; 
                        }
                        i--;
                    }
                    
                    let rawAccountStr = "";
                    let bankName = "";
                    
                    if (accountParts.length > 0) {
                        rawAccountStr = accountParts.join(''); 
                        bankName = remainingParts.join(' ') || "æœªæŒ‡å®šéŠ€è¡Œ";
                    } else {
                        rawAccountStr = parts[parts.length - 1];
                        bankName = parts.slice(1, parts.length - 1).join(' ') || "æœªæŒ‡å®šéŠ€è¡Œ";
                    }

                    const cleanAccount = rawAccountStr.replace(/\D/g, ''); 
                    const formattedAccount = cleanAccount.match(/.{1,4}/g)?.join('-') || rawAccountStr;

                    flatList.push({ name, bankName, account: formattedAccount });
                }
            });
            return flatList;
        }

        function findDuplicates(flatList) {
            const nameMap = {};
            const duplicates = [];
            
            flatList.forEach(item => {
                if (!nameMap[item.name]) {
                    nameMap[item.name] = [];
                }
                nameMap[item.name].push(item);
            });

            for (const name in nameMap) {
                if (nameMap[name].length > 1) {
                    const uniqueItems = nameMap[name].filter((v,i,a)=>a.findIndex(t=>(t.account===v.account && t.bankName===v.bankName))===i);
                    if (uniqueItems.length > 1) {
                        duplicates.push({ name: name, items: uniqueItems });
                    }
                }
            }
            return duplicates;
        }

        function reorganizeAccounts(flatList) {
            const structured = {};
            
            const orderedCategories = [
                "ğŸ¦ åœ‹æ³°ä¸–è¯éŠ€è¡Œ (Cathay United Bank)",
                "ğŸ’³ å°æ–°éŠ€è¡Œ (Taishin Bank)",
                "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ (CTBC Bank)",
                "â›°ï¸ ç‰å±±éŠ€è¡Œ (E.SUN Bank)",
                "ğŸ’³ å°åŒ—å¯Œé‚¦éŠ€è¡Œ (Taipei Fubon Bank)",
                "ğŸ›ï¸ å…¶ä»–éŠ€è¡Œ"
            ];
            orderedCategories.forEach(c => structured[c] = []);

            flatList.forEach(item => {
                let category = DEFAULT_BANK_CATEGORY;
                for (const key in BANK_KEYWORDS) {
                    if (item.bankName.includes(key)) {
                        category = BANK_KEYWORDS[key];
                        break;
                    }
                }
                if (!structured[category]) structured[category] = [];
                structured[category].push(item);
            });

            for (const cat in structured) {
                if (structured[cat].length === 0) delete structured[cat];
            }
            return structured;
        }

        function generateFormattedText(structured) {
            let text = "ğŸ’° çµ‚æ¥µæ ¸å°ç‰ˆï¼šæ¯é€±å°å¸³å–®\n\n";
            text += document.getElementById('billWarningTemplate').value + "\n\n";

            for (const cat in structured) {
                text += `\n${cat}\n\nåç¨±\téŠ€è¡Œåç¨±\téŠ€è¡Œå¸³è™Ÿ\n`;
                structured[cat].forEach(item => {
                    text += `${item.name}\t${item.bankName}\t${item.account}\n`;
                });
            }
            return text;
        }

        function showConflictModal(duplicates, fullFlatList) {
            $conflictList.innerHTML = '';
            
            duplicates.forEach((dup, index) => {
                const div = document.createElement('div');
                div.className = 'conflict-item';
                div.innerHTML = `<strong>åç¨±è¡çªï¼š${dup.name}</strong><br>`;
                
                dup.items.forEach((item, i) => {
                    div.innerHTML += `
                        <label>
                            <input type="radio" name="dup_${index}" value="${i}" ${i===0?'checked':''}> 
                            ${item.bankName} - ${item.account}
                        </label><br>
                    `;
                });
                
                const btnGroup = document.createElement('div');
                btnGroup.className = 'conflict-options';
                
                const btnKeep = document.createElement('button');
                btnKeep.textContent = "ä¿ç•™é¸å–é …";
                btnKeep.className = 'btn-action';
                btnKeep.onclick = () => resolveConflict(dup.name, dup.items, index, 'selected', fullFlatList);

                const btnBoth = document.createElement('button');
                btnBoth.textContent = "å…¨éƒ¨ä¿ç•™";
                btnBoth.className = 'btn-ai';
                btnBoth.onclick = () => resolveConflict(dup.name, dup.items, index, 'all', fullFlatList);

                btnGroup.appendChild(btnKeep);
                btnGroup.appendChild(btnBoth);
                div.appendChild(btnGroup);
                
                $conflictList.appendChild(div);
            });
            
            $conflictModal.style.display = 'block';
        }

        function resolveConflict(name, items, dupIndex, method, fullFlatList) {
            let newList = fullFlatList.filter(item => item.name !== name);
            
            if (method === 'selected') {
                const radios = document.getElementsByName(`dup_${dupIndex}`);
                let selectedIndex = 0;
                radios.forEach(r => { if(r.checked) selectedIndex = parseInt(r.value); });
                newList.push(items[selectedIndex]);
            } else if (method === 'all') {
                items.forEach(item => newList.push(item));
            }

            const structured = reorganizeAccounts(newList);
            commitAccountData(structured); 
        }

        // --- 4. æ ¸å¿ƒæ¥­å‹™é‚è¼¯ ---
        
        function parseAndCalculate(input) {
            const lines = input.split('\n');
            const currentYear = new Date().getFullYear();
            const personData = {}; 
            const dailyGrandTotals = Object.fromEntries(DAY_ORDER.map(i => [i, 0]));
            let grandTotalAll = 0;
            let hasData = false;

            lines.forEach(line => {
                const parts = line.trim().split(/\s+/).filter(p => p.length > 0);
                if (parts.length < 2) return;
                const dateStr = parts[0];
                try {
                    const dateObj = new Date(`${currentYear}/${dateStr}`);
                    if (isNaN(dateObj.getTime())) return;
                    
                    const dayIndex = dateObj.getDay(); 
                    
                    for (let i = 1; i < parts.length; i++) {
                        const token = parts[i];
                        const match = token.match(/^([^\d]+)([\d\.]+)$/);
                        if (match) {
                            const name = match[1];
                            const val = parseFloat(match[2]);
                            if (!personData[name]) personData[name] = Object.fromEntries(DAY_ORDER.map(i => [i, []]));
                            personData[name][dayIndex].push(val);
                            dailyGrandTotals[dayIndex] += val;
                            grandTotalAll += val;
                            hasData = true;
                        }
                    }
                } catch (e) { console.error(e); }
            });

            return { personData, dailyGrandTotals, grandTotalAll, hasData };
        }

        function getAccountInfo(name) {
            const accText = $accountInputData.value;
            const flat = parseAccountListToFlat(accText);
            
            const cleanName = name.trim().toLowerCase();
            return flat.find(acc => {
                const accName = acc.name.trim().toLowerCase();
                return accName === cleanName || accName.includes(cleanName) || cleanName.includes(accName);
            });
        }

        function generateReport() {
            const input = $inputData.value.trim();
            const $ir = document.getElementById('individualReports');
            const $ss = document.getElementById('summarySection');
            
            $ir.innerHTML = '';
            $ss.style.display = 'none';
            document.getElementById('reportTitle').style.display = 'none';
            document.getElementById('summaryTitle').style.display = 'none';

            if (input.length === 0) return;

            const { personData, dailyGrandTotals, grandTotalAll, hasData } = parseAndCalculate(input);

            if (hasData) {
                document.getElementById('reportTitle').style.display = 'block';
                document.getElementById('summaryTitle').style.display = 'block';
                
                const billDateRange = $billDateRangeInput.value.trim() || "(æ—¥æœŸæœªå®š)";
                const billWarning = $billWarningTemplate.value;
                
                Object.keys(personData).forEach(name => {
                    let html = `<div class="person-card"><div class="card-header">${name}</div><div class="card-body"><table>`;
                    let total = 0;
                    DAY_ORDER.forEach(day => {
                        const vals = personData[name][day];
                        const sub = vals.reduce((a,b)=>a+b,0);
                        total += sub;
                        html += `<tr><td class="col-day">${DAY_MAP[day]}</td><td class="col-data">${vals.join(', ')}</td><td class="col-subtotal">${sub||''}</td></tr>`;
                    });
                    html += `<tr><td colspan="2"></td><td class="total-cell">${total}</td></tr></table>`;
                    
                    const accInfo = getAccountInfo(name);
                    const amountDue = total * 100;
                    const bankName = accInfo ? accInfo.bankName : "å°šæœªè¨­å®šéŠ€è¡Œ";
                    const bankAcc = accInfo ? accInfo.account : "è«‹åœ¨ä¸‹æ–¹æ¸…å–®æ›´æ–°";
                    
                    const billText = `æ¯é€±å°å¸³å–® (${billDateRange})

${name} ${bankName} ${bankAcc} é‡‘é¡=${amountDue}

${billWarning}`;
                    const encodedBillText = encodeURIComponent(billText);

                    html += `
                        <button class="btn-copy-bill" onclick="copyBill('${encodedBillText}')">
                            ğŸ“‹ è¤‡è£½å°å¸³è³‡è¨Š
                        </button>
                    </div></div>`;
                    $ir.innerHTML += html;
                });

                let sumHtml = '';
                DAY_ORDER.forEach(day => sumHtml += `<tr><td>${DAY_MAP[day]}</td><td>${dailyGrandTotals[day]}</td></tr>`);
                sumHtml += `<tr class="summary-total-row"><td>ç¸½åˆè¨ˆ</td><td>${grandTotalAll}</td></tr>`;
                document.getElementById('summaryBody').innerHTML = sumHtml;
                $ss.style.display = 'block';
            }
        }

        function renderAccountList(accounts) {
            const $list = document.getElementById('accountReferenceList');
            $list.innerHTML = '';
            document.getElementById('referenceTitle').style.display = 'none';
            if (!accounts || Object.keys(accounts).length === 0) return;
            
            document.getElementById('referenceTitle').style.display = 'block';
            for (const cat in accounts) {
                if (accounts[cat].length === 0) continue;
                let rows = accounts[cat].map(i => `<tr><td>${i.name}</td><td>${i.bankName}</td><td>${i.account}</td></tr>`).join('');
                $list.innerHTML += `<div class="bank-category"><h3>${cat}</h3><table class="account-table"><thead><tr><th>åç¨±</th><th>éŠ€è¡Œåç¨±</th><th>éŠ€è¡Œå¸³è™Ÿ</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
        }

        // --- AI é‚è¼¯ ---
        async function analyzeImage() {
            if (!geminiApiKey) {
                const useSim = confirm("âš ï¸ æœªåµæ¸¬åˆ° API Keyï¼Œæ˜¯å¦ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ï¼Ÿ");
                if (useSim) { simulateAIResponse(); return; }
                return;
            }
            const file = document.getElementById('imageUpload').files[0];
            const dateVal = document.getElementById('analysisDate').value.trim();
            const $status = document.getElementById('analysisStatus');
            const $btn = document.getElementById('analyzeButton');

            if (!file) { $status.innerHTML = '<span style="color:red">è«‹é¸æ“‡åœ–ç‰‡</span>'; return; }
            if (!dateVal.match(/^\d{1,2}\/\d{1,2}$/)) { $status.innerHTML = '<span style="color:red">è«‹è¼¸å…¥æœ‰æ•ˆæ—¥æœŸ (M/D)</span>'; return; }

            $btn.disabled = true;
            $status.innerHTML = 'â³ åˆ†æä¸­...';

            try {
                const base64Data = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                const prompt = `è«‹å¾åœ–ç‰‡æå–æ¥­ç¸¾ã€‚æŒ‡ç¤ºï¼š1.æ‰¾äººåæ—çš„å°æ•¸å€¼(å¦‚5,6)ã€‚2.å¿½ç•¥å¤§æ•¸å€¼(å¦‚2800)ã€‚æ ¼å¼ï¼šM/D å§“åæ•¸å€¼... æ—¥æœŸ:${dateVal}ã€‚åƒ…è¼¸å‡ºç´”æ–‡å­—ã€‚`;
                
                // [FIX] ä½¿ç”¨æ­£ç¢ºçš„ Gemini æ¨¡å‹åç¨± (gemini-1.5-flash)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }] })
                });
                const json = await res.json();
                const text = json.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                if (text) {
                    let current = $inputData.value.trim();
                    if (current) current += '\n';
                    $inputData.value = current + text;
                    saveSalesData($inputData.value);
                    generateReport();
                    $status.innerHTML = '<span style="color:green">âœ… åŒ¯å…¥æˆåŠŸ</span>';
                } else { $status.innerHTML = '<span style="color:red">âš ï¸ ç„¡æ³•è­˜åˆ¥æˆ– API éŒ¯èª¤</span>'; console.log(json); }
            } catch(e) { console.error(e); $status.innerHTML = '<span style="color:red">âŒ éŒ¯èª¤ (è«‹æª¢æŸ¥ Console)</span>'; } finally { $btn.disabled = false; }
        }

        function simulateAIResponse() {
            const dateVal = document.getElementById('analysisDate').value.trim() || '11/24';
            const $status = document.getElementById('analysisStatus');
            $status.innerHTML = 'â³ æ¨¡æ“¬ AI åˆ†æä¸­...';
            setTimeout(() => {
                let current = $inputData.value.trim();
                if (current) current += '\n';
                $inputData.value = current + `${dateVal} æ¬Šå¿—é¾5 é›…å…¸å¨œ4 å¯å¯5 é¡åŒ6`;
                saveSalesData($inputData.value);
                generateReport();
                $status.innerHTML = '<span style="color:green">âœ… æ¨¡æ“¬åŒ¯å…¥æˆåŠŸ</span>';
            }, 1000);
        }

        // --- UI Events ---
        window.copyBill = function(encodedText) {
            const text = decodeURIComponent(encodedText);
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            $toast.className = "show";
            setTimeout(() => { $toast.className = $toast.className.replace("show", ""); }, 3000);
        };

        function showStatus(id) {
            const el = document.getElementById(id);
            if(el) {
                el.style.display = 'block';
                setTimeout(() => el.style.display = 'none', 2000);
            }
        }

        const modal = document.getElementById('settingsModal');
        document.getElementById('openSettingsBtn').onclick = () => {
            const s = loadSettings();
            document.getElementById('cfgApiKey').value = s.apiKey || '';
            document.getElementById('cfgFirebase').value = s.firebaseConfig || '';
            modal.style.display = "block";
        };
        document.getElementsByClassName('close')[0].onclick = () => modal.style.display = "none";
        window.onclick = (e) => { if(e.target == modal) modal.style.display = "none"; if(e.target == $conflictModal) $conflictModal.style.display = "none"; }

        document.getElementById('saveSettingsBtn').onclick = () => {
            const newSettings = { apiKey: document.getElementById('cfgApiKey').value.trim(), firebaseConfig: document.getElementById('cfgFirebase').value.trim() };
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(newSettings));
            alert("è¨­å®šå·²å„²å­˜ï¼");
            location.reload();
        };

        $inputData.addEventListener('input', () => { saveSalesData($inputData.value); generateReport(); });
        document.getElementById('calculateButton').onclick = () => { generateReport(); saveSalesData($inputData.value); };
        document.getElementById('clearButton').onclick = () => { if(confirm('ç¢ºå®šæ¸…ç©º?')) { $inputData.value = ''; saveSalesData(''); generateReport(); } };
        
        $accountInputData.addEventListener('input', () => { /* No auto save */ });
        document.getElementById('uploadAccountListButton').onclick = handleAccountUpdate;
        
        // [FIX] é€™è£¡ä½¿ç”¨äº† saveAccountDataï¼Œç¾åœ¨è©²å‡½å¼å·²å®šç¾©
        document.getElementById('clearAccountListButton').onclick = () => { if(confirm('ç¢ºå®šæ¸…ç©ºå¸³æˆ¶æ¸…å–®?')) { saveAccountData(''); } };
        
        document.getElementById('saveBillConfigBtn').onclick = saveBillConfig;
        $billDateRangeInput.addEventListener('input', generateReport);
        $billWarningTemplate.addEventListener('input', generateReport);
        document.getElementById('analyzeButton').onclick = analyzeImage;

        initSystem();
    </script>
</body>
</html>