<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿæ¥­ç¸¾è¨ˆç®— (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #f0f2f6;
            margin: 0;
            padding: 20px;
        }
        h1, h2 { color: #333; text-align: center; }

        /* è¼¸å…¥å€å¡Š */
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto 30px auto;
            position: relative;
        }
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 13px;
            font-weight: bold;
            color: #28a745;
            display: none; /* é è¨­éš±è— */
            background: #e8f5e9;
            padding: 5px 10px;
            border-radius: 15px;
        }
        .status-syncing {
            color: #007bff;
            background: #e7f1ff;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            line-height: 1.5;
        }
        
        /* èª¿æ•´æŒ‰éˆ•çµ„ */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }
        .btn-bank-tools {
            display: flex;
            gap: 10px;
            width: 100%; /* ä½”æ»¿æ•´è¡Œ */
        }

        button {
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-calc {
            background-color: #007bff;
            color: white;
            flex: 2;
        }
        .btn-calc:hover { background-color: #0056b3; }
        
        .btn-clear {
            background-color: #dc3545;
            color: white;
            flex: 1;
        }
        .btn-clear:hover { background-color: #a71d2a; }

        .btn-copy-list {
            background-color: #ffc107;
            color: #333;
            flex: 1;
        }
        .btn-copy-list:hover { background-color: #e0a800; }

        /* å ±è¡¨å®¹å™¨ */
        .report-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        /* å€‹äººå¡ç‰‡ */
        .person-card {
            background: white;
            border: 1px solid #ddd;
            width: 350px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column;
        }
        .card-warning-border {
            border: 3px solid #dc3545 !important;
        }

        .card-header {
            background-color: #ffff00;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            text-align: center;
            font-size: 18px;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        
        .col-day { background-color: #fff2cc; width: 40px; font-weight: bold; }
        .col-data { background-color: #ececf4; text-align: left; padding-left: 15px; }
        .col-subtotal { background-color: #ececf4; width: 50px; }
        .total-cell { background-color: #ff0000; color: white; font-weight: bold; text-align: center; font-size: 18px; }

        /* è¤‡è£½å€å¡Šæ¨£å¼ */
        .copy-info-section {
            margin-top: auto; 
            padding: 10px;
            border-top: 1px solid #eee;
        }
        .copy-box {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            position: relative;
        }
        .copy-box:hover {
            background-color: #dee2e6;
        }
        .copy-status {
            position: absolute;
            top: 5px;
            right: 5px;
            color: green;
            font-size: 12px;
            display: none;
        }

        /* æ¯æ—¥åˆè¨ˆç¸½è¡¨ */
        .summary-section {
            max-width: 300px;
            margin: 40px auto;
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary-table th { background-color: #fff2cc; }
        .summary-table td { background-color: #f2f2f2; }
        .summary-total-row td { background-color: #e6e6e6; font-weight: bold; color: red; }
    </style>
</head>
<body>

    <h1>ğŸ“Š æ¥­ç¸¾è¨ˆç®—ç³»çµ± (é›²ç«¯åŒæ­¥ç‰ˆ)</h1>

    <div class="input-section">
        <span id="saveStatus" class="status-indicator">âœ… é›²ç«¯å·²å„²å­˜</span>
        <h3>ğŸ“ æ¥­ç¸¾è³‡æ–™è²¼ä¸Šå€</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">
            æ ¼å¼ç¯„ä¾‹ï¼š11/17 å§šè²´13 èŠ±ç”°6 å† å¸Œ5
        </p>
        <textarea id="inputData" placeholder="è¼‰å…¥é›²ç«¯è³‡æ–™ä¸­..."></textarea>
    </div>

    <div class="input-section">
        <span id="bankSaveStatus" class="status-indicator">âœ… éŠ€è¡Œåå–®å·²å„²å­˜</span>
        <h3>ğŸ¦ éŠ€è¡Œåå–®ç®¡ç†å€</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">
            æ ¼å¼ï¼š**å§“å éŠ€è¡Œåç¨± éŠ€è¡Œå¸³è™Ÿ** (æ¯è¡Œä¸€ç­†è³‡æ–™)<br>
            ç¯„ä¾‹ï¼šå§šè²´ åœ‹æ³°ä¸–è¯éŠ€è¡Œ 2060-3500-9237
        </p>
        <textarea id="bankInfoData" rows="10" placeholder="è¼‰å…¥é›²ç«¯è³‡æ–™ä¸­..."></textarea>
        
        <div class="btn-bank-tools">
            <button class="btn-copy-list" onclick="copyBankList()">ğŸ“‹ è¤‡è£½å®Œæ•´åå–® (å‚™ä»½)</button>
        </div>
        <div class="btn-group">
            <button class="btn-calc" onclick="generateReport()">ğŸš€ é‡æ–°è¨ˆç®—å ±è¡¨</button>
            <button class="btn-clear" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>
    <h2 id="reportTitle" style="display:none;">å€‹äººé€±å ±è¡¨</h2>
    <div id="individualReports" class="report-container"></div>

    <h2 id="summaryTitle" style="display:none;">æ¯æ—¥åˆè¨ˆç¸½è¡¨</h2>
    <div id="summarySection" class="summary-section" style="display:none;">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>åˆè¨ˆ</th>
                </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
        </table>
    </div>

    <div id="errorSection" class="input-section" style="display:none; border: 2px solid #dc3545;">
        <h3 style="color: #dc3545;">ğŸš¨ æ¥­ç¸¾è³‡æ–™è§£æéŒ¯èª¤é€šçŸ¥</h3>
        <p>ä»¥ä¸‹æ¥­ç¸¾è¼¸å…¥åœ¨è§£ææ™‚ç™¼ç”Ÿå•é¡Œï¼Œè«‹æª¢æŸ¥åŸå§‹è¼¸å…¥ï¼š</p>
        <ul id="errorList" style="color: #dc3545; padding-left: 20px;">
            </ul>
    </div>

    <div id="detailExcelCopySection" class="input-section" style="display:none; margin-top: 30px;">
        <h3>ğŸ“‹ è©³ç´°æ¥­ç¸¾æ˜ç´°åŒ¯å‡º (è²¼è‡³è©¦ç®—è¡¨)</h3>
        <p style="color: #666; font-size: 0.9em;">
            åŒ…å«æ¯ä½äººå“¡çš„æ¯æ—¥æ¥­ç¸¾æ˜ç´° (å–®æ—¥å¤šç­†åˆ†æ•¸ä»¥**å…¨å½¢ç©ºæ ¼**åˆ†éš”) åŠæ¯æ—¥ç¸½åˆè¨ˆã€‚
        </p>
        <div class="copy-box" id="detailExcelCopyContainer" onclick="copyToClipboard('detailExcelCopyContent', 'detailExcelCopyStatus')">
            <pre id="detailExcelCopyContent" style="white-space: pre-wrap; margin: 0; font-family: monospace;"></pre>
            <span id="detailExcelCopyStatus" class="copy-status">âœ… å·²è¤‡è£½!</span>
        </div>
    </div>
    
    <div id="excelCopySection" class="input-section" style="display:none; margin-top: 30px;">
        <h3>ğŸ“ è½‰å¸³ç¸½çµè³‡æ–™åŒ¯å‡º (è²¼è‡³è©¦ç®—è¡¨è¿½è¹¤)</h3>
        <p style="color: #666; font-size: 0.9em;">
            é»æ“Šä¸‹æ–¹å€å¡Šï¼Œè¤‡è£½å¾Œå¯ç›´æ¥è²¼åˆ° Excel æˆ– Google è©¦ç®—è¡¨ (Tab åˆ†éš”)ã€‚
        </p>
        <div class="copy-box" id="excelCopyContainer" onclick="copyToClipboard('excelCopyContent', 'excelCopyStatus')">
            <pre id="excelCopyContent" style="white-space: pre-wrap; margin: 0; font-family: monospace;"></pre>
            <span id="excelCopyStatus" class="copy-status">âœ… å·²è¤‡è£½!</span>
        </div>
    </div>


    <script type="module">
        // 1. å¼•å…¥ Firebase å‡½å¼åº«
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // 2. ä½ çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDsUsWuynci0DP71veuu19Ht8bJmhHSkHs",
            authDomain: "worktools-f53e5.firebaseapp.com",
            databaseURL: "https://worktools-f53e5-default-rtdb.firebaseio.com",
            projectId: "worktools-f53e5",
            storageBucket: "worktools-f53e5.firebasestorage.app",
            messagingSenderId: "950551082090",
            appId: "1:950551082090:web:3c2c4962b5ffa044aec613",
            measurementId: "G-EKPY3SC0BR"
        };

        // 3. åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 4. å®šç¾©è³‡æ–™åº«è·¯å¾‘
        const DB_PATH_SALES = 'accounting/sales_data_v2';
        const DB_PATH_BANKS = 'accounting/bank_data_v2';

        const textArea = document.getElementById('inputData');
        const bankArea = document.getElementById('bankInfoData');
        const statusIndicator = document.getElementById('saveStatus');
        const bankStatusIndicator = document.getElementById('bankSaveStatus');

        // é˜²æŠ–å‹•å‡½æ•¸ (é¿å…æ‰“å­—å¤ªå¿«ä¸€ç›´ä¸Šå‚³)
        function debounce(func, timeout = 1000) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        // --- é›²ç«¯å„²å­˜é‚è¼¯ ---
        
        // å„²å­˜æ¥­ç¸¾è³‡æ–™åˆ°é›²ç«¯
        const saveSalesToCloud = debounce(() => {
            showStatus(statusIndicator, 'â˜ï¸ åŒæ­¥ä¸­...', 'syncing');
            set(ref(db, DB_PATH_SALES), textArea.value)
                .then(() => {
                    showStatus(statusIndicator, 'âœ… é›²ç«¯å·²å„²å­˜', 'success');
                    // åŒæ­¥å­˜åˆ° LocalStorage ç•¶ä½œæ–·ç¶²å‚™ä»½
                    localStorage.setItem('local_backup_sales', textArea.value);
                })
                .catch((error) => {
                    console.error("Upload failed: ", error);
                    showStatus(statusIndicator, 'âŒ ä¸Šå‚³å¤±æ•—', 'error');
                });
        });

        // å„²å­˜éŠ€è¡Œè³‡æ–™åˆ°é›²ç«¯
        const saveBanksToCloud = debounce(() => {
            showStatus(bankStatusIndicator, 'â˜ï¸ åŒæ­¥ä¸­...', 'syncing');
            set(ref(db, DB_PATH_BANKS), bankArea.value)
                .then(() => {
                    showStatus(bankStatusIndicator, 'âœ… éŠ€è¡Œåå–®å·²å„²å­˜', 'success');
                    // åŒæ­¥å­˜åˆ° LocalStorage ç•¶ä½œæ–·ç¶²å‚™ä»½
                    localStorage.setItem('local_backup_banks', bankArea.value);
                    window.parseBankInfo(bankArea.value); // è§¸ç™¼å…¨åŸŸè§£æ
                })
                .catch((error) => {
                    showStatus(bankStatusIndicator, 'âŒ ä¸Šå‚³å¤±æ•—', 'error');
                });
        });

        // ç›£è½è¼¸å…¥äº‹ä»¶
        textArea.addEventListener('input', () => {
            showStatus(statusIndicator, 'ğŸ’¾ æº–å‚™ä¸Šå‚³...', 'syncing');
            saveSalesToCloud();
        });

        bankArea.addEventListener('input', () => {
            showStatus(bankStatusIndicator, 'ğŸ’¾ æº–å‚™ä¸Šå‚³...', 'syncing');
            saveBanksToCloud();
            window.parseBankInfo(bankArea.value); // å³æ™‚è§£æè®“è¤‡è£½åŠŸèƒ½å¯ç”¨
        });

        // --- é›²ç«¯è®€å–é‚è¼¯ (Realtime Listener) ---

        let isInitialLoadSales = true;
        let isInitialLoadBanks = true;

        // ç›£è½æ¥­ç¸¾è³‡æ–™è®Šæ›´
        onValue(ref(db, DB_PATH_SALES), (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œæˆ–è€…å…§å®¹è·Ÿæœ¬åœ°ä¸ä¸€æ¨£ä¸”ä½¿ç”¨è€…æ²’æœ‰æ­£åœ¨æ‰“å­—(ç°¡å–®åˆ¤å®š)ï¼Œå‰‡æ›´æ–°
                // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡æ¡ç”¨ï¼šå¦‚æœå…§å®¹ä¸åŒå°±æ›´æ–°ï¼Œä½†è¦æ³¨æ„æ¸¸æ¨™å•é¡Œ
                // åœ¨æ­¤å·¥å…·æƒ…å¢ƒï¼Œé€šå¸¸æ˜¯æ‰“é–‹ç¶²é è¦çœ‹æœ€æ–°è³‡æ–™
                if (textArea.value !== data) {
                    textArea.value = data;
                    if (isInitialLoadSales) {
                        window.generateReport(); // åªæœ‰ç¬¬ä¸€æ¬¡è¼‰å…¥è‡ªå‹•è¨ˆç®—
                        isInitialLoadSales = false;
                    }
                }
            } else {
                // é›²ç«¯æ˜¯ç©ºçš„ï¼Œè©¦è‘—è®€å–æœ¬åœ°å‚™ä»½
                const localBackup = localStorage.getItem('local_backup_sales');
                if(localBackup && isInitialLoadSales) {
                    textArea.value = localBackup;
                    window.generateReport();
                }
                textArea.placeholder = "é›²ç«¯å°šç„¡è³‡æ–™ï¼Œè«‹é–‹å§‹è¼¸å…¥...";
                isInitialLoadSales = false;
            }
        });

        // ç›£è½éŠ€è¡Œè³‡æ–™è®Šæ›´
        onValue(ref(db, DB_PATH_BANKS), (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                if (bankArea.value !== data) {
                    bankArea.value = data;
                    window.parseBankInfo(data);
                }
            } else {
                 // é›²ç«¯æ˜¯ç©ºçš„ï¼Œè©¦è‘—è®€å–æœ¬åœ°å‚™ä»½
                const localBackup = localStorage.getItem('local_backup_banks');
                if(localBackup && isInitialLoadBanks) {
                    bankArea.value = localBackup;
                    window.parseBankInfo(localBackup);
                }
                bankArea.placeholder = "é›²ç«¯å°šç„¡éŠ€è¡Œåå–®ï¼Œè«‹é–‹å§‹è¼¸å…¥...";
            }
            isInitialLoadBanks = false;
        });

        // ç‹€æ…‹é¡¯ç¤º Helper
        function showStatus(element, text, type) {
            element.innerText = text;
            element.style.display = 'block';
            
            if (type === 'syncing') {
                element.className = 'status-indicator status-syncing';
            } else if (type === 'error') {
                 element.style.color = 'red';
                 element.style.backgroundColor = '#fdecea';
            } else {
                element.className = 'status-indicator';
                // æˆåŠŸè¨Šæ¯ 2ç§’å¾Œæ¶ˆå¤±
                setTimeout(() => {
                    element.style.display = 'none';
                }, 2000);
            }
        }
        
        // å°‡æ¸…é™¤åŠŸèƒ½æ›è¼‰åˆ° window ä»¥ä¾¿æŒ‰éˆ•å‘¼å« (å› ç‚º module scope éš”é›¢)
        window.clearCloudData = function() {
            if(confirm("ğŸ”¥ ç¢ºå®šè¦æ¸…ç©ºã€Œé›²ç«¯ã€æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡åŒæ­¥åˆªé™¤æ‰€æœ‰è£ç½®çš„è³‡æ–™ï¼")) {
                set(ref(db, DB_PATH_SALES), "");
                set(ref(db, DB_PATH_BANKS), "");
                textArea.value = "";
                bankArea.value = "";
                window.clearData(true); // å‘¼å«åŸæœ¬çš„æ¸…é™¤ UI é‚è¼¯
            }
        }
    </script>

    <script>
        // é€™è£¡ä¿ç•™åŸæœ¬çš„é‚è¼¯è™•ç† (è§£æã€è¨ˆç®—ã€å ±è¡¨ç”Ÿæˆ)ï¼Œé™¤äº† Storage éƒ¨åˆ†è¢« Firebase å–ä»£
        
        // ç‚ºäº†è®“ Module ä¹Ÿèƒ½å‘¼å«ï¼Œå°‡è®Šæ•¸æ›åœ¨ window
        let BANK_INFO = {}; 
        let errorLog = []; 
        let bankParseErrors = []; 
        
        const DEFAULT_FILL_INFO = { bank: "è€é—†éº»ç…©è‡ªå­˜å¸³è™Ÿ", account: "æ„Ÿè¬" }; 
        const dayOrder = [1, 2, 3, 4, 5, 6, 0];
        const dayMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 0: 'æ—¥' };

        // è§£æéŠ€è¡Œè³‡è¨Š (å…¨åŸŸå¯å‘¼å«)
        window.parseBankInfo = function(input) {
            BANK_INFO = {};
            bankParseErrors = []; 
            const lines = input.split('\n');
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (trimmedLine.length === 0) return; 
                
                const parts = trimmedLine.split(/\s+/).filter(p => p.length > 0);
                if (parts.length >= 3) {
                    const name = parts[0];
                    const bank = parts[1];
                    const account = parts.slice(2).join(' '); 
                    BANK_INFO[name] = { bank: bank, account: account, isDefault: false };
                }
            });
        }

        function getBankInfo(name) {
            if (BANK_INFO[name] && !BANK_INFO[name].isDefault) {
                return { info: BANK_INFO[name], isDefault: false };
            }
            return { info: DEFAULT_FILL_INFO, isDefault: true };
        }

        window.copyBankList = function() {
            const bankArea = document.getElementById('bankInfoData');
            const bankStatusIndicator = document.getElementById('bankSaveStatus');
            navigator.clipboard.writeText(bankArea.value).then(() => {
                bankStatusIndicator.innerText = 'âœ… åå–®å·²è¤‡è£½!';
                bankStatusIndicator.style.display = 'block';
                setTimeout(() => bankStatusIndicator.style.display = 'none', 1500);
            }).catch(err => alert('è¤‡è£½å¤±æ•—'));
        }

        // ä¿®æ”¹åŸæœ¬çš„ clearDataï¼Œå¢åŠ åƒæ•¸åˆ¤æ–·
        window.clearData = function(skipConfirm = false) {
            // å¦‚æœæ˜¯æŒ‰éˆ•è§¸ç™¼çš„(æ²’æœ‰skipConfirm)ï¼Œå‰‡å‘¼å«é›²ç«¯æ¸…é™¤
            if (!skipConfirm) {
                if (window.clearCloudData) {
                    window.clearCloudData(); // è½‰äº¤çµ¦ Firebase æ¨¡çµ„è™•ç†
                }
                return;
            }

            // UI æ¸…é™¤é‚è¼¯
            document.getElementById('individualReports').innerHTML = '';
            document.getElementById('summarySection').style.display = 'none';
            document.getElementById('reportTitle').style.display = 'none';
            document.getElementById('summaryTitle').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none'; 
            document.getElementById('excelCopySection').style.display = 'none'; 
            document.getElementById('detailExcelCopySection').style.display = 'none'; 
        }

        window.copyToClipboard = function(elementId, statusId) {
            const copyText = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(copyText).then(() => {
                const statusElement = document.getElementById(statusId);
                statusElement.style.display = 'block';
                setTimeout(() => statusElement.style.display = 'none', 1500);
            });
        }
        
        function displayErrors() {
            const errorSection = document.getElementById('errorSection');
            const errorList = document.getElementById('errorList');
            if (errorLog.length > 0) {
                errorList.innerHTML = errorLog.map(err => `<li>${err}</li>`).join('');
                errorSection.style.display = 'block';
            } else {
                errorSection.style.display = 'none';
            }
        }

        window.generateReport = function() {
            const textArea = document.getElementById('inputData');
            const bankArea = document.getElementById('bankInfoData');
            
            // ç¢ºä¿éŠ€è¡Œåå–®æ˜¯æœ€æ–°çš„
            window.parseBankInfo(bankArea.value);
            errorLog = []; 
            
            const input = textArea.value;
            const lines = input.split('\n');
            const currentYear = new Date().getFullYear();
            
            const data = {}; 
            const dailyGrandTotals = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 0: 0 };
            let grandTotalAll = 0;
            let hasData = false;

            lines.forEach((line, lineIndex) => {
                const parts = line.trim().split(/\s+/).filter(p => p.length > 0);
                if (parts.length === 0) return;

                const lineNum = lineIndex + 1;
                const dateStr = parts[0];
                
                try {
                    const dateObj = new Date(`${currentYear}/${dateStr}`);
                    if (isNaN(dateObj.getTime())) {
                        errorLog.push(`æ¥­ç¸¾è¼¸å…¥å€ ç¬¬ ${lineNum} è¡Œ: æ—¥æœŸè§£æéŒ¯èª¤ ('${dateStr}')`);
                        return;
                    }

                    let dayIndex = dateObj.getDay(); 
                    
                    for (let i = 1; i < parts.length; i++) {
                        const token = parts[i];
                        const match = token.match(/^([^\d]+)([\d\.]+)$/);

                        if (match) {
                            const name = match[1];
                            const val = parseFloat(match[2]);

                            if (!data[name]) {
                                data[name] = { 0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[] };
                            }
                            
                            data[name][dayIndex].push(val);
                            dailyGrandTotals[dayIndex] += val;
                            grandTotalAll += val;
                            hasData = true;
                        } else {
                            errorLog.push(`æ¥­ç¸¾è¼¸å…¥å€ ç¬¬ ${lineNum} è¡Œ: æ¥­ç¸¾æ•¸å€¼è§£æéŒ¯èª¤ ('${token}')`);
                        }
                    }
                } catch (e) {
                    errorLog.push(`æ¥­ç¸¾è¼¸å…¥å€ ç¬¬ ${lineNum} è¡Œ: ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ (${e.message})`);
                }
            });
            
            const reportContainer = document.getElementById('individualReports');
            reportContainer.innerHTML = '';
            
            let excelCopyData = []; 
            let detailExcelData = []; 
            
            const detailHeader = [
                "å§“å", "ç¸½æ¥­ç¸¾åˆ†", "æ‡‰ä»˜é‡‘é¡", 
                "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"
            ].join('\t');
            detailExcelData.push(detailHeader);

            if (hasData) {
                document.getElementById('reportTitle').style.display = 'block';

                Object.keys(data).forEach(name => {
                    let personTotal = 0; 
                    let dailyDetailStrings = []; 
                    
                    dayOrder.forEach(dayIdx => {
                        const vals = data[name][dayIdx];
                        const subTotal = vals.reduce((a, b) => a + b, 0);
                        personTotal += subTotal;
                        const detailStr = vals.join('ã€€');
                        dailyDetailStrings.push(detailStr); 
                    });
                    
                    const finalAmount = personTotal * 100;
                    const formattedAmount = finalAmount.toLocaleString('en-US'); 
                    
                    const { info: { bank, account }, isDefault } = getBankInfo(name); 
                    
                    const copyTextId = `copyText_${name}`;
                    const copyStatusId = `copyStatus_${name}`;
                    const copyTextContent = `${name} $${formattedAmount} ${name}-${bank}-${account}`;

                    excelCopyData.push([name, personTotal, finalAmount, bank, account].join('\t')); 
                    detailExcelData.push([name, personTotal, finalAmount, ...dailyDetailStrings].join('\t'));
                    
                    const cardClass = isDefault ? 'person-card card-warning-border' : 'person-card';

                    let personHTML = `
                        <div class="${cardClass}">
                            <div class="card-header">${name}${isDefault ? ' (âš ï¸ è‡ªå­˜æé†’)' : ''}</div>
                            <table>
                    `;
                    
                    dayOrder.forEach(dayIdx => {
                        const vals = data[name][dayIdx];
                        const dayLabel = dayMap[dayIdx];
                        const detailStr = vals.join('    '); 
                        const subTotal = vals.reduce((a, b) => a + b, 0);

                        personHTML += `
                            <tr>
                                <td class="col-day">${dayLabel}</td>
                                <td class="col-data">${detailStr}</td>
                                <td class="col-subtotal">${subTotal === 0 ? '' : subTotal}</td>
                            </tr>
                        `;
                    });

                    personHTML += `
                            <tr>
                                <td colspan="2" style="text-align:right; font-weight:bold;">ç¸½æ¥­ç¸¾/æ‡‰ä»˜é‡‘é¡</td>
                                <td class="total-cell">${personTotal} / $${formattedAmount}</td>
                            </tr>
                        </table>
                        
                        <div class="copy-info-section">
                            <p style="font-size:0.9em; margin: 0 0 5px 0;">é»æ“Šä¸‹æ–¹å€å¡Šå³å¯è¤‡è£½ï¼š</p>
                            <div class="copy-box" id="${copyTextId}_container" onclick="copyToClipboard('${copyTextId}', '${copyStatusId}')">
                                <span id="${copyTextId}">${copyTextContent}</span>
                                <span id="${copyStatusId}" class="copy-status">âœ… å·²è¤‡è£½!</span>
                            </div>
                        </div>
                        </div>
                    `;
                    reportContainer.innerHTML += personHTML;
                });

                const summaryBody = document.getElementById('summaryBody');
                document.getElementById('summarySection').style.display = 'block';
                document.getElementById('summaryTitle').style.display = 'block';
                
                let summaryHTML = '';
                dayOrder.forEach(dayIdx => {
                    summaryHTML += `<tr><td>${dayMap[dayIdx]}</td><td>${dailyGrandTotals[dayIdx]}</td></tr>`;
                });
                summaryHTML += `<tr class="summary-total-row"><td>åˆè¨ˆ</td><td>${grandTotalAll}</td></tr>`;
                summaryBody.innerHTML = summaryHTML;
                
                detailExcelData.push(""); 
                detailExcelData.push("æ¯æ—¥åˆè¨ˆç¸½è¡¨");
                detailExcelData.push("æ—¥æœŸ\tåˆè¨ˆ");
                dayOrder.forEach(dayIdx => {
                    detailExcelData.push(`${dayMap[dayIdx]}\t${dailyGrandTotals[dayIdx]}`);
                });
                detailExcelData.push(`åˆè¨ˆ\t${grandTotalAll}`);

                const excelHeader = "å§“å\tç¸½æ¥­ç¸¾åˆ†\tæ‡‰ä»˜é‡‘é¡\téŠ€è¡Œåç¨±\téŠ€è¡Œå¸³è™Ÿ";
                const excelDataContent = excelCopyData.join('\n');
                document.getElementById('excelCopyContent').innerText = `${excelHeader}\n${excelDataContent}`;
                document.getElementById('excelCopySection').style.display = 'block';
                
                document.getElementById('detailExcelCopyContent').innerText = detailExcelData.join('\n');
                document.getElementById('detailExcelCopySection').style.display = 'block';
            } else {
                 if (input.trim().length > 0 && errorLog.length === 0) {
                     errorLog.push("æœªè§£æåˆ°ä»»ä½•æœ‰æ•ˆçš„æ¥­ç¸¾æ•¸æ“šã€‚è«‹æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                 }
                 document.getElementById('excelCopySection').style.display = 'none'; 
                 document.getElementById('detailExcelCopySection').style.display = 'none';
            }
            displayErrors();
        }
    </script>
</body>
</html>