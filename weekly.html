<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æ¥­ç¸¾è¨ˆç®—ç³»çµ± (å…¨åŠŸèƒ½ä¿®å¾©ç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¤æ¨£å¼ (ä¿ç•™åŸç‰ˆé¢¨æ ¼) --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f6; margin: 0; padding: 20px; }
        h1, h2, h3 { color: #333; text-align: center; }
        
        /* --- ç‰ˆé¢é…ç½® --- */
        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 800px; margin: 0 auto 20px auto;
        }
        .mode-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .mode-local { background-color: #e2e3e5; color: #383d41; }
        .mode-cloud { background-color: #d4edda; color: #155724; }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; }
        .settings-btn:hover { transform: rotate(45deg); transition: 0.3s; }

        /* --- è¼¸å…¥å€å¡Š --- */
        .input-section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto 30px auto; position: relative; }
        .status-indicator { position: absolute; top: 20px; right: 20px; font-size: 12px; color: #28a745; display: none; }
        textarea, input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; line-height: 1.5; }
        
        /* --- æŒ‰éˆ• (åŸç‰ˆé…è‰²) --- */
        .btn-group { display: flex; gap: 10px; }
        button { border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s; color: white;}
        .btn-calc { background-color: #007bff; flex: 2; }
        .btn-calc:hover { background-color: #0056b3; }
        .btn-clear { background-color: #dc3545; flex: 1; } 
        .btn-action { background-color: #17a2b8; width: 100%; }
        .btn-save { background-color: #28a745; width: 100%; margin-top: 10px; }
        .btn-export { background-color: #28a745; flex: 1.5; }
        
        .btn-copy-bill {
            background-color: #6610f2; width: 100%; margin-top: 10px; font-size: 14px; padding: 8px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-copy-bill:hover { background-color: #520dc2; }

        /* --- å ±è¡¨èˆ‡å¡ç‰‡ (æ‰¾å›é»ƒè‰²æ¨™é¡Œ) --- */
        .report-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .person-card { background: white; border: 1px solid #ddd; width: 350px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; transition: 0.3s;}
        
        /* ç¼ºå¸³è™Ÿæ¨£å¼ */
        .person-card.missing-account { border: 3px solid #dc3545; box-shadow: 0 0 10px rgba(220, 53, 69, 0.3); }
        .person-card.missing-account .card-header { background-color: #dc3545; color: white; }
        .missing-msg { color: #dc3545; font-weight: bold; text-align: center; margin-top: 5px; font-size: 0.9em; }

        .card-header { background-color: #ffcc00; padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; text-align: center; font-size: 18px; }
        .card-body { padding: 10px; }
        
        /* å¸³è™Ÿç·¨è¼¯å€æ¨£å¼ */
        .account-display { margin-top: 10px; padding: 5px; border-top: 1px dashed #ccc; font-size: 0.9em; color: #555; display: flex; justify-content: space-between; align-items: center; }
        .edit-area { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #dee2e6; }
        .edit-area input { margin-bottom: 5px; font-size: 14px; padding: 5px; }
        .btn-icon { background: none; border: none; color: #007bff; cursor: pointer; padding: 0 5px; font-size: 1.2em; }
        .btn-icon:hover { color: #0056b3; transform: scale(1.1); }
        .btn-sm-save { background-color: #28a745; padding: 5px 10px; font-size: 14px; width: 100%; margin-top: 5px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        .col-day { background-color: #fff8e1; width: 40px; font-weight: bold; }
        .col-data { background-color: #f8f8ff; text-align: left; padding-left: 15px; }
        .col-subtotal { background-color: #f0f0ff; width: 50px; }
        .total-cell { background-color: #c0392b; color: white; font-weight: bold; text-align: center; font-size: 18px; }
        
        /* --- åˆè¨ˆè¡¨ --- */
        .summary-section { max-width: 300px; margin: 40px auto; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .summary-total-row td { background-color: #e0e0e0; font-weight: bold; color: #c0392b; }

        /* --- å¸³æˆ¶æ¸…å–® --- */
        .account-reference-container { display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; gap: 20px; }
        .bank-category { padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .bank-category h3 { color: #17a2b8; border-bottom: 2px solid #17a2b8; padding-bottom: 5px; margin-top: 0; text-align: left; }
        .account-table th { background-color: #e0f7fa; font-weight: bold; }

        /* --- Modals (åŒ…å«è¡çªè¦–çª—) --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        
        /* è¡çªè¦–çª—æ¨£å¼ */
        .conflict-item { border: 1px solid #ffc107; background: #fff3cd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .conflict-options { display: flex; gap: 5px; margin-top: 5px; }
        .conflict-options button { padding: 5px 10px; font-size: 14px; flex: 1; cursor: pointer;}
        .btn-keep { background-color: #28a745; border:none; color:white; border-radius:4px;}
        .btn-keep-all { background-color: #17a2b8; border:none; color:white; border-radius:4px;}

        /* --- Toast é€šçŸ¥ --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 2px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="header-bar">
        <span id="systemModeBadge" class="mode-badge mode-local">ğŸ“¡ å–®æ©Ÿæ¨¡å¼</span>
        <button class="settings-btn" id="openSettingsBtn" title="ç³»çµ±è¨­å®š">âš™ï¸</button>
    </div>

    <h1>ğŸ“Š æ¥­ç¸¾è¨ˆç®—ç³»çµ± (ä¿®å¾©ç‰ˆ)</h1>

    <!-- è¨­å®š Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>âš™ï¸ é›²ç«¯è¨­å®š</h2>
            <p>è‹¥éœ€è·¨è£ç½®åŒæ­¥ï¼Œè«‹è¨­å®š Firebase Configã€‚</p>
            <textarea id="cfgFirebase" rows="6" placeholder='{"apiKey": "...", ...}' style="width:100%"></textarea>
            <button class="btn-save" id="saveSettingsBtn">ğŸ’¾ å„²å­˜ä¸¦é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

    <!-- è¡çªè§£æ±º Modal (é€™æ˜¯ä½ è¦çš„åŠŸèƒ½!) -->
    <div id="conflictModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #d39e00;">âš ï¸ ç™¼ç¾å¸³æˆ¶åç¨±é‡è¤‡</h2>
            <p>ç³»çµ±æª¢æ¸¬åˆ°ä»¥ä¸‹åç¨±æœ‰é‡è¤‡è³‡æ–™ï¼Œè«‹é¸æ“‡æ‚¨è¦ä¿ç•™çš„è³‡æ–™ï¼š</p>
            <div id="conflictList"></div>
            <button class="btn-clear" onclick="document.getElementById('conflictModal').style.display='none'" style="margin-top:20px; background:#6c757d; width:100%;">å–æ¶ˆæ›´æ–°</button>
        </div>
    </div>

    <div class="input-section">
        <span id="saveStatus" class="status-indicator">âœ… å·²å„²å­˜</span>
        <h3>ğŸ“ æ¥­ç¸¾è³‡æ–™è²¼ä¸Šå€</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">æ ¼å¼ç¯„ä¾‹ï¼š11/17 å§šè²´13 èŠ±ç”°6</p>
        <textarea id="inputData" rows="8" style="height: 150px;"></textarea>
        
        <div class="btn-group">
            <button class="btn-calc" id="calculateButton">ğŸ”„ é‡æ–°è¨ˆç®—å ±è¡¨</button>
            <button class="btn-export" id="exportExcelBtn">ğŸ“¥ åŒ¯å‡º Excel</button>
            <button class="btn-clear" id="clearButton">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <!-- å°å¸³å–®è¨­å®š (ä¿ç•™ä½ çš„æ¨£å¼) -->
    <div class="input-section" style="border-top: 5px solid #6610f2;">
        <h3>âš™ï¸ å°å¸³å–®å…§å®¹è¨­å®š</h3>
        <div>
            <label>å°å¸³å–®æ—¥æœŸå€é–“ï¼š</label>
            <input type="text" id="billDateRangeInput" placeholder="ä¾‹å¦‚: 11/24 - 11/29">
        </div>
        <div>
            <label>è­¦èªèˆ‡æ³¨æ„äº‹é …ï¼š</label>
            <textarea id="billWarningTemplate" rows="5">ğŸš¨ è«‹å‹™å¿…æ ¸å°è³‡è¨Š
* ç¸½é‡‘é¡ï¼š è«‹æ ¸å¯¦æœ€ä¸Šæ–¹ç¸½é‡‘é¡ã€‚
* é è¨ˆå…¥æ¬¾ï¼š é€±ä¸€å­˜å…¥ã€‚
* é¢¨éšªè²æ˜ï¼š åŒ¯éŒ¯ä¸è£œï¼Œè«‹ä»”ç´°ç¢ºèªã€‚</textarea>
        </div>
        <button class="btn-action" id="saveBillConfigBtn">ğŸ’¾ å„²å­˜è¨­å®š (è‡ªå‹•ç”Ÿæ•ˆ)</button>
    </div>

    <h2 id="reportTitle" style="display:none;">å€‹äººé€±å ±è¡¨</h2>
    <div id="individualReports" class="report-container"></div>

    <h2 id="summaryTitle" style="display:none;">æ¯æ—¥åˆè¨ˆç¸½è¡¨</h2>
    <div id="summarySection" class="summary-section" style="display:none;">
        <table class="summary-table">
            <thead><tr><th>æ˜ŸæœŸ</th><th>åˆè¨ˆ</th></tr></thead>
            <tbody id="summaryBody"></tbody>
        </table>
    </div>

    <!-- å¸³æˆ¶æ¸…å–®ç®¡ç† (ä¿ç•™ä½ çš„æŒ‰éˆ•è·Ÿé‚è¼¯) -->
    <div class="input-section" style="margin-top: 40px;">
        <span id="accountStatus" class="status-indicator" style="color: #17a2b8;">âœ… å¸³æˆ¶å·²æ›´æ–°</span>
        <h3>ğŸ¦ éŠ€è¡Œå¸³æˆ¶æ¸…å–®ç®¡ç†</h3>
        <p style="color: #666; font-size: 0.9em; margin-top:-10px;">
            æ›´æ–°æ™‚ç³»çµ±æœƒè‡ªå‹•æ ¼å¼åŒ–ã€‚æ”¯æ´: `åç¨± 822 123456` æˆ– `åç¨± ä¸­ä¿¡ ...`
        </p>
        <textarea id="accountInputData" rows="6" placeholder="è²¼ä¸Šæ‚¨çš„å¸³æˆ¶æ¸…å–®æ–‡å­—..."></textarea>
        <div class="btn-group">
            <button class="btn-action" id="uploadAccountListButton">â¬†ï¸ æ›´æ–°èˆ‡æ•´ç†å¸³æˆ¶æ¸…å–®</button>
            <button class="btn-clear" id="clearAccountListButton">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>
    
    <h2 id="referenceTitle" style="display:none;">éŠ€è¡Œå¸³æˆ¶åƒè€ƒæ¸…å–®</h2>
    <div id="accountReferenceList" class="account-reference-container"></div>

    <div id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // --- å…¨åŸŸè®Šæ•¸ ---
        let db = null;
        let isCloudMode = false;
        let localAccounts = []; // [ {name, bankName, account}, ... ]
        
        const STORAGE_KEYS = {
            SETTINGS: 'weekly_app_settings',
            DATA: 'weekly_local_sales_data',
            ACC: 'weekly_local_account_data',
            BILL: 'weekly_bill_config'
        };

        const DAY_MAP = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 0: 'æ—¥' };
        const DAY_ORDER = [1, 2, 3, 4, 5, 6, 0];
        const DEFAULT_APP_ID = 'universal-app';

        // éŠ€è¡Œä»£ç¢¼èˆ‡é—œéµå­—å°ç…§ (ä¾›è‡ªå‹•è¾¨è­˜ç”¨)
        const BANK_CODE_MAP = {
            "822": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—", "013": "ğŸ¦ åœ‹æ³°ä¸–è¯", "812": "ğŸ’³ å°æ–°éŠ€è¡Œ",
            "808": "â›°ï¸ ç‰å±±éŠ€è¡Œ", "012": "ğŸ’³ å°åŒ—å¯Œé‚¦", "700": "ğŸ“® ä¸­è¯éƒµæ”¿"
        };
        const BANK_KEYWORDS = {
            "åœ‹æ³°": "ğŸ¦ åœ‹æ³°ä¸–è¯", "ä¸–è¯": "ğŸ¦ åœ‹æ³°ä¸–è¯", "013": "ğŸ¦ åœ‹æ³°ä¸–è¯",
            "å°æ–°": "ğŸ’³ å°æ–°éŠ€è¡Œ", "812": "ğŸ’³ å°æ–°éŠ€è¡Œ",
            "ä¸­ä¿¡": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—", "ä¸­åœ‹ä¿¡è¨—": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—", "822": "ğŸ‡¨ğŸ‡¹ ä¸­åœ‹ä¿¡è¨—",
            "ç‰å±±": "â›°ï¸ ç‰å±±éŠ€è¡Œ", "808": "â›°ï¸ ç‰å±±éŠ€è¡Œ",
            "å¯Œé‚¦": "ğŸ’³ å°åŒ—å¯Œé‚¦", "012": "ğŸ’³ å°åŒ—å¯Œé‚¦",
            "éƒµå±€": "ğŸ“® ä¸­è¯éƒµæ”¿", "700": "ğŸ“® ä¸­è¯éƒµæ”¿"
        };
        const DEFAULT_BANK_CATEGORY = "ğŸ›ï¸ å…¶ä»–éŠ€è¡Œ";

        // --- DOM ---
        const $ = id => document.getElementById(id);

        // --- 1. å„ªåŒ–å·¥å…·: Debounce (é˜²ç•¶æ©Ÿ) ---
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- 2. æ ¸å¿ƒ: éŠ€è¡Œåç¨±è¾¨è­˜å·¥å…· (æ–°) ---
        function detectBankName(input) {
            const raw = input.trim();
            // æª¢æŸ¥ä»£ç¢¼ (å¦‚ "822")
            if (BANK_CODE_MAP[raw]) return BANK_CODE_MAP[raw];
            // æª¢æŸ¥é—œéµå­— (å¦‚ "ä¸­ä¿¡")
            for (const k in BANK_KEYWORDS) {
                if (raw.includes(k)) return BANK_KEYWORDS[k];
            }
            return raw || DEFAULT_BANK_CATEGORY;
        }

        // --- 3. æ ¸å¿ƒ: å¸³æˆ¶è§£æ (å‡ç´šç‰ˆ) ---
        function parseAccountListToFlat(text) {
            const lines = text.split('\n');
            const flatList = [];
            
            lines.forEach(line => {
                let trim = line.trim();
                // å¿½ç•¥é›œè¨Š
                if (!trim || ["ç¸½é‡‘é¡", "è­¦èª", "å…¥æ¬¾", "æ³¨æ„äº‹é …"].some(k => trim.includes(k))) return;

                // åˆ‡å‰²å­—ä¸²
                let tokens = trim.split(/[\s\t:ï¼š,ï¼Œ]+/);
                let bestAccount = "", bestBank = "", nameParts = [];

                tokens.forEach(token => {
                    const rawDigits = token.replace(/[^\d]/g, '');
                    // æŠ“æœ€é•·çš„æ•¸å­—ç•¶å¸³è™Ÿ
                    if (rawDigits.length > 5 && !token.includes("é›»è©±")) {
                        if (rawDigits.length > (bestAccount.replace(/[^\d]/g, '').length)) {
                            bestAccount = rawDigits;
                        } else {
                            nameParts.push(token); // èˆŠçš„å¯èƒ½æ˜¯åå­—é›œè¨Š
                        }
                    } else if (BANK_CODE_MAP[rawDigits] && rawDigits.length === 3) {
                        bestBank = BANK_CODE_MAP[rawDigits];
                    } else {
                        let isBank = false;
                        for (const k in BANK_KEYWORDS) {
                            if (token.includes(k)) { bestBank = BANK_KEYWORDS[k]; isBank = true; break; }
                        }
                        if (!isBank) nameParts.push(token);
                    }
                });

                if (bestAccount) {
                    const formattedAcc = bestAccount.replace(/(.{4})/g, '$1-').replace(/-$/, '');
                    const rawName = nameParts.join(' ').replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim();
                    const finalBank = bestBank || DEFAULT_BANK_CATEGORY;
                    if (rawName) flatList.push({ name: rawName, bankName: finalBank, account: formattedAcc });
                }
            });
            return flatList;
        }

        // --- 4. æ ¸å¿ƒ: æ¥­ç¸¾è¨ˆç®— ---
        function parseAndCalculate(input) {
            const lines = input.split('\n');
            const currentYear = new Date().getFullYear();
            const personData = {};
            const dailyTotals = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0};
            let grandTotal = 0;
            let hasData = false;

            lines.forEach(line => {
                const trim = line.trim();
                if(!trim) return;
                const dateMatch = trim.match(/^(\d{4}[-/])?(\d{1,2})[-/](\d{1,2})/);
                if (!dateMatch) return;
                
                const dateObj = new Date(currentYear, parseInt(dateMatch[2])-1, parseInt(dateMatch[3]));
                if (isNaN(dateObj.getTime())) return;
                const dayIdx = dateObj.getDay();

                let content = trim.substring(dateMatch[0].length);
                const tokenRegex = /([^\d\s]+)\s*(-?[\d\.]+)/g;
                let match;
                while ((match = tokenRegex.exec(content)) !== null) {
                    const name = match[1].trim();
                    const val = parseFloat(match[2]);
                    if (!isNaN(val)) {
                        if (!personData[name]) personData[name] = { data: {0:[],1:[],2:[],3:[],4:[],5:[],6:[]}, total: 0 };
                        personData[name].data[dayIdx].push(val);
                        personData[name].total += val;
                        dailyTotals[dayIdx] += val;
                        grandTotal += val;
                        hasData = true;
                    }
                }
            });
            return { personData, dailyTotals, grandTotal, hasData };
        }

        // --- 5. è¡çªè™•ç†é‚è¼¯ ---
        function findDuplicates(flatList) {
            const nameMap = {};
            const duplicates = [];
            flatList.forEach(item => {
                const k = item.name.replace(/\s/g, "");
                if (!nameMap[k]) nameMap[k] = [];
                nameMap[k].push(item);
            });
            for (const k in nameMap) {
                const items = nameMap[k];
                const uniqueSigs = new Set(items.map(i => `${i.bankName}${i.account}`));
                if (uniqueSigs.size > 1) duplicates.push({ name: items[0].name, items: items });
            }
            return duplicates;
        }

        function handleAccountUpdate() {
            const rawText = $('accountInputData').value;
            const rawList = parseAccountListToFlat(rawText);
            const duplicates = findDuplicates(rawList);

            if (duplicates.length > 0) {
                showConflictModal(duplicates, rawList);
            } else {
                commitAccountData(rawList);
            }
        }

        function showConflictModal(duplicates, fullList) {
            const listDiv = $('conflictList');
            listDiv.innerHTML = '';
            duplicates.forEach((dup, idx) => {
                const div = document.createElement('div');
                div.className = 'conflict-item';
                let html = `<strong>${dup.name}</strong> é‡è¤‡å®šç¾©ï¼š<br>`;
                dup.items.forEach((item, i) => {
                    html += `<label><input type="radio" name="dup_${idx}" value="${i}" ${i===0?'checked':''}> ${item.bankName} (${item.account})</label><br>`;
                });
                html += `<div class="conflict-options">
                    <button class="btn-keep" onclick="window.resolveConflict(${idx}, 'one')">ä¿ç•™é¸å–</button>
                    <button class="btn-keep-all" onclick="window.resolveConflict(${idx}, 'all')">å…¨éƒ¨ä¿ç•™</button>
                </div>`;
                div.innerHTML = html;
                listDiv.appendChild(div);
            });
            window.currentConflicts = duplicates;
            window.currentFullList = fullList;
            $('conflictModal').style.display = 'block';
        }

        window.resolveConflict = function(dupIdx, method) {
            const duplicates = window.currentConflicts;
            const fullList = window.currentFullList;
            const dup = duplicates[dupIdx];
            
            let newList = fullList.filter(x => x.name.replace(/\s/g,"") !== dup.name.replace(/\s/g,""));
            
            if (method === 'one') {
                const radios = document.getElementsByName(`dup_${dupIdx}`);
                let selected = 0;
                radios.forEach(r => { if(r.checked) selected = parseInt(r.value); });
                newList.push(dup.items[selected]);
            } else {
                dup.items.forEach(i => newList.push(i));
            }

            window.currentFullList = newList;
            document.activeElement.closest('.conflict-item').remove();

            if ($('conflictList').children.length === 0) {
                $('conflictModal').style.display = 'none';
                commitAccountData(newList);
            }
        };

        function commitAccountData(list) {
            localAccounts = list;
            let text = "ğŸ’° å¸³æˆ¶æ¸…å–® (å·²æ•´ç†)\n\n";
            list.sort((a,b) => a.bankName.localeCompare(b.bankName) || a.name.localeCompare(b.name));
            list.forEach(i => text += `${i.name} ${i.bankName} ${i.account}\n`);
            
            $('accountInputData').value = text;
            saveAccountData(text, list);
            renderReferenceList(list);
            generateReport();
        }

        function renderReferenceList(list) {
            const div = $('accountReferenceList');
            div.innerHTML = '';
            $('referenceTitle').style.display = 'none';
            if(list.length === 0) return;
            
            $('referenceTitle').style.display = 'block';
            const cats = {};
            list.forEach(i => {
                if(!cats[i.bankName]) cats[i.bankName] = [];
                cats[i.bankName].push(i);
            });
            
            for (const cat in cats) {
                let rows = cats[cat].map(i => `<tr><td>${i.name}</td><td>${i.bankName}</td><td>${i.account}</td></tr>`).join('');
                div.innerHTML += `<div class="bank-category"><h3>${cat}</h3><table class="account-table"><thead><tr><th>åç¨±</th><th>éŠ€è¡Œ</th><th>å¸³è™Ÿ</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
        }

        // --- 6. å ±è¡¨æ¸²æŸ“ (æ–°å¢ç·¨è¼¯åŠŸèƒ½) ---
        function generateReport() {
            const input = $('inputData').value;
            const { personData, dailyTotals, grandTotal, hasData } = parseAndCalculate(input);
            const reportDiv = $('individualReports');
            reportDiv.innerHTML = '';
            
            $('reportTitle').style.display = hasData ? 'block' : 'none';
            $('summaryTitle').style.display = hasData ? 'block' : 'none';
            $('summarySection').style.display = hasData ? 'block' : 'none';

            if (!hasData) return;

            const billWarning = $('billWarningTemplate').value;
            const dateRange = $('billDateRangeInput').value;

            for (const name in personData) {
                const p = personData[name];
                const acc = localAccounts.find(a => a.name === name);
                const isMissing = !acc;
                
                // å®‰å…¨çš„ ID ç”¨å (å–ä»£ç©ºæ ¼)
                const safeNameId = name.replace(/\s/g, '_');
                
                let html = `<div class="person-card ${isMissing ? 'missing-account' : ''}">
                    <div class="card-header">${name}</div>
                    <div class="card-body"><table>`;
                
                DAY_ORDER.forEach(d => {
                    const arr = p.data[d];
                    const sum = arr.reduce((a,b)=>a+b, 0);
                    if(arr.length > 0 || sum !== 0) {
                        html += `<tr><td class="col-day">${DAY_MAP[d]}</td><td class="col-data">${arr.join(', ')}</td><td class="col-subtotal">${sum}</td></tr>`;
                    }
                });
                
                const finalAmt = Math.round(p.total * 100);
                html += `<tr><td colspan="2">ç¸½è¨ˆ</td><td class="total-cell">${p.total}</td></tr></table>`;

                // --- æ–°å¢ï¼šç·¨è¼¯å¸³è™Ÿå€å¡Š ---
                const bankVal = acc ? acc.bankName : '';
                const accVal = acc ? acc.account : '';
                const displayHtml = acc ? `<span>${acc.bankName} ${acc.account}</span>` : `<span class="missing-msg">âš ï¸ æœªè¨­å®šå¸³è™Ÿ</span>`;

                html += `
                <div class="account-display">
                    ${displayHtml}
                    <button class="btn-icon" onclick="window.toggleEdit('${safeNameId}')" title="ç·¨è¼¯å¸³è™Ÿ">âœï¸</button>
                </div>
                <div id="edit-area-${safeNameId}" class="edit-area" style="display:none;">
                    <input type="text" id="bank-${safeNameId}" value="${bankVal}" placeholder="éŠ€è¡Œ (ä¾‹å¦‚: 822 æˆ– ä¸­ä¿¡)">
                    <input type="text" id="acc-${safeNameId}" value="${accVal}" placeholder="å¸³è™Ÿ">
                    <button class="btn-sm-save" onclick="window.saveCardAccount('${name}', '${safeNameId}')">ğŸ’¾ å„²å­˜ä¸¦æ›´æ–°æ¸…å–®</button>
                </div>
                `;
                // -----------------------

                let copyTxt = `${name} `;
                if(dateRange) copyTxt += `(${dateRange}) `;
                copyTxt += `ç¸½é‡‘é¡ï¼š${finalAmt}\n`;
                if(acc) copyTxt += `${acc.bankName} ${acc.account}`;
                else copyTxt += `(è«‹æä¾›å¸³è™Ÿ)`;
                if(billWarning) copyTxt += `\n\n${billWarning}`;

                html += `<button class="btn-copy-bill" onclick="window.copyToClipboard(\`${encodeURIComponent(copyTxt)}\`)">ğŸ“‹ è¤‡è£½</button>`;
                html += `</div></div>`;
                reportDiv.innerHTML += html;
            }

            // Summary
            let sumHtml = '';
            DAY_ORDER.forEach(d => sumHtml += `<tr><td>${DAY_MAP[d]}</td><td>${dailyTotals[d]}</td></tr>`);
            sumHtml += `<tr class="summary-total-row"><td>ç¸½åˆè¨ˆ</td><td>${grandTotal}</td></tr>`;
            $('summaryBody').innerHTML = sumHtml;
        }

        // --- 7. æ–°åŠŸèƒ½ï¼šå–®å¡ç‰‡ç·¨è¼¯å­˜æª”é‚è¼¯ ---
        window.toggleEdit = function(safeId) {
            const el = $(`edit-area-${safeId}`);
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        };

        window.saveCardAccount = function(realName, safeId) {
            const newBankRaw = $(`bank-${safeId}`).value.trim();
            const newAccRaw = $(`acc-${safeId}`).value.trim();

            if (!newAccRaw) {
                alert("è«‹è¼¸å…¥å¸³è™Ÿï¼"); return;
            }

            // 1. è‡ªå‹•è¾¨è­˜éŠ€è¡Œ (è¼¸å…¥ "822" -> "ä¸­åœ‹ä¿¡è¨—")
            const detectedBank = detectBankName(newBankRaw);
            // 2. æ ¼å¼åŒ–å¸³è™Ÿ (ç´”æ•¸å­—è½‰æˆ 4ä½ä¸€æ’‡)
            const cleanAcc = newAccRaw.replace(/[^\d]/g, '');
            const formattedAcc = cleanAcc.length > 6 ? cleanAcc.replace(/(.{4})/g, '$1-').replace(/-$/, '') : newAccRaw;

            // 3. æ›´æ–° localAccounts (ç§»é™¤èˆŠçš„ï¼ŒåŠ å…¥æ–°çš„)
            // éæ¿¾æ‰åå­—ä¸€æ¨£çš„èˆŠè³‡æ–™
            localAccounts = localAccounts.filter(a => a.name !== realName);
            // åŠ å…¥æ–°è³‡æ–™
            localAccounts.push({
                name: realName,
                bankName: detectedBank,
                account: formattedAcc
            });

            // 4. è§¸ç™¼å…¨é¢æ›´æ–° (é€™æœƒè‡ªå‹•æ›´æ–°æ–‡å­—æ¡†ã€å­˜æª”ã€ä¸¦é‡ç¹ªç•«é¢)
            commitAccountData(localAccounts);
            alert(`å·²æ›´æ–° ${realName} çš„å¸³æˆ¶è³‡æ–™ï¼`);
        };


        // --- 8. å­˜æª”èˆ‡åˆå§‹åŒ– ---
        const saveSales = debounce((val) => {
            if(isCloudMode) setDoc(doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/sales/input`), {text: val});
            else localStorage.setItem(STORAGE_KEYS.DATA, val);
            showStatus('saveStatus');
        }, 1000);

        function saveAccountData(raw, list) {
            const data = {rawText: raw, accounts: list};
            if(isCloudMode) setDoc(doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/accounts/list`), data);
            else localStorage.setItem(STORAGE_KEYS.ACC, JSON.stringify(data));
            showStatus('accountStatus');
        }

        async function init() {
            // Load Settings
            const set = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
            $('cfgFirebase').value = set.firebaseConfig || '';
            const bill = JSON.parse(localStorage.getItem(STORAGE_KEYS.BILL) || '{}');
            if(bill.warning) $('billWarningTemplate').value = bill.warning;
            if(bill.range) $('billDateRangeInput').value = bill.range;

            if (set.firebaseConfig) {
                try {
                    const app = initializeApp(JSON.parse(set.firebaseConfig));
                    const auth = getAuth(app);
                    db = getFirestore(app);
                    await signInAnonymously(auth);
                    isCloudMode = true;
                    $('systemModeBadge').className = 'mode-badge mode-cloud';
                    $('systemModeBadge').innerText = 'â˜ï¸ é›²ç«¯åŒæ­¥æ¨¡å¼';
                    
                    onSnapshot(doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/sales/input`), s => {
                        if(s.exists() && $('inputData').value !== s.data().text) {
                            $('inputData').value = s.data().text; generateReport();
                        }
                    });
                    onSnapshot(doc(db, `artifacts/${DEFAULT_APP_ID}/public/data/accounts/list`), s => {
                        if(s.exists()) {
                            const d = s.data();
                            localAccounts = d.accounts || [];
                            $('accountInputData').value = d.rawText || '';
                            renderReferenceList(localAccounts);
                            generateReport();
                        }
                    });
                } catch(e) { console.error(e); isCloudMode=false; }
            }

            if(!isCloudMode) {
                $('inputData').value = localStorage.getItem(STORAGE_KEYS.DATA) || '';
                const acc = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACC) || '{}');
                $('accountInputData').value = acc.rawText || '';
                localAccounts = acc.accounts || [];
                renderReferenceList(localAccounts);
                generateReport();
            }
        }

        // --- UI Events ---
        $('inputData').oninput = (e) => { generateReport(); saveSales(e.target.value); };
        $('calculateButton').onclick = generateReport;
        $('clearButton').onclick = () => { if(confirm('Clear?')) { $('inputData').value=''; generateReport(); saveSales(''); } };
        
        $('uploadAccountListButton').onclick = handleAccountUpdate;
        $('clearAccountListButton').onclick = () => { if(confirm('Clear Acc?')) { $('accountInputData').value=''; localAccounts=[]; saveAccountData('',[]); renderReferenceList([]); }};

        $('saveBillConfigBtn').onclick = () => {
            const c = { warning: $('billWarningTemplate').value, range: $('billDateRangeInput').value };
            localStorage.setItem(STORAGE_KEYS.BILL, JSON.stringify(c));
            generateReport();
            alert('è¨­å®šå·²å„²å­˜');
        };

        $('exportExcelBtn').onclick = () => {
            const { personData } = parseAndCalculate($('inputData').value);
            let csv = "\uFEFFåç¨±,ç¸½é‡‘é¡,éŠ€è¡Œ,å¸³è™Ÿ\n";
            for(const name in personData) {
                const acc = localAccounts.find(a => a.name === name) || {bankName:'', account:''};
                csv += `${name},${Math.round(personData[name].total*100)},${acc.bankName},${acc.account}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'report.csv'; a.click();
        };

        $('openSettingsBtn').onclick = () => $('settingsModal').style.display = 'block';
        document.querySelector('.close').onclick = () => $('settingsModal').style.display = 'none';
        $('saveSettingsBtn').onclick = () => {
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify({firebaseConfig: $('cfgFirebase').value}));
            location.reload();
        };

        window.copyToClipboard = (encoded) => {
            const txt = decodeURIComponent(encoded);
            const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
            const t = $('toast'); t.className = 'show'; setTimeout(()=>t.className='', 3000);
        };
        
        function showStatus(id) { $(id).style.display='block'; setTimeout(()=>$(id).style.display='none', 2000); }

        init();
    </script>
</body>
</html>