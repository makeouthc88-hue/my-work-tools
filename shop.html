<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¨èƒ½é–€åº—ç®¡ç† (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- å…¨å±€åŸºç¤è¨­å®š --- */
        :root { 
            --primary-dark: #2c3e50; 
            --accent-green: #27ae60; 
            --accent-blue: #3498db; 
            --bg-light: #f4f6f9; 
            --border-color: #e0e0e0; 
            --manual-color: #e67e22; 
            --safe-top: env(safe-area-inset-top); 
            
            /* MODIFIED: å°‡ IN/OUT é¡è‰²æ”¹ç‚ºç¿ ç¶ è‰²ï¼Œä»¥å€åˆ†ç´…è‰²è¡çª */
            --in-out-color: #2ecc71; /* ç¿ ç¶ è‰² (Emerald Green) - ä»£è¡¨é †åˆ©/å®Œæˆ */
            
            /* Conflict Color (ç¶­æŒç´…è‰²ï¼Œä½œç‚ºå°æ¯”) */
            --conflict-color: #e74c3c; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-top: var(--safe-top); }
        .nav-bar { height: 44px; background: #1a252f; display: flex; align-items: center; padding: 0 10px; gap: 5px; flex-shrink: 0; z-index: 200; justify-content: space-between; }
        .app-title { color: white; font-weight: bold; font-size: 14px; white-space: nowrap; display: flex; align-items: center; gap: 5px;}
        .sync-dot { width: 8px; height: 8px; background-color: #f1c40f; border-radius: 50%; display: inline-block; } /* åŒæ­¥ç‡ˆè™Ÿ */
        .nav-buttons { display: flex; gap: 5px; }
        .tab-btn { background: rgba(255,255,255,0.1); border: none; color: #bdc3c7; padding: 6px 10px; font-size: 13px; border-radius: 6px; font-weight: bold; transition: all 0.2s; }
        .tab-btn.active { color: #fff; background: #3498db; }
        .view-container { flex: 1; position: relative; display: none; flex-direction: column; overflow: hidden; height: 100%; }
        .view-container.active { display: flex; }
        .schedule-top-bar { height: auto; min-height: 50px; background: var(--primary-dark); display: flex; flex-wrap: wrap; align-items: center; padding: 5px 10px; gap: 10px; border-bottom: 1px solid #34495e; flex-shrink: 0; color: white; }
        .info-group { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; flex: 1; }
        .date-input { background: transparent; border: none; color: #f1c40f; font-size: 18px; font-weight: bold; width: 70px; text-align: center; }
        .real-time-clock { font-size: 20px; font-weight: bold; color: #2ecc71; margin-left: auto; }
        .control-group { display: flex; gap: 10px; width: 100%; justify-content: space-between; align-items: center; }
        .action-btn { background: var(--accent-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; }
        .action-btn-reset { background: #c0392b; }
        .time-settings { display: flex; gap: 5px; font-size: 12px; color: #ecf0f1; align-items: center; }
        .time-settings input { width: 30px; text-align: center; border-radius: 4px; border: none; padding: 2px; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        .left-panel { width: 100px; min-width: 60px; max-width: 50vw; background: #eef2f3; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .left-header-bar { height: 30px; background: #dfe4ea; border-bottom: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #7f8c8d; }
        /* FIXED: éš±è—å·¦å´æ»¾å‹•æ¢ï¼Œæ”¹ç”± JS åŒæ­¥æ§åˆ¶ï¼Œé¿å…é›™é‡æ»¾å‹•æ¢ */
        .left-content { flex: 1; overflow-y: hidden; padding-bottom: 20px; }
        .staff-card { min-height: 70px; height: auto; border-bottom: 1px solid #ccc; background: #fff; padding: 4px; padding-bottom: 10px; display: flex; flex-direction: column; position: relative; flex-shrink: 0; overflow: hidden; }
        .staff-header { display: flex; align-items: center; margin-bottom: 2px; flex-shrink: 0; }
        .idx-badge { background: #34495e; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 3px; flex-shrink: 0; }
        .staff-name { flex: 1; border: none; border-bottom: 1px solid #f39c12; font-size: 14px; font-weight: bold; width: 100%; background: transparent; border-radius: 0; min-width: 0; }
        .btn-delete { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: #ecf0f1; color: #7f8c8d; border-radius: 50%; border: none; font-size: 14px; padding: 0; }
        .schedule-text-display { width: 100%; min-height: 0; flex: 1; border: 1px solid #ddd; font-size: 11px; padding: 4px; background: #fafafa; border-radius: 4px; white-space: pre-wrap; cursor: pointer; color: #2c3e50; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; }
        .col-resizer { width: 12px; background: #bdc3c7; cursor: col-resize; display: flex; align-items: center; justify-content: center; z-index: 60; flex-shrink: 0; border-left: 1px solid #95a5a6; border-right: 1px solid #95a5a6; }
        .col-resizer::after { content: "||"; color: #ecf0f1; font-size: 8px; font-weight: bold; }
        .row-resizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; cursor: row-resize; z-index: 10; display: flex; justify-content: center; align-items: flex-end; }
        .row-resizer::after { content: ""; display: block; width: 20px; height: 3px; border-top: 1px solid #bdc3c7; border-bottom: 1px solid #bdc3c7; margin-bottom: 2px; }
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fcfcfc; }
        .ruler-container { height: 30px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; overflow: hidden; flex-shrink: 0; position: relative; }
        .tracks-scroll-area { flex: 1; overflow: auto; padding-top: 0; position: relative; }
        .tracks-wrapper { position: relative; min-width: 100%; min-height: 100%; }
        .grid-lines { position: absolute; top: 0; left: 0; height: 100%; width: 100%; pointer-events: none; }
        .v-line { position: absolute; top: 0; height: 100%; border-left: 1px dashed #e0e0e0; }
        .track-row { min-height: 70px; height: auto; border-bottom: 1px solid #e0e0e0; position: relative; box-sizing: border-box; }
        .hour-mark { position: absolute; top: 0; height: 100%; border-left: 1px solid #bdc3c7; padding-left: 2px; font-size: 10px; color: #555; line-height: 30px; }
        .block { position: absolute; top: 4px; bottom: 4px; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2px 4px; font-size: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); white-space: normal; overflow: hidden; word-wrap: break-word; line-height: 1.2; cursor: pointer; z-index: 1; } 
        .type-work { background: #3498db; color: white; border: 1px solid #2980b9; z-index: 2; font-weight: bold; }
        .type-free { background: #d4efdf; color: #1e8449; border: 1px dashed #2ecc71; height: 24px; top: 50%; transform: translateY(-50%); opacity: 0.95; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; line-height: 1.1; }
        .type-conflict { background: var(--conflict-color); color: white; z-index: 3; }
        .current-time-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #e74c3c; z-index: 40; pointer-events: none; display: none; }
        
        /* IN/OUT è¦–è¦ºæç¤º */
        /* åŸå§‹çš„é‚Šæ¡†/é™°å½±æç¤º (æ­£åœ¨é€²è¡Œä¸­) */
        .block[data-in-time]:not([data-out-time]) {
            box-shadow: 0 0 10px 3px var(--in-out-color); /* ç¿ ç¶ è‰²é™°å½± */
            border: 1px solid var(--in-out-color);
        }
        /* åŸå§‹çš„é‚Šæ¡†/é™°å½±æç¤º (å·²å®Œæˆ) */
        .block[data-in-time][data-out-time] {
            border: 2px solid var(--in-out-color); /* ç¿ ç¶ è‰²é‚Šæ¡† */
            box-shadow: none;
        }

        /* NEW: åŠå¡Šé¡è‰²æ¸²æŸ“ */
        .block::before,
        .block::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0; 
            transition: width 0.3s ease-in-out;
            z-index: -1; /* æ”¾åœ¨æ–‡å­—ä¸‹å±¤ */
            border-radius: 4px;
        }

        /* 1. IN - å·¦å´åŠå¡Š (ç¿ ç¶ è‰²) */
        .block[data-in-time]::before {
            left: 0;
            background: var(--in-out-color); 
            width: 50%; /* å·¦åŠéƒ¨ */
        }
        
        /* 2. OUT - å³å´åŠå¡Š (ç¿ ç¶ è‰²) */
        .block[data-out-time]::after {
            right: 0;
            background: var(--in-out-color); 
            width: 50%; /* å³åŠéƒ¨ */
        }
        
        /* Modal - IN/OUT Time Tracker Styles */
        #timeModal .time-input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        #timeModal .time-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        #timeModal .time-item:last-child { border-bottom: none; }
        #timeModal .time-label { font-weight: bold; color: #2c3e50; font-size: 15px; }
        /* NEW: Input æ¨£å¼ */
        #timeModal .time-display { 
            font-size: 18px; 
            font-weight: bold; 
            color: var(--accent-blue); 
            width: 80px; 
            text-align: right; 
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            min-height: 28px;
        }
        #timeModal .btn-record { background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        
        /* Modal - General Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px; }
        .modal-title { font-weight: bold; font-size: 16px; color: #2c3e50; text-align: center; }
        .modal-textarea { width: 100%; height: 200px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; resize: none; font-family: monospace; }
        .modal-btns { display: flex; gap: 10px; justify-content: space-between; margin-top: 5px; } 
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; } 
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-save { background: #2ecc71; color: white; }

        /* æ—¥çµ (æ¨£å¼èˆ‡ä¹‹å‰ç‰ˆæœ¬ä¸€è‡´) */
        .settle-container { width: 100%; padding: 10px; overflow-y: auto; height: 100%; padding-bottom: 80px; }
        .config-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .config-panel { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .config-panel h3 { margin: 0 0 8px 0; color: #007bff; font-size: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .setting-item { background: #f8f9fa; padding: 4px 8px; border-radius: 6px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .setting-item label { font-size: 11px; color: #666; font-weight: bold; margin-right: 5px; }
        .setting-item input { width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-size: 13px; }
        .service-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .service-row { display: flex; align-items: center; gap: 3px; background: #fff3cd; padding: 4px 8px; border-radius: 15px; border: 1px solid #ffeeba; }
        .service-row input[type="text"] { width: 50px; border: none; background: transparent; font-weight: bold; color: #856404; text-align: center; font-size: 13px; }
        .service-row input[type="number"] { width: 45px; border: 1px solid #ddd; border-radius: 4px; padding: 2px; text-align: right; font-size: 13px; }
        .middle-section { margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .summary-area { display: flex; gap: 10px; min-width: 100%; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 10px; min-width: 80px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card h4 { margin: 0 0 5px 0; font-size: 11px; color: #888; white-space: nowrap; }
        .card p { margin: 0; font-size: 18px; font-weight: 800; color: #333; }
        .text-green { color: #28a745 !important; }
        .text-red { color: #dc3545 !important; }
        .text-blue { color: #007bff !important; }
        .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
        .table-scroll { overflow-x: auto; max-height: 50vh; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead th { position: sticky; top: 0; background-color: #343a40; color: white; padding: 8px; text-align: center; font-size: 12px; z-index: 10; white-space: nowrap; }
        .staff-footer td { padding: 8px 4px; border-top: 2px solid #3498db; background-color: #ecf0f1; font-size: 13px; font-weight: bold; text-align: center; }
        tbody td { padding: 6px 4px; border-bottom: 1px solid #eee; font-size: 13px; text-align: center; vertical-align: middle; }
        .group-header { background-color: #e9ecef; }
        .group-header td { padding: 8px; font-size: 14px; text-align: left; font-weight: bold; }
        td[contenteditable] { min-width: 40px; padding: 8px 2px; }
        td[contenteditable]:focus { background: #fff; outline: 2px solid var(--accent-blue); }
        .manual-edit { color: var(--manual-color) !important; font-weight: bold; }
        .btn-circle { border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border: none; color: white; font-weight: bold; font-size: 16px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
    </style>
</head>
<body>

<nav class="nav-bar">
    <div class="app-title">ğŸ¢ é–€åº—ç®¡ç† <span class="sync-dot" id="syncStatus"></span></div>
    <div class="nav-buttons">
        <button class="tab-btn active" onclick="switchTab('schedule')">æ’ç­</button>
        <button class="tab-btn" onclick="switchTab('settle')">æ—¥çµ</button>
    </div>
</nav>

<div id="view-schedule" class="view-container active">
    <div class="schedule-top-bar">
        <div class="info-group">
            <span style="font-size:12px; color:#aaa;">DATE</span>
            <input type="text" class="date-input" id="dateInput" value="11/22" onchange="saveScheduleData()" enterkeyhint="done">
            <div class="real-time-clock" id="topClock">00:00</div>
        </div>
        <div class="control-group">
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="addStaff()">+äººå“¡</button>
                <button class="action-btn action-btn-reset" onclick="resetSchedule()">æ¸…ç©º</button>
            </div>
            <div class="time-settings">
                <span>é–‹</span><input type="number" id="openHour" value="12" onchange="renderScheduleAll()">
                <span>é–‰</span><input type="number" id="closeHour" value="29" onchange="renderScheduleAll()">
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="left-panel" id="leftPanel">
            <div class="left-header-bar">äººå“¡</div>
            <div class="left-content" id="leftContent"></div>
        </div>

        <div class="col-resizer" id="colResizer"></div>

        <div class="right-panel">
            <div class="ruler-container" id="rulerContainer">
                <div id="ruler" style="height:100%; position:relative;"></div>
            </div>
            <div class="tracks-scroll-area" id="rightContent">
                <div class="tracks-wrapper" id="trackContainer">
                    <div class="grid-lines" id="gridBg"></div>
                    <div id="currentTimeLine" class="current-time-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-settle" class="view-container">
    <div class="settle-container">
        <div class="middle-section">
            <div class="summary-area">
                <div class="card"><h4>ç¸½ç‡Ÿæ”¶</h4><p id="total_revenue" class="text-green">0</p></div>
                <div class="card"><h4>é˜¿å§¨</h4><p id="total_aunt">0</p></div>
                <div class="card"><h4>å°å§</h4><p id="total_commission" class="text-red">0</p></div>
                <div class="card"><h4>å…¬å¸</h4><p id="total_balance" class="text-blue">0</p></div>
                <div class="card"><h4>å·¥æ•¸</h4><p id="total_work">0</p></div>
            </div>
        </div>
        <div class="config-section">
            <div class="config-panel">
                <h3>ğŸ’° åº•è–ªåƒæ•¸ (é»æ“Šä¿®æ”¹)</h3>
                <div class="settings-grid">
                    <div class="setting-item"><label>40åˆ†/1</label><input type="number" id="base_40_1" value="1100" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>60åˆ†/1</label><input type="number" id="base_60_1" value="1400" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>60åˆ†/2</label><input type="number" id="base_60_2" value="1900" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>120åˆ†/3</label><input type="number" id="base_120_3" value="2800" oninput="renderSettlementTable()"></div>
                    <input type="hidden" id="cost_40_1" value="2300">
                    <input type="hidden" id="cost_60_1" value="2700">
                    <input type="hidden" id="cost_60_2" value="3300">
                    <input type="hidden" id="cost_120_3" value="4800">
                </div>
            </div>
            <div class="config-panel">
                <h3>âœ¨ åŠ å€¼æœå‹™ <button class="btn-circle btn-green" onclick="addServiceRow()" style="width:24px; height:24px;">+</button></h3>
                <div id="service_container" class="service-list"></div>
            </div>
        </div>
        <div class="table-container">
            <div class="table-scroll">
                <table id="settleTable">
                    <thead>
                        <tr>
                            <th width="25%">å…§å®¹</th>
                            <th width="10%">åŠ å€¼</th>
                            <th width="10%">åº•è–ª</th>
                            <th width="12%">é˜¿å§¨</th>
                            <th width="12%">ç¸½æ”¶</th>
                            <th width="12%">å¯¦æ‹¿</th>
                            <th width="12%">çµé¤˜</th>
                            <th width="8%">å·¥</th>
                        </tr>
                    </thead>
                    <tbody id="table_body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ç­è¡¨ç·¨è¼¯ Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ç·¨è¼¯ç­è¡¨</div>
        <textarea id="modalTextarea" class="modal-textarea" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´ç­è¡¨..."></textarea>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="modal-btn btn-save" onclick="saveModalData()">ç¢ºå®šå„²å­˜</button>
        </div>
    </div>
</div>

<!-- NEW: IN/OUT Time Tracker Modal -->
<div id="timeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title" id="timeModalTitle">è¨˜éŒ„æœå‹™æ™‚é–“ (å¯æ‰‹å‹•ä¿®æ”¹)</div>
        
        <div class="time-input-group">
            <div class="time-item">
                <div class="time-label">é ç´„æ™‚æ®µï¼š</div>
                <div class="time-display" id="scheduledTime">--:-- - --:--</div>
            </div>
            <div class="time-item">
                <div class="time-label">å¯¦éš›é€²å ´ (IN)ï¼š</div>
                <!-- CHANGED to input for manual edit -->
                <input type="text" class="time-display" id="inTimeInput" placeholder="--:--" inputmode="numeric" pattern="\d{2}:\d{2}">
                <!-- CHANGED button to fill current time -->
                <button class="btn-record" onclick="fillCurrentTime('in')">ç•¶å‰æ™‚é–“ IN</button>
            </div>
            <div class="time-item">
                <div class="time-label">å¯¦éš›é›¢å ´ (OUT)ï¼š</div>
                <!-- CHANGED to input for manual edit -->
                <input type="text" class="time-display" id="outTimeInput" placeholder="--:--" inputmode="numeric" pattern="\d{2}:\d{2}">
                <!-- CHANGED button to fill current time -->
                <button class="btn-record" onclick="fillCurrentTime('out')">ç•¶å‰æ™‚é–“ OUT</button>
            </div>
        </div>
        
        <!-- MODIFIED buttons layout for 3 buttons -->
        <div class="modal-btns" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <!-- New: Clear Button -->
            <button class="modal-btn" style="background: #e74c3c; color: white;" onclick="clearManualTime()">æ¸…ç©ºæ™‚é–“</button>
            <button class="modal-btn btn-cancel" onclick="closeTimeModal()">é—œé–‰</button>
            <button class="modal-btn btn-save" onclick="saveManualTime()">å„²å­˜æ™‚é–“</button>
        </div>
    </div>
</div>
<!-- END NEW MODAL -->

<script>
    // === 1. Firebase è¨­å®šèˆ‡åˆå§‹åŒ– (è«‹æ³¨æ„å®‰å…¨æ€§) ===
    const firebaseConfig = {
        apiKey: "AIzaSyDsUsWuynci0DP71veuu19Ht8bJmhHSkHs", 
        authDomain: "worktools-f53e5.firebaseapp.com",
        databaseURL: "https://worktools-f53e5-default-rtdb.firebaseio.com",
        projectId: "worktools-f53e5",
        storageBucket: "worktools-f53e5.firebasestorage.app",
        messagingSenderId: "950551082090",
        appId: "1:950551082090:web:3c2c4962b5ffa044aec613",
        measurementId: "G-EKPY3SC0BR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === 2. å…¨å±€ç‹€æ…‹èˆ‡å¸¸æ•¸ ===
    const PX_PER_MIN = 2;
    // ğŸ’¡ CodeSage: staffData ç¾åœ¨å¯èƒ½åŒ…å« taskStatuses: { [taskId]: { inTime: '...', outTime: '...' } }
    let staffData = [{ id: 1, name: "å“€å“€", content: "", height: null }, { id: 2, name: "å®‰å®‰", content: "", height: null }];
    let services = [ {name: "nocon", price: 1000}, {name: "å£çˆ†", price: 500}, {name: "é¡å°„", price: 500}, {name: "å…¥ç ", price: 500} ];

    let currentEditingStaffId = null; 
    let currentTaskElement = null; // å„²å­˜ç•¶å‰é»æ“Šçš„ä»»å‹™æ–¹å¡Šå…ƒç´ 
    let currentTaskInfo = null; // { staffId, taskId }
    
    const leftContent = document.getElementById('leftContent');
    const rightContent = document.getElementById('rightContent');
    const rulerContainer = document.getElementById('rulerContainer');
    const syncStatus = document.getElementById('syncStatus');

    const WORK_UNIT_TABLE = {40: 1, 60: 1, 120: 2};
    const AUNT_EXTRA_NAMES = ["é¡åŒ", "é˜¿é³´", "æ›¼é”", "æœ‰èœ", "å§šè²´"];

    // æ‹–æ›³é‚è¼¯ (ç¶­æŒä¸è®Š)
    const colResizer = document.getElementById('colResizer');
    const leftPanel = document.getElementById('leftPanel');
    let isColDragging = false; let colStartX, colStartWidth;
    colResizer.addEventListener('touchstart', (e) => { isColDragging = true; colStartX = e.touches[0].clientX; colStartWidth = parseInt(window.getComputedStyle(leftPanel).width, 10); });
    colResizer.addEventListener('mousedown', (e) => { isColDragging = true; colStartX = e.clientX; colStartWidth = parseInt(window.getComputedStyle(leftPanel).width, 10); document.body.style.cursor = 'col-resize'; });
    let isRowDragging = false; 
    let rowStartY, rowStartHeight, draggingStaffId;
    leftContent.addEventListener('touchstart', (e) => {
        if (e.target.classList.contains('row-resizer')) {
            isRowDragging = true;
            rowStartY = e.touches[0].clientY;
            draggingStaffId = parseInt(e.target.parentElement.dataset.staffId);
            rowStartHeight = parseInt(window.getComputedStyle(e.target.parentElement).height, 10);
            e.preventDefault(); 
        }
    });
    leftContent.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('row-resizer')) {
            isRowDragging = true;
            rowStartY = e.clientY;
            draggingStaffId = parseInt(e.target.parentElement.dataset.staffId);
            rowStartHeight = parseInt(window.getComputedStyle(e.target.parentElement).height, 10);
            document.body.style.cursor = 'row-resize';
            e.preventDefault();
        }
    });
    document.addEventListener('touchmove', (e) => {
        if (isColDragging) {
            let newWidth = colStartWidth + (e.touches[0].clientX - colStartX);
            if (newWidth < 60) newWidth = 60; if (newWidth > window.innerWidth * 0.8) newWidth = window.innerWidth * 0.8;
            leftPanel.style.width = newWidth + 'px';
        }
        if (isRowDragging && draggingStaffId) {
            let deltaY = e.touches[0].clientY - rowStartY;
            let newHeight = rowStartHeight + deltaY;
            if (newHeight < 40) newHeight = 40; 
            updateRowHeight(draggingStaffId, newHeight);
        }
    }, {passive: false});
    document.addEventListener('mousemove', (e) => {
        if (isColDragging) {
            e.preventDefault();
            let newWidth = colStartWidth + (e.clientX - colStartX);
            if (newWidth < 60) newWidth = 60;
            leftPanel.style.width = newWidth + 'px';
        }
        if (isRowDragging && draggingStaffId) {
            e.preventDefault();
            let deltaY = e.clientY - rowStartY;
            let newHeight = rowStartHeight + deltaY;
            if (newHeight < 40) newHeight = 40;
            updateRowHeight(draggingStaffId, newHeight);
        }
    });
    document.addEventListener('touchend', () => { 
        if (isRowDragging && draggingStaffId) saveStaffHeight(draggingStaffId);
        isColDragging = false; isRowDragging = false; draggingStaffId = null; 
    });
    document.addEventListener('mouseup', () => { 
        if (isRowDragging && draggingStaffId) saveStaffHeight(draggingStaffId);
        isColDragging = false; isRowDragging = false; draggingStaffId = null; document.body.style.cursor = 'default'; 
    });

    // --- è¼”åŠ©å‡½å¼ (ç¶­æŒä¸è®Š) ---
    function switchTab(tabId) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId === 'schedule') btns[0].classList.add('active');
        else btns[1].classList.add('active');
        if(tabId === 'schedule') setTimeout(() => { renderScheduleAll(); }, 50);
        if(tabId === 'settle') renderSettlementTable();
    }
    function updateRowHeight(id, height) {
        const card = document.querySelector(`.staff-card[data-staff-id="${id}"]`);
        const track = document.getElementById(`track-${id}`);
        if (card) card.style.height = height + 'px';
        if (track) track.style.height = height + 'px';
    }
    function saveStaffHeight(id) {
        const card = document.querySelector(`.staff-card[data-staff-id="${id}"]`);
        if (card) {
            const h = parseInt(card.style.height);
            staffData = staffData.map(s => s.id === id ? { ...s, height: h } : s);
            saveScheduleData(); 
        }
    }
    
    // --- å”¯ä¸€ä»»å‹™ ID ç”Ÿæˆ (ç¶­æŒä¸è®Š) ---
    function getTaskHash(rawText, startMinutes) {
        const safeText = rawText.replace(/[^a-zA-Z0-9]/g, '').substring(0, 15);
        return `T${startMinutes}_${safeText}`;
    }

    // --- 3. è³‡æ–™åŒæ­¥ (Firebase) ---
    function initSchedule() {
        syncStatus.style.background = "orange";
        db.ref('shop_v7_data').on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                // FIXED: å¢åŠ è³‡æ–™è®€å–å®¹éŒ¯ã€‚å¦‚æœ Firebase å‚³å›çš„æ˜¯ç‰©ä»¶ï¼ˆå› ç‚ºé™£åˆ—ç¨€ç–ï¼‰ï¼Œå°‡å…¶è½‰æ›ç‚ºé™£åˆ—ï¼Œé¿å…ç™½ç•«é¢ã€‚
                let rawStaffData = val.staffData || [];
                if (!Array.isArray(rawStaffData) && typeof rawStaffData === 'object') {
                    rawStaffData = Object.values(rawStaffData);
                }

                // ç¢ºä¿è¼‰å…¥ staffData æ™‚ï¼Œå³ä½¿ taskStatuses éºå¤±ï¼Œä¹Ÿä¸æœƒä¸­æ–·
                staffData = rawStaffData.map(s => ({ ...s, taskStatuses: s.taskStatuses || {} }));
                
                if(val.date) document.getElementById('dateInput').value = val.date;
                if(val.services) {
                    services = val.services;
                    renderServices();
                }
                
                renderScheduleAll();
                if (document.getElementById('view-settle').classList.contains('active')) {
                    renderSettlementTable();
                }
                syncStatus.style.background = "#2ecc71";
            } else {
                saveScheduleData();
            }
        });
        setInterval(updateTimeLineAndClock, 1000);
        
        // FIXED: åŠ å…¥æ²å‹•åŒæ­¥ç›£è½ (Sync Scroll)
        // è®“å³å´æ’ç­å€æ²å‹•æ™‚ï¼Œå·¦å´äººå“¡åå–®(ä¸Šä¸‹)èˆ‡ä¸Šæ–¹æ™‚é–“å°º(å·¦å³)åŒæ­¥æ²å‹•
        if (rightContent && leftContent && rulerContainer) {
            rightContent.addEventListener('scroll', () => {
                leftContent.scrollTop = rightContent.scrollTop;
                rulerContainer.scrollLeft = rightContent.scrollLeft;
            });
        }
    }

    function saveScheduleData() {
        syncStatus.style.background = "red";
        const dataToSave = {
            // å°‡å®Œæ•´çš„ staffData (åŒ…å« taskStatuses) å­˜å…¥ Firebase
            staffData: staffData, 
            date: document.getElementById('dateInput').value,
            services: services
        };
        db.ref('shop_v7_data').set(dataToSave).then(() => {
            syncStatus.style.background = "#2ecc71";
        }).catch(error => {
            console.error("Firebase Save Error:", error);
            syncStatus.style.background = "#f1c40f";
        });
    }

    // --- 4. äººå“¡èˆ‡ç­è¡¨ç®¡ç† (ç¶­æŒä¸è®Š) ---
    function resetSchedule() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰äººå“¡å’Œå…§å®¹å—ï¼Ÿ(é›²ç«¯ä¹Ÿæœƒæ¸…ç©º)")) { 
            staffData = [{ id: Date.now(), name: "æ–°äººå“¡", content: "", height: null, taskStatuses: {} }];
            saveScheduleData(); 
        }
    }
    function addStaff() {
        // æ–°å¢äººå“¡æ™‚ï¼Œåˆå§‹åŒ– taskStatuses
        const newId = Date.now(); staffData.push({ id: newId, name: "æ–°", content: "", height: null, taskStatuses: {} });
        saveScheduleData(); renderScheduleAll();
    }
    function removeStaff(id) {
        if(confirm("åˆªé™¤æ­¤äººï¼Ÿ")) { 
            staffData = staffData.filter(s => s.id !== id); 
            saveScheduleData(); 
            renderScheduleAll(); 
        }
    }
    function updateStaffName(id, newName) {
        staffData = staffData.map(staff => 
            staff.id === id ? { ...staff, name: newName } : staff
        );
        saveScheduleData();
    }
    function openEditModal(staffId) {
        const staff = staffData.find(s => s.id === staffId); if (!staff) return;
        currentEditingStaffId = staffId;
        document.getElementById('modalTextarea').value = staff.content;
        document.getElementById('editModal').classList.add('active');
        document.getElementById('modalTextarea').focus();
    }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); currentEditingStaffId = null; }
    function saveModalData() {
        if (!currentEditingStaffId) return;
        const newContent = document.getElementById('modalTextarea').value;
        staffData = staffData.map(staff => 
            staff.id === currentEditingStaffId ? { ...staff, content: newContent } : staff
        );
        saveScheduleData(); 
        renderScheduleAll();
        closeEditModal();
    }


    // --- 5. IN/OUT æ‰“å¡/æ‰‹å‹•ç·¨è¼¯é‚è¼¯ ---

    function openTimeModal(element, staffId, taskId, content, scheduledStart, scheduledEnd) {
        currentTaskElement = element;
        currentTaskInfo = { staffId, taskId };

        document.getElementById('timeModalTitle').innerText = `è¨˜éŒ„æœå‹™æ™‚é–“: ${content.substring(0, 20)}...`;
        document.getElementById('scheduledTime').innerText = `${scheduledStart} - ${scheduledEnd}`;
        
        // è®€å–ä¸¦é¡¯ç¤ºç¾æœ‰çš„ IN/OUT æ™‚é–“åˆ°è¼¸å…¥æ¡†
        const inTime = currentTaskElement.dataset.inTime || '';
        const outTime = currentTaskElement.dataset.outTime || '';
        document.getElementById('inTimeInput').value = inTime;
        document.getElementById('outTimeInput').value = outTime;
        
        document.getElementById('timeModal').classList.add('active');
    }
    
    function closeTimeModal() {
        document.getElementById('timeModal').classList.remove('active');
        currentTaskElement = null;
        currentTaskInfo = null;
    }
    
    function getCurrentTimeDisplay() {
        const now = new Date();
        // è™•ç†è·¨å¤œæ™‚é–“ï¼Œå¦‚æœç¾åœ¨æ˜¯å‡Œæ™¨ 0é»åˆ° 11é» (å³ 24:00 - 35:00)
        let h = now.getHours();
        if (h >= 0 && h < 11) h += 24; 
        
        let m = now.getMinutes();
        return `${h < 10 ? "0"+h : h}:${m < 10 ? "0"+m : m}`;
    }
    
    // NEW: å¡«å¯«ç•¶å‰æ™‚é–“åˆ°è¼¸å…¥æ¡†
    function fillCurrentTime(type) {
        const currentTime = getCurrentTimeDisplay();
        const inputId = type === 'in' ? 'inTimeInput' : 'outTimeInput';
        document.getElementById(inputId).value = currentTime;
    }
    
    // NEW: å„²å­˜æ‰‹å‹•è¼¸å…¥/æ‰“å¡çš„æ™‚é–“
    function saveManualTime() {
        if (!currentTaskElement || !currentTaskInfo) return;
        
        const { staffId, taskId } = currentTaskInfo;
        const newInTime = document.getElementById('inTimeInput').value.trim();
        const newOutTime = document.getElementById('outTimeInput').value.trim();

        // FIXED: å¢åŠ æ™‚é–“æ ¼å¼é©—è­‰ï¼Œé˜²æ­¢è¼¸å…¥éŒ¯èª¤å°è‡´è³‡æ–™æå£
        const timeRegex = /^\d{2}:\d{2}$/;
        if ((newInTime && !timeRegex.test(newInTime)) || (newOutTime && !timeRegex.test(newOutTime))) {
            alert("æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ HH:MM æ ¼å¼ (ä¾‹å¦‚ 14:30)");
            return;
        }
        
        // 1. æ›´æ–°è³‡æ–™ç‹€æ…‹ (in-memory staffData)
        staffData = staffData.map(staff => {
            if (staff.id === staffId) {
                const currentStatuses = staff.taskStatuses || {};
                const updatedTaskStatus = {};
                
                // åƒ…å„²å­˜éç©ºå€¼ï¼Œç¢ºä¿è³‡æ–™åº«ä¹¾æ·¨
                if (newInTime) updatedTaskStatus.inTime = newInTime;
                if (newOutTime) updatedTaskStatus.outTime = newOutTime;
                
                return {
                    ...staff,
                    taskStatuses: {
                        ...currentStatuses,
                        [taskId]: updatedTaskStatus
                    }
                };
            }
            return staff;
        });
        
        // 2. è§¸ç™¼é›²ç«¯åŒæ­¥ (CRITICAL)
        saveScheduleData(); 
        
        // 3. æ›´æ–° DOM dataset (é€™æœƒè§¸ç™¼ CSS è¦–è¦ºåŒ–)
        if (newInTime) { currentTaskElement.dataset.inTime = newInTime; } else { delete currentTaskElement.dataset.inTime; }
        if (newOutTime) { currentTaskElement.dataset.outTime = newOutTime; } else { delete currentTaskElement.dataset.outTime; }

        closeTimeModal();
    }

    // NEW: æ¸…ç©º IN/OUT æ™‚é–“ä¸¦åŒæ­¥ (ä¸€éµå–æ¶ˆåŠŸèƒ½)
    function clearManualTime() {
        if (!currentTaskElement || !currentTaskInfo) return;
        
        const { staffId, taskId } = currentTaskInfo;
        
        // 1. æ›´æ–°è³‡æ–™ç‹€æ…‹ (in-memory staffData)
        staffData = staffData.map(staff => {
            if (staff.id === staffId) {
                const currentStatuses = staff.taskStatuses || {};
                
                // åˆªé™¤æ­¤ä»»å‹™ ID çš„ç‹€æ…‹è¨˜éŒ„
                const updatedTaskStatuses = { ...currentStatuses };
                delete updatedTaskStatuses[taskId];

                return {
                    ...staff,
                    taskStatuses: updatedTaskStatuses
                };
            }
            return staff;
        });
        
        // 2. è§¸ç™¼é›²ç«¯åŒæ­¥
        saveScheduleData(); 
        
        // 3. æ›´æ–° DOM dataset (ç§»é™¤å±¬æ€§ä»¥æ¸…é™¤è¦–è¦ºæ•ˆæœ)
        delete currentTaskElement.dataset.inTime;
        delete currentTaskElement.dataset.outTime;
        
        // 4. æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('inTimeInput').value = '';
        document.getElementById('outTimeInput').value = '';

        closeTimeModal();
    }
    
    // --- 6. æ’ç­è¦–è¦ºåŒ–æ¸²æŸ“ (ç¶­æŒåŒæ­¥å„ªåŒ–é‚è¼¯) ---
    function renderScheduleAll() { 
        renderSidebar(); 
        requestAnimationFrame(renderTracksOnly); 
    }

    function renderSidebar() {
        leftContent.innerHTML = '';
        staffData.forEach((staff, index) => {
            const div = document.createElement('div');
            div.className = 'staff-card';
            div.dataset.staffId = staff.id;
            if (staff.height) div.style.height = staff.height + 'px';
            
            div.innerHTML = `
                <div class="staff-header">
                    <div class="idx-badge">${index + 1}</div>
                    <input class="staff-name" value="${staff.name}" onchange="updateStaffName(${staff.id}, this.value)">
                    <button class="btn-delete" onclick="removeStaff(${staff.id})">Ã—</button>
                </div>
                <div class="schedule-text-display" onclick="openEditModal(${staff.id})">${staff.content || '<span style="color:#ccc">é»æ“Šç·¨è¼¯...</span>'}</div>
                <div class="row-resizer"></div>
            `;
            leftContent.appendChild(div);
        });
    }

    function renderTracksOnly() {
        const openH = parseInt(document.getElementById('openHour').value) || 12;
        const closeH = parseInt(document.getElementById('closeHour').value) || 29;
        const startOfDay = openH * 60;
        const totalWidth = (closeH * 60 - startOfDay) * PX_PER_MIN;

        // FIXED: é˜²æ­¢è¨­å®šæ™‚é–“éŒ¯èª¤å°è‡´å¯¬åº¦ç‚ºè² å€¼
        if (totalWidth <= 0) {
            document.getElementById('ruler').innerHTML = '<div style="padding:10px; color:red;">æ™‚é–“è¨­å®šéŒ¯èª¤ (é–‹ >= é–‰)</div>';
            return;
        }

        document.getElementById('ruler').style.width = totalWidth + 'px';
        document.getElementById('trackContainer').style.width = totalWidth + 'px';
        document.getElementById('gridBg').style.width = totalWidth + 'px';

        const ruler = document.getElementById('ruler');
        const gridBg = document.getElementById('gridBg');
        ruler.innerHTML = ''; 
        const gridBgContent = [];
        for (let h = openH; h <= closeH; h++) {
            let left = (h * 60 - startOfDay) * PX_PER_MIN;
            let displayH = h >= 24 ? h - 24 : h;
            ruler.innerHTML += `<div class="hour-mark" style="left:${left}px;">${displayH}</div>`;
            gridBgContent.push(`<div class="v-line" style="left:${left}px;"></div>`);
        }
        gridBg.innerHTML = gridBgContent.join(''); 

        const container = document.getElementById('trackContainer');
        container.innerHTML = `<div class="grid-lines" id="gridBg" style="width: ${totalWidth}px;">${gridBg.innerHTML}</div><div id="currentTimeLine" class="current-time-line"></div>`;

        staffData.forEach(staff => {
            const trackDiv = document.createElement('div');
            trackDiv.className = 'track-row';
            trackDiv.id = `track-${staff.id}`;
            container.appendChild(trackDiv);
            
            const staffCard = document.querySelector(`.staff-card[data-staff-id="${staff.id}"]`);
            if (staff.height) {
                trackDiv.style.height = staff.height + 'px';
            } else if (staffCard) {
                trackDiv.style.height = staffCard.offsetHeight + 'px';
            }
            
            renderSingleTrack(trackDiv, staff.content, staff.id, startOfDay, closeH * 60);
        });
        updateTimeLineAndClock();
    }
    
    function renderSingleTrack(container, content, staffId, startOfDay, endOfDay) {
        container.innerHTML = '';
        const staff = staffData.find(s => s.id === staffId);
        const taskStatuses = staff.taskStatuses || {}; 

        const lines = content.trim().split('\n');
        const tasks = [];
        
        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (!trimmedLine) return;
            if (/^[\d./-]+\s*(?:\([A-Za-z]+\))?$/.test(trimmedLine) && trimmedLine.length < 12) return; 

            const match = trimmedLine.match(/([\d.:]+)\s*(\d+.*)/) || trimmedLine.match(/(\D+)\s*([\d.:]+)\s*(\d+.*)/);
            if (match) {
                let timeStr, detailStr;
                if (match.length === 3) { timeStr = match[1]; detailStr = match[2]; } 
                else { timeStr = match[2]; detailStr = match[3]; }
                let duration = 60;
                const numMatch = detailStr.match(/^(\d+)/);
                if (numMatch) duration = parseInt(numMatch[1]);
                const startTime = parseTime(timeStr);
                const endTime = startTime + duration;
                
                if (startTime !== null) {
                    const scheduledStart = formatTime(startTime);
                    const scheduledEnd = formatTime(endTime);
                    const taskId = getTaskHash(trimmedLine, startTime); 

                    const status = taskStatuses[taskId] || {}; 
                    
                    tasks.push({ 
                        start: startTime, 
                        end: endTime, 
                        rawText: trimmedLine, 
                        conflict: false,
                        staffId,
                        taskId,
                        scheduledStart,
                        scheduledEnd,
                        inTime: status.inTime || '',
                        outTime: status.outTime || ''
                    });
                }
            }
        });
        
        tasks.sort((a, b) => a.start - b.start);

        // FIXED: ä¿®æ­£è¡çªæª¢æ¸¬é‚è¼¯
        // èˆŠé‚è¼¯åªæª¢æŸ¥ç›¸é„°ï¼Œç¾åœ¨æª¢æŸ¥æ‰€æœ‰å¾ŒçºŒä»»å‹™æ˜¯å¦èˆ‡ç•¶å‰ä»»å‹™é‡ç–Š
        for (let i = 0; i < tasks.length; i++) {
            for (let j = i + 1; j < tasks.length; j++) {
                // å› ç‚ºå·²æ’åºï¼Œå¦‚æœ Task[j] çš„é–‹å§‹æ™‚é–“ >= Task[i] çš„çµæŸæ™‚é–“ï¼Œå‰‡å¾ŒçºŒéƒ½ä¸æœƒé‡ç–Š (break)
                // åä¹‹ï¼Œå¦‚æœ Task[i] çš„çµæŸæ™‚é–“ > Task[j] çš„é–‹å§‹æ™‚é–“ï¼Œå‰‡ç™¼ç”Ÿé‡ç–Š
                if (tasks[i].end > tasks[j].start) {
                    tasks[i].conflict = true;
                    tasks[j].conflict = true;
                } else {
                    break;
                }
            }
        }
        
        let currentCursor = startOfDay;
        tasks.forEach(task => {
            if (task.start > currentCursor) {
                let gap = task.start - currentCursor;
                if (gap >= 10) {
                    let startStr = formatTime(currentCursor);
                    let endStr = formatTime(task.start);
                    let durationStr = formatDuration(gap);
                    let label = `<b>${durationStr}</b><div style="font-size:10px; margin-top:1px;">${startStr}-${endStr}</div>`;
                    createBlock(container, currentCursor, task.start, startOfDay, 'free', label);
                }
            }
            let type = task.conflict ? 'conflict' : 'work';
            
            // å‚³éæ‰€æœ‰ç‹€æ…‹è³‡è¨Šçµ¦ createBlock
            createBlock(container, task.start, task.end, startOfDay, type, task.rawText, task.staffId, task.taskId, task.scheduledStart, task.scheduledEnd, task.inTime, task.outTime);
            
            if (task.end > currentCursor) currentCursor = task.end;
        });
    }

    function parseTime(timeStr) {
        if (!timeStr) return null;
        timeStr = timeStr.replace('.', ':');
        let parts = timeStr.split(':');
        let h = 0, m = 0;
        if (parts.length === 2) { h = parseInt(parts[0]); m = parseInt(parts[1]); }
        else if (timeStr.length === 4) { h = parseInt(timeStr.substring(0, 2)); m = parseInt(timeStr.substring(2, 4)); }
        else { h = parseInt(timeStr); }
        if (isNaN(h)) return null;
        if (h < 11) h += 24; 
        return h * 60 + m;
    }
    function formatTime(minutes) {
        let h = Math.floor(minutes / 60); 
        let m = minutes % 60;
        return (h < 10 ? "0"+h : h) + ":" + (m < 10 ? "0"+m : m);
    }
    function formatDuration(mins) {
        let h = Math.floor(mins / 60); let m = mins % 60;
        return (h > 0 ? h + "h" : "") + (m > 0 ? m + "m" : "");
    }
    
    function createBlock(container, start, end, offsetStart, type, content, staffId, taskId, scheduledStart, scheduledEnd, inTime, outTime) {
        if (end <= start) return;
        const left = (start - offsetStart) * PX_PER_MIN;
        const width = (end - start) * PX_PER_MIN;
        const div = document.createElement('div');
        div.className = `block type-${type}`;
        div.style.left = left + 'px'; 
        div.style.width = Math.max(width - 2, 2) + 'px'; 
        
        if (type === 'free') { 
            div.innerHTML = content; 
        } else { 
            div.innerText = content;
            
            if (type === 'work') {
                div.onclick = function(e) {
                    e.stopPropagation();
                    openTimeModal(div, staffId, taskId, content, scheduledStart, scheduledEnd);
                };
                
                div.dataset.staffId = staffId;
                div.dataset.taskId = taskId;
                div.dataset.scheduledStart = scheduledStart;
                div.dataset.scheduledEnd = scheduledEnd;
                // è®€å–å¾ Firebase è¼‰å…¥çš„ç‹€æ…‹ä¸¦è¨­å®šåˆ° DOM
                if(inTime) div.dataset.inTime = inTime;
                if(outTime) div.dataset.outTime = outTime;
            }
        }
        container.appendChild(div);
    }
    
    function updateTimeLineAndClock() {
        const line = document.getElementById('currentTimeLine');
        const topClock = document.getElementById('topClock');
        const openH = parseInt(document.getElementById('openHour').value) || 12;
        const now = new Date();
        let h = now.getHours(); let m = now.getMinutes();
        
        let clockH = now.getHours();
        if (clockH >= 0 && clockH < 11) clockH += 24; 
        
        if(topClock) topClock.innerText = `${(clockH<10?"0"+clockH:clockH)}:${(m<10?"0"+m:m)}`;
        
        if (h < 11) h += 24;
        const offsetMins = (h * 60 + m) - openH * 60;
        if (offsetMins >= 0 && line) { line.style.display = 'block'; line.style.left = (offsetMins * PX_PER_MIN) + 'px'; }
        else if (line) { line.style.display = 'none'; }
    }

    // --- 7. æ—¥çµåŠŸèƒ½ (ç¶­æŒå„ªåŒ–å¾Œé‚è¼¯) ---
    function renderServices() {
        const container = document.getElementById('service_container'); container.innerHTML = '';
        services.forEach((svc, index) => {
            const div = document.createElement('div'); div.className = 'service-row';
            div.innerHTML = `<input type="text" value="${svc.name}" onchange="updateService(${index}, 'name', this.value)"><span>+</span><input type="number" value="${svc.price}" oninput="updateService(${index}, 'price', this.value)" step="100"><button class="btn-circle btn-red" style="width:18px; height:18px; font-size:12px;" onclick="removeService(${index})">Ã—</button>`;
            container.appendChild(div);
        });
    }
    
    function updateService(index, field, value) { 
        let finalValue = value;

        if(field === 'price') {
            const parsed = parseInt(value);
            finalValue = isNaN(parsed) ? services[index].price : parsed;
            if (value === "") finalValue = 0; 
        }

        services = services.map((svc, i) => 
            i === index ? { ...svc, [field]: finalValue } : svc
        );
        renderServices();
        renderSettlementTable(); 
        saveScheduleData(); 
    }
    function addServiceRow() { 
        services.push({name: "æ–°æœå‹™", price: 0}); 
        renderServices(); 
        renderSettlementTable(); 
        saveScheduleData(); 
    }
    function removeService(index) { 
        services = services.filter((_, i) => i !== index);
        renderServices(); 
        renderSettlementTable(); 
        saveScheduleData(); 
    }

    function calculateSettlement(staff, commTable, costTable, services) {
        const results = [];
        if (!staff.content.trim()) return results;

        const lines = staff.content.split('\n');
        lines.forEach(line => {
            const rawLine = line.trim();
            if (!rawLine) return;

            const pattern = /(\d+)\/(\d+)-(\d+)/;
            const match = rawLine.match(pattern);

            let extra_money = 0, base_comm = 0, revenue = 0, base_cost = 0, work = 0;
            let total_miss = 0, aunt_inc = 0, aunt_disp = 0, balance = 0;
            let isManual = false;

            if (match) {
                const duration = parseInt(match[1]), rev = parseInt(match[2]), count = parseInt(match[3]);
                const key = `${duration}-${count}`;
                
                revenue = rev;
                base_comm = commTable[key] || 0;
                base_cost = costTable[key] || 0;
                work = WORK_UNIT_TABLE[duration] || 0;

                services.forEach(svc => { 
                    if (rawLine.toLowerCase().includes(svc.name.toLowerCase())) extra_money += svc.price; 
                });

                let realName = staff.name; 
                const nameMatch = rawLine.match(/^([^\d\s]+)/); 
                if (nameMatch && !nameMatch[1].includes(':')) realName = nameMatch[1];
                
                total_miss = base_comm + extra_money;
                
                aunt_inc = revenue - base_cost - extra_money; 
                if (AUNT_EXTRA_NAMES.includes(realName)) aunt_inc += 100;
                aunt_disp = Math.floor(aunt_inc / 100); 

                balance = revenue - total_miss;
            } else {
                isManual = true;
            }

            results.push({
                rawLine,
                isManual,
                revenue,
                extra_money,
                base_comm,
                total_miss,
                aunt_disp,
                balance,
                work,
            });
        });

        return results;
    }
    function updateLocalStaffTotal(detailRow) {
        if (!detailRow) return;
        let groupHeader = detailRow.previousElementSibling;
        while (groupHeader && !groupHeader.classList.contains('group-header')) {
            groupHeader = groupHeader.previousElementSibling;
        }
        if (!groupHeader) return;
        let staff_t_extra = 0, staff_t_base = 0; 
        let staff_t_aunt = 0, staff_t_rev = 0, staff_t_com = 0, staff_t_bal = 0, staff_t_wk = 0;
        let currentRow = groupHeader.nextElementSibling;
        let targetFooter = null;
        while (currentRow && !currentRow.classList.contains('group-header')) {
            if (currentRow.classList.contains('staff-footer')) {
                targetFooter = currentRow;
                break;
            }
            const getVal = (cls) => { 
                const c = currentRow.querySelector('.' + cls); 
                if (!c) return 0; 
                return parseFloat(c.innerText.replace(/[^\d.-]/g, '')) || 0; 
            };
            staff_t_extra += getVal('col-extra');
            staff_t_base += getVal('col-base');
            staff_t_aunt += getVal('col-aunt');
            staff_t_rev += getVal('col-rev');
            staff_t_com += getVal('col-comm');
            staff_t_bal += getVal('col-bal');
            staff_t_wk += getVal('col-work');
            currentRow = currentRow.nextElementSibling;
        }
        if (targetFooter) {
            const cells = targetFooter.querySelectorAll('td');
            cells[1].innerText = staff_t_extra.toLocaleString();
            cells[2].innerText = staff_t_base.toLocaleString();
            cells[3].innerText = staff_t_aunt;
            cells[4].innerText = staff_t_rev.toLocaleString();
            cells[5].innerText = staff_t_com.toLocaleString();
            cells[6].innerText = staff_t_bal.toLocaleString();
            cells[7].innerText = staff_t_wk;
        }
    }
    function renderSettlementTable() {
        const commTable = { "40-1": parseInt(document.getElementById('base_40_1').value) || 0, "60-1": parseInt(document.getElementById('base_60_1').value) || 0, "60-2": parseInt(document.getElementById('base_60_2').value) || 0, "120-3": parseInt(document.getElementById('base_120_3').value) || 0 };
        const costTable = { "40-1": parseInt(document.getElementById('cost_40_1').value) || 0, "60-1": parseInt(document.getElementById('cost_60_1').value) || 0, "60-2": parseInt(document.getElementById('cost_60_2').value) || 0, "120-3": parseInt(document.getElementById('cost_120_3').value) || 0 };

        let html = "";
        let grand_t_aunt = 0, grand_t_rev = 0, grand_t_com = 0, grand_t_bal = 0, grand_t_wk = 0;

        staffData.forEach(staff => {
            if (!staff.content.trim()) return;
            let staff_t_extra = 0, staff_t_base = 0; 
            let staff_t_aunt = 0, staff_t_rev = 0, staff_t_com = 0, staff_t_bal = 0, staff_t_wk = 0;
            html += `<tr class="group-header"><td colspan="8">${staff.name}</td></tr>`;
            const settlements = calculateSettlement(staff, commTable, costTable, services);
            settlements.forEach(data => {
                staff_t_extra += data.extra_money;
                staff_t_base += data.base_comm;
                staff_t_aunt += data.aunt_disp;
                staff_t_rev += data.revenue;
                staff_t_com += data.total_miss;
                staff_t_bal += data.balance;
                staff_t_wk += data.work;
                if (data.isManual) {
                     html += `<tr class="row-error"><td style="text-align:left; font-size:11px; padding: 6px 6px; color: ${data.rawLine ? '#2c3e50' : '#95a5a6'};">${data.rawLine || 'æ‰‹å‹•è¼¸å…¥'}</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-extra">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-base">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-aunt">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-rev">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-comm">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-bal">0</td><td contenteditable="true" oninput="onCellEdit(this)" class="col-work">0</td></tr>`;
                } else {
                    html += `<tr><td style="text-align:left; font-size:11px; padding: 6px 6px;">${data.rawLine}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-extra">${data.extra_money}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-base">${data.base_comm}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-aunt"><b>${data.aunt_disp}</b></td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-rev text-green">${data.revenue}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-comm text-red">${data.total_miss}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-bal text-blue">${data.balance}</td>
                             <td contenteditable="true" oninput="onCellEdit(this)" class="col-work">${data.work}</td></tr>`;
                }
            });
            html += `<tr class="staff-footer">
                        <td style="text-align: right; font-weight: bold;">${staff.name} ç¸½è¨ˆ</td>
                        <td>${staff_t_extra.toLocaleString()}</td>
                        <td>${staff_t_base.toLocaleString()}</td>
                        <td class="staff-t-aunt">${staff_t_aunt}</td>
                        <td class="staff-t-rev text-green">${staff_t_rev.toLocaleString()}</td>
                        <td class="staff-t-com text-red">${staff_t_com.toLocaleString()}</td>
                        <td class="staff-t-bal text-blue">${staff_t_bal.toLocaleString()}</td>
                        <td class="staff-t-wk">${staff_t_wk}</td>
                    </tr>`;
            grand_t_aunt += staff_t_aunt;
            grand_t_rev += staff_t_rev;
            grand_t_com += staff_t_com;
            grand_t_bal += staff_t_bal;
            grand_t_wk += staff_t_wk;
        });
        document.getElementById('table_body').innerHTML = html;
        document.getElementById('total_aunt').innerText = grand_t_aunt; 
        document.getElementById('total_revenue').innerText = grand_t_rev.toLocaleString(); 
        document.getElementById('total_commission').innerText = grand_t_com.toLocaleString(); 
        document.getElementById('total_balance').innerText = grand_t_bal.toLocaleString(); 
        document.getElementById('total_work').innerText = grand_t_wk;
    }
    function onCellEdit(cell) { 
        cell.classList.add('manual-edit'); 
        const detailRow = cell.closest('tr');
        if (detailRow && !detailRow.classList.contains('staff-footer') && !detailRow.classList.contains('group-header')) {
            updateLocalStaffTotal(detailRow); 
        }
        updateTotalsFromDOM(); 
    }
    function updateTotalsFromDOM() {
        let t_aunt = 0, t_rev = 0, t_com = 0, t_bal = 0, t_wk = 0;
        document.querySelectorAll('#table_body tr.staff-footer').forEach(row => {
            const cells = row.querySelectorAll('td');
            const getVal = (index) => {
                const text = cells[index].innerText.replace(/[^\d.-]/g, '');
                return parseFloat(text) || 0;
            };
            t_aunt += getVal(3); 
            t_rev += getVal(4); 
            t_com += getVal(5); 
            t_bal += getVal(6); 
            t_wk += getVal(7);
        });
        document.getElementById('total_aunt').innerText = t_aunt; 
        document.getElementById('total_revenue').innerText = t_rev.toLocaleString(); 
        document.getElementById('total_commission').innerText = t_com.toLocaleString(); 
        document.getElementById('total_balance').innerText = t_bal.toLocaleString(); 
        document.getElementById('total_work').innerText = t_wk;
    }

    initSchedule(); renderServices();
</script>
</body>
</html>