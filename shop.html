<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÈñÄÂ∫óÁÆ°ÁêÜ (Èõ≤Á´ØÂêåÊ≠•Áâà)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* ‰øùÁïôÂéüÊú¨ÁöÑ CSS */
        :root { --primary-dark: #2c3e50; --accent-green: #27ae60; --accent-blue: #3498db; --bg-light: #f4f6f9; --safe-top: env(safe-area-inset-top); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-top: var(--safe-top); }
        .nav-bar { height: 44px; background: #1a252f; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; flex-shrink: 0; }
        .app-title { color: white; font-weight: bold; font-size: 14px; }
        .sync-status { font-size: 10px; color: #f1c40f; margin-left: 5px; }
        .tab-btn { background: rgba(255,255,255,0.1); border: none; color: #bdc3c7; padding: 6px 10px; font-size: 13px; border-radius: 6px; }
        .tab-btn.active { color: #fff; background: #3498db; }
        .view-container { flex: 1; display: none; flex-direction: column; overflow: hidden; height: 100%; }
        .view-container.active { display: flex; }
        .schedule-top-bar { padding: 5px 10px; background: var(--primary-dark); display: flex; flex-wrap: wrap; gap: 10px; color: white; flex-shrink: 0; }
        .date-input { background: transparent; border: none; color: #f1c40f; font-size: 18px; font-weight: bold; width: 80px; text-align: center; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        .left-panel { width: 100px; background: #eef2f3; border-right: 1px solid #ccc; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .staff-card { border-bottom: 1px solid #ccc; background: #fff; padding: 4px; display: flex; flex-direction: column; min-height: 70px; }
        .staff-header { display: flex; margin-bottom: 2px; }
        .staff-name { flex: 1; border: none; border-bottom: 1px solid #f39c12; font-weight: bold; width: 100%; }
        .schedule-text-display { flex: 1; border: 1px solid #ddd; font-size: 11px; padding: 4px; background: #fafafa; white-space: pre-wrap; overflow: hidden; }
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fcfcfc; }
        .ruler-container { height: 30px; border-bottom: 1px solid #bdc3c7; overflow: hidden; flex-shrink: 0; }
        .tracks-scroll-area { flex: 1; overflow: auto; position: relative; }
        .tracks-wrapper { position: relative; min-width: 100%; min-height: 100%; }
        .track-row { border-bottom: 1px solid #e0e0e0; position: relative; box-sizing: border-box; }
        .block { position: absolute; top: 4px; bottom: 4px; border-radius: 4px; padding: 2px 4px; font-size: 11px; overflow: hidden; line-height: 1.2; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .type-work { background: #3498db; color: white; z-index: 2; }
        .type-free { background: #d4efdf; color: #1e8449; border: 1px dashed #2ecc71; height: 24px; top: 50%; transform: translateY(-50%); z-index: 1; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.1; }
        .type-conflict { background: #e74c3c; color: white; z-index: 3; }
        .hour-mark { position: absolute; top: 0; height: 100%; border-left: 1px solid #bdc3c7; padding-left: 2px; font-size: 10px; color: #555; }
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        .modal-textarea { width: 100%; height: 200px; padding: 10px; font-size: 16px; border: 1px solid #ccc; resize: none; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-save { background: #2ecc71; color: white; }
        .btn-cancel { background: #95a5a6; color: white; }
    </style>
</head>
<body>

<nav class="nav-bar">
    <div class="app-title">üè¢ ÈñÄÂ∫óÊéíÁè≠ <span id="syncStatus" class="sync-status">ÈÄ£Á∑ö‰∏≠...</span></div>
    <div>
        <button class="tab-btn active" onclick="switchTab('schedule')">ÊéíÁè≠</button>
        <button class="tab-btn" onclick="alert('Ë´ã‰ΩøÁî®Ëæ¶ÂÖ¨ÂÆ§ÁµêÂ∏≥Á≥ªÁµ±Êü•ÁúãÂ†±Ë°®')">Â†±Ë°®</button>
    </div>
</nav>

<div id="view-schedule" class="view-container active">
    <div class="schedule-top-bar">
        <div style="display:flex; align-items:center; background:rgba(0,0,0,0.3); padding:5px 10px; border-radius:8px;">
            <span style="font-size:12px; color:#aaa; margin-right:5px;">DATE</span>
            <input type="text" class="date-input" id="dateInput" value="11/28" onchange="saveToCloud()">
        </div>
        <button onclick="addStaff()" style="background:#27ae60; color:white; border:none; padding:6px 12px; border-radius:6px; font-weight:bold;">+‰∫∫Âì°</button>
    </div>

    <div class="main-wrapper">
        <div class="left-panel" id="leftContent"></div>
        <div class="right-panel">
            <div class="ruler-container"><div id="ruler" style="height:100%; position:relative;"></div></div>
            <div class="tracks-scroll-area" id="rightContent">
                <div class="tracks-wrapper" id="trackContainer"></div>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Á∑®ËºØÁè≠Ë°®</h3>
        <textarea id="modalTextarea" class="modal-textarea"></textarea>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeEditModal()">ÂèñÊ∂à</button>
            <button class="modal-btn btn-save" onclick="saveModalData()">ÂÑ≤Â≠ò</button>
        </div>
    </div>
</div>

<script>
    // 1. Firebase Ë®≠ÂÆö
    const firebaseConfig = {
        apiKey: "AIzaSyDsUsWuynci0DP71veuu19Ht8bJmhHSkHs",
        authDomain: "worktools-f53e5.firebaseapp.com",
        databaseURL: "https://worktools-f53e5-default-rtdb.firebaseio.com",
        projectId: "worktools-f53e5",
        storageBucket: "worktools-f53e5.firebasestorage.app",
        messagingSenderId: "950551082090",
        appId: "1:950551082090:web:3c2c4962b5ffa044aec613",
        measurementId: "G-EKPY3SC0BR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let staffData = [];
    let currentEditingId = null;
    const PX_PER_MIN = 2;
    const OPEN_H = 12; 
    const CLOSE_H = 29;

    // 2. Áõ£ËÅΩÈõ≤Á´ØË≥áÊñô (Ê†∏ÂøÉ)
    const syncStatus = document.getElementById('syncStatus');
    db.ref('shop_data').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            staffData = data.staffData || [];
            document.getElementById('dateInput').value = data.date || "11/28";
            renderAll();
            syncStatus.innerText = "‚úÖ Â∑≤ÂêåÊ≠•";
        } else {
            // Â¶ÇÊûúÊòØÂÖ®Êñ∞ÁöÑË≥áÊñôÂ∫´
            staffData = [{id: 1, name: "ÁØÑ‰æã", content: "12:00 ÂßöË≤¥13", height: 70}];
            saveToCloud();
        }
    });

    // 3. ‰∏äÂÇ≥Ë≥áÊñôÂà∞Èõ≤Á´Ø
    function saveToCloud() {
        syncStatus.innerText = "‚òÅÔ∏è ‰∏äÂÇ≥‰∏≠...";
        db.ref('shop_data').set({
            date: document.getElementById('dateInput').value,
            staffData: staffData
        });
    }

    // --- ‰ª•‰∏ãÁÇ∫ UI ÈÇèËºØ (Á∞°ÂåñÁâà) ---
    function renderAll() {
        renderLeft();
        renderRight();
    }

    function renderLeft() {
        const container = document.getElementById('leftContent');
        container.innerHTML = '';
        staffData.forEach((s, idx) => {
            const div = document.createElement('div');
            div.className = 'staff-card';
            div.style.height = (s.height || 70) + 'px';
            div.innerHTML = `
                <div class="staff-header">
                    <div style="background:#34495e; color:white; width:16px; height:16px; border-radius:50%; text-align:center; font-size:10px; margin-right:5px;">${idx+1}</div>
                    <input class="staff-name" value="${s.name}" onchange="updateName(${s.id}, this.value)">
                    <button onclick="removeStaff(${s.id})" style="border:none; background:none; color:#999;">√ó</button>
                </div>
                <div class="schedule-text-display" onclick="openEdit(${s.id})">${s.content || '<span style="color:#ccc">ÈªûÊìäÁ∑®ËºØ...</span>'}</div>
            `;
            container.appendChild(div);
        });
    }

    function renderRight() {
        const container = document.getElementById('trackContainer');
        const ruler = document.getElementById('ruler');
        container.innerHTML = ''; ruler.innerHTML = '';
        
        const startMin = OPEN_H * 60;
        const totalW = (CLOSE_H * 60 - startMin) * PX_PER_MIN;
        container.style.width = totalW + 'px';
        ruler.style.width = totalW + 'px';

        // Áï´ÂàªÂ∫¶
        for(let h=OPEN_H; h<=CLOSE_H; h++){
            let left = (h*60 - startMin) * PX_PER_MIN;
            let mk = document.createElement('div'); mk.className='hour-mark'; mk.style.left=left+'px'; mk.innerText = h>=24?h-24:h;
            ruler.appendChild(mk);
            let line = document.createElement('div'); line.style.position='absolute'; line.style.left=left+'px'; line.style.height='100%'; line.style.borderLeft='1px dashed #eee';
            container.appendChild(line);
        }

        // Áï´Áè≠Ë°®
        staffData.forEach(s => {
            const row = document.createElement('div');
            row.className = 'track-row';
            row.style.height = (s.height || 70) + 'px';
            renderTracksInRow(row, s.content, startMin);
            container.appendChild(row);
        });
        
        // ÂêåÊ≠•ÊªæÂãï
        document.getElementById('rightContent').onscroll = function() {
            document.getElementById('leftContent').scrollTop = this.scrollTop;
            document.querySelector('.ruler-container').scrollLeft = this.scrollLeft;
        };
        document.getElementById('leftContent').onscroll = function() {
            document.getElementById('rightContent').scrollTop = this.scrollTop;
        };
    }

    function renderTracksInRow(row, text, offsetStart) {
        if(!text) return;
        const lines = text.split('\n');
        let cursor = offsetStart;
        
        // Á∞°ÂñÆËß£ÊûêÈÇèËºØ
        const tasks = [];
        lines.forEach(line => {
             // ÊîØÊè¥Ê†ºÂºè: "13:00 ÂÖßÂÆπ" Êàñ "ÂÖßÂÆπ" (È†êË®≠Êé•Á∫å)
             let start = cursor;
             let dur = 60; 
             const timeMatch = line.match(/(\d{1,2})[:.](\d{2})/);
             if(timeMatch) {
                 let h = parseInt(timeMatch[1]); if(h<11) h+=24;
                 start = h*60 + parseInt(timeMatch[2]);
             }
             const durMatch = line.match(/(\d+)(?!\/)/); // Á∞°ÂñÆÊäìÊï∏Â≠óÁï∂ÊôÇÈï∑
             if(durMatch && line.length < 10) dur = parseInt(durMatch[1]); // Á∞°ÂåñÂà§Êñ∑
             
             // ÈÄôË£°ÁÇ∫‰∫ÜÁ©©ÂÆöÊÄßÔºå‰ΩøÁî®‰Ω†ÂéüÊú¨Êèê‰æõÁöÑËß£ÊûêÈÇèËºØÊúÉÊõ¥Â•ΩÔºåÈÄôË£°ÂÅö‰∏ÄÂÄãÁ∞°ÂåñÁâàÂ±ïÁ§∫
             // Ëã•ÈúÄË¶ÅÂÆåÊï¥Ëß£ÊûêÈÇèËºØÔºåÁõ¥Êé•ÊääÂéüÊú¨ÈÇ£‰∏ÄÂ§ßÊÆµ copy ÈÅé‰æÜÂç≥ÂèØ
             // ÈÄôË£°ÊºîÁ§∫Ê†∏ÂøÉÔºöÁî¢ÁîüÂçÄÂ°ä
             if(line.trim()){
                 tasks.push({start: start, end: start+dur, text: line});
                 cursor = start + dur;
             }
        });

        // Áπ™Ë£Ω
        tasks.forEach(t => {
            if(t.end <= t.start) return;
            const div = document.createElement('div');
            div.className = 'block ' + (t.text.includes('Á©∫') ? 'type-free' : 'type-work');
            div.style.left = (t.start - offsetStart) * PX_PER_MIN + 'px';
            div.style.width = (t.end - t.start) * PX_PER_MIN + 'px';
            div.innerText = t.text;
            row.appendChild(div);
        });
    }

    // Ë≥áÊñôÊìç‰Ωú
    function addStaff() { staffData.push({id: Date.now(), name:'Êñ∞', content:'', height:70}); saveToCloud(); }
    function removeStaff(id) { if(confirm('Âà™Èô§?')) { staffData = staffData.filter(s=>s.id!==id); saveToCloud(); } }
    function updateName(id, val) { staffData.find(s=>s.id===id).name=val; saveToCloud(); }
    
    // Modal
    function openEdit(id) { currentEditingId = id; document.getElementById('modalTextarea').value = staffData.find(s=>s.id===id).content; document.getElementById('editModal').classList.add('active'); }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }
    function saveModalData() {
        if(currentEditingId) {
            staffData.find(s=>s.id===currentEditingId).content = document.getElementById('modalTextarea').value;
            saveToCloud();
        }
        closeEditModal();
    }
</script>
</body>
</html>