<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¨èƒ½é–€åº—ç®¡ç† (å·¥æ•¸å…¥è¡¨ç‰ˆ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- å…¨å±€åŸºç¤è¨­å®š --- */
        :root { 
            --primary-dark: #2c3e50; 
            --accent-green: #27ae60; 
            --accent-blue: #3498db; 
            --bg-light: #f4f6f9; 
            --safe-top: env(safe-area-inset-top); 
            --in-out-color: #2ecc71; 
            --conflict-color: #e74c3c; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding-top: var(--safe-top); }
        
        /* å°èˆªåˆ— */
        .nav-bar { height: 44px; background: #1a252f; display: flex; align-items: center; padding: 0 10px; gap: 5px; flex-shrink: 0; z-index: 200; justify-content: space-between; }
        .app-title { color: white; font-weight: bold; font-size: 14px; white-space: nowrap; display: flex; align-items: center; gap: 5px;}
        .sync-dot { width: 8px; height: 8px; background-color: #f1c40f; border-radius: 50%; display: inline-block; } 
        .nav-buttons { display: flex; gap: 5px; }
        .tab-btn { background: rgba(255,255,255,0.1); border: none; color: #bdc3c7; padding: 6px 10px; font-size: 13px; border-radius: 6px; font-weight: bold; transition: all 0.2s; }
        .tab-btn.active { color: #fff; background: #3498db; }
        
        /* è¦–åœ–å®¹å™¨ */
        .view-container { flex: 1; position: relative; display: none; flex-direction: column; overflow: hidden; height: 100%; }
        .view-container.active { display: flex; }
        
        /* æ’ç­è¦–åœ–æ¨£å¼ */
        .schedule-top-bar { height: auto; min-height: 50px; background: var(--primary-dark); display: flex; flex-wrap: wrap; align-items: center; padding: 5px 10px; gap: 10px; border-bottom: 1px solid #34495e; flex-shrink: 0; color: white; }
        .info-group { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; flex: 1; }
        .date-input { background: transparent; border: none; color: #f1c40f; font-size: 18px; font-weight: bold; width: 70px; text-align: center; }
        .real-time-clock { font-size: 20px; font-weight: bold; color: #2ecc71; margin-left: auto; }
        .control-group { display: flex; gap: 10px; width: 100%; justify-content: space-between; align-items: center; }
        .action-btn { background: var(--accent-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; }
        .action-btn-reset { background: #c0392b; }
        .time-settings { display: flex; gap: 5px; font-size: 12px; color: #ecf0f1; align-items: center; }
        .time-settings input { width: 30px; text-align: center; border-radius: 4px; border: none; padding: 2px; }
        
        /* æ’ç­ä¸»é«” */
        .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        .left-panel { width: 100px; min-width: 60px; max-width: 50vw; background: #eef2f3; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 50; flex-shrink: 0; }
        .left-header-bar { height: 30px; background: #dfe4ea; border-bottom: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #7f8c8d; }
        .left-content { flex: 1; overflow-y: hidden; padding-bottom: 20px; }
        .staff-card { min-height: 70px; height: auto; border-bottom: 1px solid #ccc; background: #fff; padding: 4px; padding-bottom: 10px; display: flex; flex-direction: column; position: relative; flex-shrink: 0; overflow: hidden; }
        .staff-header { display: flex; align-items: center; margin-bottom: 2px; flex-shrink: 0; }
        .idx-badge { background: #34495e; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 3px; flex-shrink: 0; }
        .staff-name { flex: 1; border: none; border-bottom: 1px solid #f39c12; font-size: 14px; font-weight: bold; width: 100%; background: transparent; border-radius: 0; min-width: 0; }
        .btn-delete { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: #ecf0f1; color: #7f8c8d; border-radius: 50%; border: none; font-size: 14px; padding: 0; }
        .schedule-text-display { width: 100%; min-height: 0; flex: 1; border: 1px solid #ddd; font-size: 11px; padding: 4px; background: #fafafa; border-radius: 4px; white-space: pre-wrap; cursor: pointer; color: #2c3e50; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; }
        .col-resizer { width: 12px; background: #bdc3c7; cursor: col-resize; display: flex; align-items: center; justify-content: center; z-index: 60; flex-shrink: 0; border-left: 1px solid #95a5a6; border-right: 1px solid #95a5a6; }
        .row-resizer { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; cursor: row-resize; z-index: 10; display: flex; justify-content: center; align-items: flex-end; }
        .row-resizer::after { content: ""; display: block; width: 20px; height: 3px; border-top: 1px solid #bdc3c7; border-bottom: 1px solid #bdc3c7; margin-bottom: 2px; }
        
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fcfcfc; }
        .ruler-container { height: 30px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; overflow: hidden; flex-shrink: 0; position: relative; }
        .tracks-scroll-area { flex: 1; overflow: auto; padding-top: 0; position: relative; }
        .tracks-wrapper { position: relative; min-width: 100%; min-height: 100%; }
        .grid-lines { position: absolute; top: 0; left: 0; height: 100%; width: 100%; pointer-events: none; }
        .v-line { position: absolute; top: 0; height: 100%; border-left: 1px dashed #e0e0e0; }
        .track-row { min-height: 70px; height: auto; border-bottom: 1px solid #e0e0e0; position: relative; box-sizing: border-box; }
        .hour-mark { position: absolute; top: 0; height: 100%; border-left: 1px solid #bdc3c7; padding-left: 2px; font-size: 10px; color: #555; line-height: 30px; }
        
        .block { position: absolute; top: 4px; bottom: 4px; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2px 4px; font-size: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); white-space: normal; overflow: hidden; word-wrap: break-word; line-height: 1.2; cursor: pointer; z-index: 1; } 
        .type-work { background: #3498db; color: white; border: 1px solid #2980b9; z-index: 2; font-weight: bold; }
        .type-free { background: #d4efdf; color: #1e8449; border: 1px dashed #2ecc71; height: 24px; top: 50%; transform: translateY(-50%); opacity: 0.95; z-index: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; line-height: 1.1; }
        .type-conflict { background: var(--conflict-color); color: white; z-index: 3; }
        .current-time-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #e74c3c; z-index: 40; pointer-events: none; display: none; }
        .block[data-in-time]:not([data-out-time]) { box-shadow: 0 0 10px 3px var(--in-out-color); border: 1px solid var(--in-out-color); }
        .block[data-in-time][data-out-time] { border: 2px solid var(--in-out-color); box-shadow: none; }
        .block::before, .block::after { content: ''; position: absolute; top: 0; bottom: 0; width: 0; transition: width 0.3s ease-in-out; z-index: -1; border-radius: 4px; }
        .block[data-in-time]::before { left: 0; background: var(--in-out-color); width: 50%; }
        .block[data-out-time]::after { right: 0; background: var(--in-out-color); width: 50%; }

        /* æ—¥çµè¦–åœ– (å–®äººå–®è¡¨æ¨£å¼) */
        .settle-container { width: 100%; padding: 10px; overflow-y: auto; height: 100%; padding-bottom: 80px; }
        .config-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .config-panel { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .config-panel h3 { margin: 0 0 8px 0; color: #007bff; font-size: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .middle-section { margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .summary-area { display: flex; gap: 10px; min-width: 100%; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 10px; min-width: 100px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card h4 { margin: 0 0 5px 0; font-size: 11px; color: #888; white-space: nowrap; }
        .card p { margin: 0; font-size: 20px; font-weight: 800; color: #333; }
        .text-green { color: #28a745 !important; }
        .text-red { color: #dc3545 !important; }
        .text-blue { color: #007bff !important; }
        
        /* å¯ç·¨è¼¯æ¬„ä½æ¨£å¼ */
        td[contenteditable="true"] { background: #fffae6; cursor: text; border: 1px dashed #ccc; min-width: 40px; }
        td[contenteditable="true"]:focus { background: #fff; outline: 2px solid #3498db; }

        .service-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .service-row { display: flex; align-items: center; gap: 3px; background: #fff3cd; padding: 4px 8px; border-radius: 15px; border: 1px solid #ffeeba; }
        .service-row input[type="text"] { width: 50px; border: none; background: transparent; font-weight: bold; color: #856404; text-align: center; font-size: 13px; }
        .service-row input[type="number"] { width: 45px; border: 1px solid #ddd; border-radius: 4px; padding: 2px; text-align: right; font-size: 13px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px; }
        .modal-title { font-weight: bold; font-size: 16px; color: #2c3e50; text-align: center; }
        .modal-textarea { width: 100%; height: 200px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; resize: none; font-family: monospace; }
        .modal-btns { display: flex; gap: 10px; justify-content: space-between; margin-top: 5px; } 
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; } 
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-save { background: #2ecc71; color: white; }
        #timeModal .time-input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        #timeModal .time-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #ccc; }
        #timeModal .time-display { font-size: 18px; font-weight: bold; color: var(--accent-blue); width: 80px; text-align: right; border: 1px solid #ccc; border-radius: 4px; padding: 4px; min-height: 28px; }
        #timeModal .btn-record { background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .btn-circle { border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border: none; color: white; font-weight: bold; font-size: 16px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
    </style>
</head>
<body>

<nav class="nav-bar">
    <div class="app-title">ğŸ¢ é–€åº—ç®¡ç†(å·¥æ•¸å…¥è¡¨ç‰ˆ) <span class="sync-dot" id="syncStatus"></span></div>
    <div class="nav-buttons">
        <button class="tab-btn active" onclick="switchTab('schedule')">æ’ç­</button>
        <button class="tab-btn" onclick="switchTab('settle')">æ—¥çµ</button>
    </div>
</nav>

<div id="view-schedule" class="view-container active">
    <div class="schedule-top-bar">
        <div class="info-group">
            <span style="font-size:12px; color:#aaa;">DATE</span>
            <input type="text" class="date-input" id="dateInput" value="12/01" onchange="saveScheduleData()" enterkeyhint="done">
            <div class="real-time-clock" id="topClock">00:00</div>
        </div>
        <div class="control-group">
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="addStaff()">+äººå“¡</button>
                <button class="action-btn action-btn-reset" onclick="resetSchedule()">æ¸…ç©º</button>
            </div>
            <div class="time-settings">
                <span>é–‹</span><input type="number" id="openHour" value="12" onchange="renderScheduleAll()">
                <span>é–‰</span><input type="number" id="closeHour" value="29" onchange="renderScheduleAll()">
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="left-panel" id="leftPanel">
            <div class="left-header-bar">äººå“¡</div>
            <div class="left-content" id="leftContent"></div>
        </div>
        <div class="col-resizer" id="colResizer"></div>
        <div class="right-panel">
            <div class="ruler-container" id="rulerContainer">
                <div id="ruler" style="height:100%; position:relative;"></div>
            </div>
            <div class="tracks-scroll-area" id="rightContent">
                <div class="tracks-wrapper" id="trackContainer">
                    <div class="grid-lines" id="gridBg"></div>
                    <div id="currentTimeLine" class="current-time-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="view-settle" class="view-container">
    <div class="settle-container">
        <div class="middle-section">
            <div class="summary-area">
                <div class="card"><h4>ç¸½ç‡Ÿæ”¶ (å…±æ”¶)</h4><p id="total_revenue" class="text-green">0</p></div>
                <div class="card"><h4>ç¸½é˜¿å§¨å¸³</h4><p id="total_aunt">0</p></div>
                <div class="card" style="min-width:140px;"><h4>ç¶“ç´€è²»ç¸½è¨ˆ</h4><div id="agent_fee_summary" style="font-size:12px; color:#c0392b; font-weight:bold;"></div></div>
                <div class="card"><h4>æœ¬æ—¥ç›ˆé¤˜</h4><p id="total_net_profit" class="text-blue" style="font-size:24px;">0</p></div>
            </div>
        </div>

        <div class="config-section">
            <div class="config-panel">
                <h3>ğŸ’° åº•è–ªåƒæ•¸ (é»æ“Šä¿®æ”¹)</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    <div class="setting-item"><label>40åˆ†/1</label><input type="number" id="base_40_1" value="1100" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>60åˆ†/1</label><input type="number" id="base_60_1" value="1400" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>60åˆ†/2</label><input type="number" id="base_60_2" value="1900" oninput="renderSettlementTable()"></div>
                    <div class="setting-item"><label>120åˆ†/3</label><input type="number" id="base_120_3" value="2800" oninput="renderSettlementTable()"></div>
                    
                    <input type="hidden" id="cost_40_1" value="2300">
                    <input type="hidden" id="cost_60_1" value="2700">
                    <input type="hidden" id="cost_60_2" value="3300">
                    <input type="hidden" id="cost_120_3" value="4800">
                </div>
            </div>
            <div class="config-panel">
                <h3>âœ¨ åŠ å€¼æœå‹™ <button class="btn-circle btn-green" onclick="addServiceRow()" style="width:24px; height:24px;">+</button></h3>
                <div id="service_container" class="service-list"></div>
            </div>
        </div>

        <div id="table_body" style="display:flex; flex-direction:column; gap:15px;"></div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ç·¨è¼¯ç­è¡¨</div>
        <textarea id="modalTextarea" class="modal-textarea" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´ç­è¡¨..."></textarea>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="modal-btn btn-save" onclick="saveModalData()">ç¢ºå®šå„²å­˜</button>
        </div>
    </div>
</div>
<div id="timeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title" id="timeModalTitle">è¨˜éŒ„æœå‹™æ™‚é–“</div>
        <div class="time-input-group">
            <div class="time-item"><div class="time-label">é ç´„æ™‚æ®µï¼š</div><div class="time-display" id="scheduledTime">--:-- - --:--</div></div>
            <div class="time-item"><div class="time-label">å¯¦éš›é€²å ´ (IN)ï¼š</div><input type="text" class="time-display" id="inTimeInput" placeholder="--:--" inputmode="numeric" pattern="\d{2}:\d{2}"><button class="btn-record" onclick="fillCurrentTime('in')">ç¾åœ¨ IN</button></div>
            <div class="time-item"><div class="time-label">å¯¦éš›é›¢å ´ (OUT)ï¼š</div><input type="text" class="time-display" id="outTimeInput" placeholder="--:--" inputmode="numeric" pattern="\d{2}:\d{2}"><button class="btn-record" onclick="fillCurrentTime('out')">ç¾åœ¨ OUT</button></div>
        </div>
        <div class="modal-btns" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <button class="modal-btn" style="background: #e74c3c; color: white;" onclick="clearManualTime()">æ¸…ç©ºæ™‚é–“</button>
            <button class="modal-btn btn-cancel" onclick="closeTimeModal()">é—œé–‰</button>
            <button class="modal-btn btn-save" onclick="saveManualTime()">å„²å­˜</button>
        </div>
    </div>
</div>

<script>
    // === 1. Firebase è¨­å®š ===
    const firebaseConfig = {
        apiKey: "AIzaSyDsUsWuynci0DP71veuu19Ht8bJmhHSkHs", 
        authDomain: "worktools-f53e5.firebaseapp.com",
        databaseURL: "https://worktools-f53e5-default-rtdb.firebaseio.com",
        projectId: "worktools-f53e5",
        storageBucket: "worktools-f53e5.firebasestorage.app",
        messagingSenderId: "950551082090",
        appId: "1:950551082090:web:3c2c4962b5ffa044aec613",
        measurementId: "G-EKPY3SC0BR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === 2. å…¨å±€ç‹€æ…‹ ===
    const PX_PER_MIN = 2;
    let staffData = [];
    let services = [ {name: "nocon", price: 1000}, {name: "å£çˆ†", price: 500} ];
    const WORK_UNIT_TABLE = {40: 1, 60: 1, 120: 2};
    const AUNT_EXTRA_NAMES = ["é¡åŒ", "é˜¿é³´", "æ›¼é”", "æœ‰èœ", "å§šè²´"]; // åŠ ç¢¼ 100 çš„åå–®

    let currentEditingStaffId = null; 
    let currentTaskElement = null; 
    let currentTaskInfo = null;
    const leftContent = document.getElementById('leftContent');
    const rightContent = document.getElementById('rightContent');
    const rulerContainer = document.getElementById('rulerContainer');
    const syncStatus = document.getElementById('syncStatus');

    // === 3. Firebase åŒæ­¥ (CodeSage ä¿®å¾©ç‰ˆ) ===
    function initSchedule() {
        syncStatus.style.background = "orange";
        
        db.ref('shop_v7_data').on('value', (snapshot) => {
            const val = snapshot.val();
            
            // [CodeSage] æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æ­£åœ¨è¼¸å…¥ï¼Œé˜²æ­¢ç„¦é»ä¸Ÿå¤±
            const activeEl = document.activeElement;
            const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA');

            if (val) {
                let rawStaffData = val.staffData || [];
                if (!Array.isArray(rawStaffData) && typeof rawStaffData === 'object') rawStaffData = Object.values(rawStaffData);
                
                staffData = rawStaffData.map(s => ({ ...s, taskStatuses: s.taskStatuses || {} }));
                
                // å¦‚æœæ²’åœ¨æ‰“å­—ï¼Œæ‰æ›´æ–°æ—¥æœŸ
                if(val.date && !isTyping) document.getElementById('dateInput').value = val.date;
                if(val.services) services = val.services;

                // [CodeSage] é—œéµï¼šå¦‚æœæ­£åœ¨æ‰“å­—ï¼Œåªæ›´æ–°æ™‚é–“è»¸ï¼Œä¸é‡ç¹ªå·¦å´æ¸…å–®
                if (!isTyping) {
                    renderScheduleAll();
                } else {
                    console.log("æ­£åœ¨è¼¸å…¥ä¸­ï¼Œç•¥éå…¨é é‡ç¹ª...");
                    requestAnimationFrame(renderTracksOnly);
                }

                if (document.getElementById('view-settle').classList.contains('active') && !isTyping) {
                    renderSettlementTable();
                }
                syncStatus.style.background = "#2ecc71";
            } else { 
                saveScheduleData(); 
            }
        });

        setInterval(updateTimeLineAndClock, 1000);
        if (rightContent && leftContent && rulerContainer) {
            rightContent.addEventListener('scroll', () => { leftContent.scrollTop = rightContent.scrollTop; rulerContainer.scrollLeft = rightContent.scrollLeft; });
        }
    }
    
    function saveScheduleData() {
        syncStatus.style.background = "red";
        const dataToSave = { staffData, date: document.getElementById('dateInput').value, services };
        db.ref('shop_v7_data').set(dataToSave).then(() => { syncStatus.style.background = "#2ecc71"; }).catch(error => { console.error("Firebase Save Error:", error); syncStatus.style.background = "#f1c40f"; });
    }

    // === 4. æ’ç­èˆ‡ UI äº’å‹• ===
    function switchTab(tabId) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId === 'schedule') btns[0].classList.add('active'); else btns[1].classList.add('active');
        if(tabId === 'schedule') setTimeout(() => { renderScheduleAll(); }, 50);
        if(tabId === 'settle') renderSettlementTable();
    }
    function resetSchedule() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { staffData = [{ id: Date.now(), name: "æ–°äººå“¡", content: "", height: null, taskStatuses: {} }]; saveScheduleData(); } }
    function addStaff() { staffData.push({ id: Date.now(), name: "æ–°", content: "", height: null, taskStatuses: {} }); saveScheduleData(); renderScheduleAll(); }
    function removeStaff(id) { if(confirm("åˆªé™¤æ­¤äººï¼Ÿ")) { staffData = staffData.filter(s => s.id !== id); saveScheduleData(); renderScheduleAll(); } }
    function updateStaffName(id, newName) { staffData = staffData.map(staff => staff.id === id ? { ...staff, name: newName } : staff); saveScheduleData(); }
    function openEditModal(staffId) { const staff = staffData.find(s => s.id === staffId); if (!staff) return; currentEditingStaffId = staffId; document.getElementById('modalTextarea').value = staff.content; document.getElementById('editModal').classList.add('active'); document.getElementById('modalTextarea').focus(); }
    function closeEditModal() { document.getElementById('editModal').classList.remove('active'); currentEditingStaffId = null; }
    function saveModalData() { if (!currentEditingStaffId) return; const newContent = document.getElementById('modalTextarea').value; staffData = staffData.map(staff => staff.id === currentEditingStaffId ? { ...staff, content: newContent } : staff); saveScheduleData(); renderScheduleAll(); closeEditModal(); }
    
    // æ‹–æ›³
    const colResizer = document.getElementById('colResizer'); const leftPanel = document.getElementById('leftPanel');
    let isColDragging = false; let colStartX, colStartWidth;
    colResizer.addEventListener('mousedown', (e) => { isColDragging = true; colStartX = e.clientX; colStartWidth = parseInt(window.getComputedStyle(leftPanel).width, 10); document.body.style.cursor = 'col-resize'; });
    document.addEventListener('mousemove', (e) => { if (isColDragging) { e.preventDefault(); leftPanel.style.width = (colStartWidth + (e.clientX - colStartX)) + 'px'; } });
    document.addEventListener('mouseup', () => { isColDragging = false; document.body.style.cursor = 'default'; });

    // === 5. æ’ç­æ¸²æŸ“ ===
    function getTaskHash(rawText, startMinutes) { const safeText = rawText.replace(/[^a-zA-Z0-9]/g, '').substring(0, 15); return `T${startMinutes}_${safeText}`; }
    function renderScheduleAll() { renderSidebar(); requestAnimationFrame(renderTracksOnly); }
    function renderSidebar() { leftContent.innerHTML = ''; staffData.forEach((staff, index) => { const div = document.createElement('div'); div.className = 'staff-card'; div.dataset.staffId = staff.id; if (staff.height) div.style.height = staff.height + 'px'; div.innerHTML = `<div class="staff-header"><div class="idx-badge">${index + 1}</div><input class="staff-name" value="${staff.name}" onchange="updateStaffName(${staff.id}, this.value)"><button class="btn-delete" onclick="removeStaff(${staff.id})">Ã—</button></div><div class="schedule-text-display" onclick="openEditModal(${staff.id})">${staff.content || '<span style="color:#ccc">ç·¨è¼¯...</span>'}</div><div class="row-resizer"></div>`; leftContent.appendChild(div); }); }
    function renderTracksOnly() { const openH = parseInt(document.getElementById('openHour').value) || 12; const closeH = parseInt(document.getElementById('closeHour').value) || 29; const startOfDay = openH * 60; const totalWidth = (closeH * 60 - startOfDay) * PX_PER_MIN; if (totalWidth <= 0) return; document.getElementById('ruler').style.width = totalWidth + 'px'; document.getElementById('trackContainer').style.width = totalWidth + 'px'; document.getElementById('gridBg').style.width = totalWidth + 'px'; const ruler = document.getElementById('ruler'); const gridBg = document.getElementById('gridBg'); ruler.innerHTML = ''; const gridBgContent = []; for (let h = openH; h <= closeH; h++) { let left = (h * 60 - startOfDay) * PX_PER_MIN; let displayH = h >= 24 ? h - 24 : h; ruler.innerHTML += `<div class="hour-mark" style="left:${left}px;">${displayH}</div>`; gridBgContent.push(`<div class="v-line" style="left:${left}px;"></div>`); } gridBg.innerHTML = gridBgContent.join(''); const container = document.getElementById('trackContainer'); container.innerHTML = `<div class="grid-lines" id="gridBg" style="width: ${totalWidth}px;">${gridBg.innerHTML}</div><div id="currentTimeLine" class="current-time-line"></div>`; staffData.forEach(staff => { const trackDiv = document.createElement('div'); trackDiv.className = 'track-row'; trackDiv.id = `track-${staff.id}`; container.appendChild(trackDiv); const staffCard = document.querySelector(`.staff-card[data-staff-id="${staff.id}"]`); if (staff.height) { trackDiv.style.height = staff.height + 'px'; } else if (staffCard) { trackDiv.style.height = staffCard.offsetHeight + 'px'; } renderSingleTrack(trackDiv, staff.content, staff.id, startOfDay, closeH * 60); }); updateTimeLineAndClock(); }
    function renderSingleTrack(container, content, staffId, startOfDay, endOfDay) { container.innerHTML = ''; const staff = staffData.find(s => s.id === staffId); const taskStatuses = staff.taskStatuses || {}; const lines = content.trim().split('\n'); const tasks = []; lines.forEach(line => { const trimmedLine = line.trim(); if (!trimmedLine) return; if (/^[\d./-]+\s*(?:\([A-Za-z]+\))?$/.test(trimmedLine) && trimmedLine.length < 12) return; const match = trimmedLine.match(/([\d.:]+)\s*(\d+.*)/) || trimmedLine.match(/(\D+)\s*([\d.:]+)\s*(\d+.*)/); if (match) { let timeStr, detailStr; if (match.length === 3) { timeStr = match[1]; detailStr = match[2]; } else { timeStr = match[2]; detailStr = match[3]; } let duration = 60; const numMatch = detailStr.match(/^(\d+)/); if (numMatch) duration = parseInt(numMatch[1]); const startTime = parseTime(timeStr); const endTime = startTime + duration; if (startTime !== null) { const scheduledStart = formatTime(startTime); const scheduledEnd = formatTime(endTime); const taskId = getTaskHash(trimmedLine, startTime); const status = taskStatuses[taskId] || {}; tasks.push({ start: startTime, end: endTime, rawText: trimmedLine, conflict: false, staffId, taskId, scheduledStart, scheduledEnd, inTime: status.inTime || '', outTime: status.outTime || '' }); } } }); tasks.sort((a, b) => a.start - b.start); for (let i = 0; i < tasks.length; i++) { for (let j = i + 1; j < tasks.length; j++) { if (tasks[i].end > tasks[j].start) { tasks[i].conflict = true; tasks[j].conflict = true; } else { break; } } } let currentCursor = startOfDay; tasks.forEach(task => { if (task.start > currentCursor) { let gap = task.start - currentCursor; if (gap >= 10) { let startStr = formatTime(currentCursor); let endStr = formatTime(task.start); let durationStr = formatDuration(gap); let label = `<b>${durationStr}</b><div style="font-size:10px; margin-top:1px;">${startStr}-${endStr}</div>`; createBlock(container, currentCursor, task.start, startOfDay, 'free', label); } } let type = task.conflict ? 'conflict' : 'work'; createBlock(container, task.start, task.end, startOfDay, type, task.rawText, task.staffId, task.taskId, task.scheduledStart, task.scheduledEnd, task.inTime, task.outTime); if (task.end > currentCursor) currentCursor = task.end; }); }
    function parseTime(timeStr) { if (!timeStr) return null; timeStr = timeStr.replace('.', ':'); let parts = timeStr.split(':'); let h = 0, m = 0; if (parts.length === 2) { h = parseInt(parts[0]); m = parseInt(parts[1]); } else if (timeStr.length === 4) { h = parseInt(timeStr.substring(0, 2)); m = parseInt(timeStr.substring(2, 4)); } else { h = parseInt(timeStr); } if (isNaN(h)) return null; if (h < 11) h += 24; return h * 60 + m; }
    function formatTime(minutes) { let h = Math.floor(minutes / 60); let m = minutes % 60; return (h < 10 ? "0"+h : h) + ":" + (m < 10 ? "0"+m : m); }
    function formatDuration(mins) { let h = Math.floor(mins / 60); let m = mins % 60; return (h > 0 ? h + "h" : "") + (m > 0 ? m + "m" : ""); }
    function createBlock(container, start, end, offsetStart, type, content, staffId, taskId, scheduledStart, scheduledEnd, inTime, outTime) { if (end <= start) return; const left = (start - offsetStart) * PX_PER_MIN; const width = (end - start) * PX_PER_MIN; const div = document.createElement('div'); div.className = `block type-${type}`; div.style.left = left + 'px'; div.style.width = Math.max(width - 2, 2) + 'px'; if (type === 'free') { div.innerHTML = content; } else { div.innerText = content; if (type === 'work') { div.onclick = function(e) { e.stopPropagation(); openTimeModal(div, staffId, taskId, content, scheduledStart, scheduledEnd); }; div.dataset.staffId = staffId; div.dataset.taskId = taskId; if(inTime) div.dataset.inTime = inTime; if(outTime) div.dataset.outTime = outTime; } } container.appendChild(div); }
    function updateTimeLineAndClock() { const line = document.getElementById('currentTimeLine'); const topClock = document.getElementById('topClock'); const openH = parseInt(document.getElementById('openHour').value) || 12; const now = new Date(); let h = now.getHours(); let m = now.getMinutes(); let clockH = now.getHours(); if (clockH >= 0 && clockH < 11) clockH += 24; if(topClock) topClock.innerText = `${(clockH<10?"0"+clockH:clockH)}:${(m<10?"0"+m:m)}`; if (h < 11) h += 24; const offsetMins = (h * 60 + m) - openH * 60; if (offsetMins >= 0 && line) { line.style.display = 'block'; line.style.left = (offsetMins * PX_PER_MIN) + 'px'; } else if (line) { line.style.display = 'none'; } }
    
    // Modal Functions
    function openTimeModal(element, staffId, taskId, content, scheduledStart, scheduledEnd) { currentTaskElement = element; currentTaskInfo = { staffId, taskId }; document.getElementById('timeModalTitle').innerText = `è¨˜éŒ„æœå‹™æ™‚é–“: ${content.substring(0, 20)}...`; document.getElementById('scheduledTime').innerText = `${scheduledStart} - ${scheduledEnd}`; document.getElementById('inTimeInput').value = currentTaskElement.dataset.inTime || ''; document.getElementById('outTimeInput').value = currentTaskElement.dataset.outTime || ''; document.getElementById('timeModal').classList.add('active'); }
    function closeTimeModal() { document.getElementById('timeModal').classList.remove('active'); currentTaskElement = null; currentTaskInfo = null; }
    function fillCurrentTime(type) { const now = new Date(); let h = now.getHours(); if (h >= 0 && h < 11) h += 24; let m = now.getMinutes(); const t = `${h < 10 ? "0"+h : h}:${m < 10 ? "0"+m : m}`; document.getElementById(type === 'in' ? 'inTimeInput' : 'outTimeInput').value = t; }
    function saveManualTime() { if (!currentTaskElement || !currentTaskInfo) return; const { staffId, taskId } = currentTaskInfo; const newInTime = document.getElementById('inTimeInput').value.trim(); const newOutTime = document.getElementById('outTimeInput').value.trim(); const timeRegex = /^\d{2}:\d{2}$/; if ((newInTime && !timeRegex.test(newInTime)) || (newOutTime && !timeRegex.test(newOutTime))) { alert("æ ¼å¼éŒ¯èª¤ HH:MM"); return; } staffData = staffData.map(staff => { if (staff.id === staffId) { const updatedTaskStatus = {}; if (newInTime) updatedTaskStatus.inTime = newInTime; if (newOutTime) updatedTaskStatus.outTime = newOutTime; return { ...staff, taskStatuses: { ...(staff.taskStatuses || {}), [taskId]: updatedTaskStatus } }; } return staff; }); saveScheduleData(); if (newInTime) currentTaskElement.dataset.inTime = newInTime; else delete currentTaskElement.dataset.inTime; if (newOutTime) currentTaskElement.dataset.outTime = newOutTime; else delete currentTaskElement.dataset.outTime; closeTimeModal(); }
    function clearManualTime() { if (!currentTaskElement || !currentTaskInfo) return; const { staffId, taskId } = currentTaskInfo; staffData = staffData.map(staff => { if (staff.id === staffId) { const updatedTaskStatuses = { ...(staff.taskStatuses || {}) }; delete updatedTaskStatuses[taskId]; return { ...staff, taskStatuses: updatedTaskStatuses }; } return staff; }); saveScheduleData(); delete currentTaskElement.dataset.inTime; delete currentTaskElement.dataset.outTime; document.getElementById('inTimeInput').value = ''; document.getElementById('outTimeInput').value = ''; closeTimeModal(); }

    // === 6. æ—¥çµæ ¸å¿ƒ (å…¬å¼ä¿®æ­£ + å³æ™‚ç·¨è¼¯ + å·¥æ•¸å…¥è¡¨) ===
    function renderServices() { const container = document.getElementById('service_container'); container.innerHTML = ''; services.forEach((svc, index) => { const div = document.createElement('div'); div.className = 'service-row'; div.innerHTML = `<input type="text" value="${svc.name}" onchange="updateService(${index}, 'name', this.value)"><span>+</span><input type="number" value="${svc.price}" oninput="updateService(${index}, 'price', this.value)" step="100"><button class="btn-circle btn-red" style="width:18px; height:18px; font-size:12px;" onclick="removeService(${index})">Ã—</button>`; container.appendChild(div); }); }
    function updateService(index, field, value) { let finalValue = value; if(field === 'price') { const parsed = parseInt(value); finalValue = isNaN(parsed) ? services[index].price : parsed; if (value === "") finalValue = 0; } services = services.map((svc, i) => i === index ? { ...svc, [field]: finalValue } : svc); renderServices(); renderSettlementTable(); saveScheduleData(); }
    function addServiceRow() { services.push({name: "æ–°æœå‹™", price: 0}); renderServices(); renderSettlementTable(); saveScheduleData(); }
    function removeService(index) { services = services.filter((_, i) => i !== index); renderServices(); renderSettlementTable(); saveScheduleData(); }

    function updateStaffSettlement(staffId, field, value) {
        staffData = staffData.map(s => {
            if (s.id === staffId) {
                let val = value;
                if (field === 'agentRate' || field === 'manualExpense') { val = parseInt(value) || 0; }
                return { ...s, [field]: val };
            }
            return s;
        });
        saveScheduleData();
        renderSettlementTable();
    }

    function calculateSettlement(staff, commTable, costTable, services) {
        const results = [];
        let totalWorks = 0; 
        if (!staff.content.trim()) return { results, totalWorks };
        const lines = staff.content.split('\n');
        lines.forEach(line => {
            const rawLine = line.trim();
            if (!rawLine) return;
            const pattern = /(\d+)\/(\d+)-(\d+)/;
            const match = rawLine.match(pattern);
            let extra_money = 0, base_comm = 0, revenue = 0, base_cost = 0, work = 0;
            let total_miss = 0, aunt_inc = 0, aunt_disp = 0, balance = 0;
            let isManual = false;

            if (match) {
                const duration = parseInt(match[1]), rev = parseInt(match[2]), count = parseInt(match[3]);
                const key = `${duration}-${count}`;
                revenue = rev; // æ”¶
                base_comm = commTable[key] || 0;
                base_cost = costTable[key] || 0; 
                work = WORK_UNIT_TABLE[duration] || 0; 
                totalWorks += work; 

                services.forEach(svc => { if (rawLine.toLowerCase().includes(svc.name.toLowerCase())) extra_money += svc.price; });
                
                total_miss = base_comm + extra_money; // å°å§å¯¦æ‹¿
                
                // é˜¿å§¨è¤‡é›œå…¬å¼
                aunt_inc = revenue - base_cost - extra_money;
                
                let realName = staff.name;
                const nameMatch = rawLine.match(/^([^\d\s]+)/);
                if (nameMatch && !nameMatch[1].includes(':')) realName = nameMatch[1];
                if (AUNT_EXTRA_NAMES.includes(realName)) aunt_inc += 100;

                aunt_disp = Math.floor(aunt_inc / 100);

                // çµé¤˜ = æ”¶ - å°å§
                balance = revenue - total_miss;

            } else { 
                isManual = true; 
                revenue = 0; total_miss = 0; aunt_disp = 0; balance = 0; work = 0;
            }
            results.push({ rawLine, isManual, revenue, total_miss, aunt_disp, balance, work });
        });
        return { results, totalWorks };
    }

    // è™•ç†è¡¨æ ¼å…§ç·¨è¼¯ (æ›´æ–° DOM è¨ˆç®—)
    function onCellEdit(cell) {
        updateTotalsFromDOM();
    }

    // å¾ DOM é‡æ–°è¨ˆç®—ç¸½å’Œ
    function updateTotalsFromDOM() {
        let dom_grand_total_revenue = 0; 
        let dom_grand_total_aunt_points = 0; 
        let dom_agent_fee_map = {};

        document.querySelectorAll('.staff-card-settle').forEach(card => {
            let card_total_aunt_pts = 0; 
            let card_total_rev = 0;
            let card_total_miss = 0;
            let card_total_bal = 0; 
            let card_total_work = 0; // æ–°å¢å·¥æ•¸çµ±è¨ˆ
            
            // éæ­·è©²å¡ç‰‡æ‰€æœ‰è³‡æ–™è¡Œ
            card.querySelectorAll('tbody tr:not([style*="background"])').forEach(row => {
                const getVal = (cls) => parseInt(row.querySelector(cls)?.innerText.replace(/[^\d-]/g,'') || 0);
                
                const r_rev = getVal('.col-rev');
                const r_miss = getVal('.col-miss');
                const r_aunt = getVal('.col-aunt');
                const r_work = getVal('.col-work'); // è®€å–å·¥æ•¸
                
                // å‹•æ…‹æ›´æ–°è©²è¡Œçš„çµé¤˜é¡¯ç¤º (æ”¶ - å°å§)
                const r_bal = r_rev - r_miss;
                const balCell = row.querySelector('.col-bal');
                if(balCell) balCell.innerText = r_bal; 

                card_total_rev += r_rev;
                card_total_miss += r_miss;
                card_total_aunt_pts += r_aunt;
                card_total_bal += r_bal;
                card_total_work += r_work;
            });

            // æŠ“å–æ‰‹å‹•é£¯éŒ¢
            const expenseInput = card.querySelector('.input-expense');
            const manualExpense = parseInt(expenseInput?.value || 0);
            
            // æ›´æ–°å¡ç‰‡åº•éƒ¨ç¸½è¨ˆ
            const footerCells = card.querySelectorAll('.footer-total td');
            if(footerCells.length > 0) {
                footerCells[1].innerText = card_total_aunt_pts; 
                footerCells[2].innerText = card_total_rev;
                footerCells[3].innerText = card_total_miss;
                footerCells[4].innerText = card_total_bal; 
                footerCells[5].innerText = card_total_work; // æ›´æ–°å·¥æ•¸ç¸½è¨ˆ
            }

            // ä¿®æ­£å¾Œçµé¤˜
            const final_bal = card_total_bal + manualExpense;
            const finalBalCell = card.querySelector('.final-balance');
            if(finalBalCell) finalBalCell.innerText = final_bal;

            // ç´¯åŠ åˆ°å…¨å±€
            dom_grand_total_revenue += final_bal;
            dom_grand_total_aunt_points += card_total_aunt_pts;

            // ç¶“ç´€è²»è¨ˆç®— (ç¾åœ¨ä½¿ç”¨ DOM çµ±è¨ˆå‡ºä¾†çš„å·¥æ•¸ï¼Œå¯¦ç¾é€£å‹•)
            const agentName = card.dataset.agentName;
            const agentRate = parseInt(card.dataset.agentRate || 300);
            // const totalWorks = parseInt(card.dataset.totalWorks || 0); // èˆŠé‚è¼¯ (éœæ…‹)
            const staffAgentFee = card_total_work * agentRate; // æ–°é‚è¼¯ (å‹•æ…‹)

            // æ›´æ–°ä»‹é¢ä¸Šé¡¯ç¤ºçš„è²»ç”¨
            const feeDisplay = card.querySelector('.agent-fee-display');
            if(feeDisplay) feeDisplay.innerText = `è²»ç”¨: $${staffAgentFee}`;

            if (agentName) {
                if (!dom_agent_fee_map[agentName]) dom_agent_fee_map[agentName] = 0;
                dom_agent_fee_map[agentName] += staffAgentFee;
            }
        });

        const grand_total_aunt_money = dom_grand_total_aunt_points * 100;

        let grand_total_agent_fees = 0;
        let agent_summary_html = "";
        for (const [name, fee] of Object.entries(dom_agent_fee_map)) {
            grand_total_agent_fees += fee;
            agent_summary_html += `<div>${name}: $${fee}</div>`;
        }

        const net_profit = dom_grand_total_revenue - grand_total_aunt_money - grand_total_agent_fees;

        document.getElementById('total_revenue').innerText = dom_grand_total_revenue.toLocaleString();
        document.getElementById('total_aunt').innerText = grand_total_aunt_money.toLocaleString(); 
        document.getElementById('agent_fee_summary').innerHTML = agent_summary_html || "ç„¡";
        document.getElementById('total_net_profit').innerText = net_profit.toLocaleString();
    }

    function renderSettlementTable() {
        const commTable = { "40-1": parseInt(document.getElementById('base_40_1').value)||0, "60-1": parseInt(document.getElementById('base_60_1').value)||0, "60-2": parseInt(document.getElementById('base_60_2').value)||0, "120-3": parseInt(document.getElementById('base_120_3').value)||0 };
        const costTable = { "40-1": parseInt(document.getElementById('cost_40_1').value)||0, "60-1": parseInt(document.getElementById('cost_60_1').value)||0, "60-2": parseInt(document.getElementById('cost_60_2').value)||0, "120-3": parseInt(document.getElementById('cost_120_3').value)||0 };
        
        const container = document.getElementById('table_body');
        container.innerHTML = ''; 

        staffData.forEach((staff) => {
            if (!staff.content.trim()) return; 

            const { results, totalWorks } = calculateSettlement(staff, commTable, costTable, services);
            const agentName = staff.agentName || ''; 
            const agentRate = staff.agentRate !== undefined ? staff.agentRate : 300; 
            const manualExpense = staff.manualExpense !== undefined ? staff.manualExpense : 0; 
            const staffAgentFee = totalWorks * agentRate;

            const card = document.createElement('div');
            card.className = 'staff-card-settle';
            card.dataset.agentName = agentName;
            card.dataset.agentRate = agentRate;
            card.dataset.totalWorks = totalWorks; // åˆå§‹å€¼ï¼Œå¾ŒçºŒç”± DOM æ›´æ–°è¦†è“‹
            
            card.style.background = '#fff'; card.style.borderRadius = '8px'; card.style.border = '1px solid #ccc'; card.style.overflow = 'hidden'; card.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';

            let headerHtml = `
                <div style="background:#f1c40f; padding:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:16px; font-weight:bold; color:#e74c3c; display:flex; align-items:center; gap:5px;">
                        ${staff.name} 
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="text" placeholder="ç¶“ç´€" value="${agentName}" onchange="updateStaffSettlement(${staff.id}, 'agentName', this.value)" 
                            style="width:50px; text-align:center; border:1px solid #aaa; border-radius:4px; font-weight:bold; color:#c0392b;">
                        <div style="display:flex; flex-direction:column; align-items:flex-end; font-size:10px; color:#2c3e50; line-height:1.1;">
                            <div>è²»ç‡: <input type="number" value="${agentRate}" onchange="updateStaffSettlement(${staff.id}, 'agentRate', this.value)" style="width:40px; border:none; background:transparent; border-bottom:1px solid #aaa; text-align:right;"></div>
                            <div class="agent-fee-display" style="font-weight:bold; color:#d35400;">è²»ç”¨: $${staffAgentFee}</div>
                        </div>
                    </div>
                </div>
                <table style="width:100%; font-size:13px; border-collapse:collapse;">
                    <thead style="background:#ecf0f1; border-bottom:1px solid #ccc; color:#555;">
                        <tr>
                            <th style="padding:5px; text-align:left;">å…§å®¹</th>
                            <th>é˜¿å§¨ (é»)</th>
                            <th>æ”¶</th>
                            <th>å°å§</th>
                            <th>çµé¤˜</th>
                            <th>å·¥æ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // [CodeSage] ä¿®å¾©ï¼šå°‡è‡ªå‹•è¨ˆç®—çš„æ¬„ä½è¨­ç‚ºå”¯è®€ï¼Œä¸¦åŠ ä¸ŠèƒŒæ™¯è‰²å€åˆ†
            results.forEach(row => {
                headerHtml += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:5px; color:${row.isManual ? '#e74c3c' : '#333'};">${row.rawLine}</td>
                        <td class="col-aunt" style="text-align:center; font-weight:bold; color:#2980b9; background:#f9f9f9;">${row.aunt_disp}</td>
                        <td class="col-rev" style="text-align:center; color:#27ae60; background:#f9f9f9;">${row.revenue}</td>
                        <td class="col-miss" style="text-align:center; color:#c0392b; background:#f9f9f9;">${row.total_miss}</td>
                        <td class="col-bal" style="text-align:center; color:#555;">${row.balance}</td>
                        <td class="col-work" style="text-align:center; color:#d35400; font-weight:bold; background:#f9f9f9;">${row.work}</td>
                    </tr>
                `;
            });

            headerHtml += `
                    <tr class="footer-total" style="background:#fffcf5; border-top:2px solid #ddd;">
                        <td style="text-align:right; font-weight:bold; padding:5px;">ç¸½è¨ˆ:</td>
                        <td style="text-align:center;">0</td> 
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">0</td>
                        <td style="text-align:center;">-</td>
                        <td style="text-align:center; color:#d35400; font-weight:bold;">0</td>
                    </tr>
                    <tr style="background:#ffe6e6;">
                        <td colspan="5" style="text-align:right; font-size:12px; font-weight:bold; color:#c0392b; padding:5px;">é›œæ”¯/é£¯éŒ¢:</td>
                        <td style="text-align:center;">
                            <input class="input-expense" type="number" value="${manualExpense}" onchange="updateStaffSettlement(${staff.id}, 'manualExpense', this.value)" 
                            style="width:50px; text-align:center; color:red; font-weight:bold; background:transparent; border:none; border-bottom:1px dashed red;">
                        </td>
                    </tr>
                    <tr style="background:#2c3e50; color:white; font-weight:bold;">
                        <td colspan="5" style="text-align:right; padding:5px; font-size:12px;">ä¿®æ­£å¾Œçµé¤˜:</td>
                        <td class="final-balance" style="text-align:center; font-size:14px; color:#f1c40f;">0</td>
                    </tr>
                </tbody></table>
            `;
            card.innerHTML = headerHtml;
            container.appendChild(card);
        });

        updateTotalsFromDOM();
    }

    initSchedule(); renderServices();
</script>
</body>
</html>